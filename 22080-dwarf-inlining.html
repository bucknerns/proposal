

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Proposal: emit DWARF inlining info in the Go compiler &mdash; Go Design Proposal  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Proposal: Versioned Go Modules" href="24301-versioned-go.html" />
    <link rel="prev" title="Proposal: XML Stream" href="19480-xml-stream.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Go Design Proposal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="11502-securitypolicy.html">Proposal: Security Policy for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="11970-decentralized-gc.html">Proposal: Decentralized GC coordination</a></li>
<li class="toctree-l1"><a class="reference internal" href="12166-subtests.html">Proposal: testing: programmatic sub-test and sub-benchmark support</a></li>
<li class="toctree-l1"><a class="reference internal" href="12302-release-proposal.html">Proposal: A minimal release process for Go repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="12416-cgo-pointers.html">Proposal: Rules for passing pointers between Go and C</a></li>
<li class="toctree-l1"><a class="reference internal" href="12750-localization.html">Proposal: Localization support in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12800-sweep-free-alloc.html">Proposal: Dense mark bits and sweep-free allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html">Proposal: Monotonic Elapsed Time Measurements in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html#appendix-time-now-usage">Appendix: time.Now usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="13073-code-of-conduct.html">Proposal: A Code of Conduct for the Go community</a></li>
<li class="toctree-l1"><a class="reference internal" href="13432-mobile-audio.html">Proposal: Audio for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="13504-natural-xml.html">Proposal: Natural XML</a></li>
<li class="toctree-l1"><a class="reference internal" href="14313-benchmark-format.html">Proposal: Go Benchmark Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="14386-zip-package-archives.html">Proposal: Zip-based Go package archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="14951-soft-heap-limit.html">Proposal: Separate soft and hard heap size goal</a></li>
<li class="toctree-l1"><a class="reference internal" href="15292-generics.html">Proposal: Go should have generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="16085-conversions-ignore-tags.html">Proposal: Ignore tags in struct type conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html">Proposal: Alias declarations for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html#appendix">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="16410-heap-viewer.html">Proposal: Go Heap Dump Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="16704-cidr-notation-no-proxy.html">Proposal: Add support for CIDR notation in no_proxy variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="17280-profile-labels.html">Proposal: Support for pprof profiler labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="17503-eliminate-rescan.html">Proposal: Eliminate STW stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="17505-concurrent-rescan.html">Proposal: Concurrent stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="18130-type-alias.html">Proposal: Type Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html">Proposal: percpu.Sharded, an API for reducing cache contention</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#discussion">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#backwards-compatibility">Backwards compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19113-signed-shift-counts.html">Proposal: Permit Signed Integers as Shift Counts for Go 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="19308-number-literals.html">Proposal: Go 2 Number Literal Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html">Proposal: Mid-stack inlining in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#proposal">Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#rationale">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="19480-xml-stream.html">Proposal: XML Stream</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Proposal: emit DWARF inlining info in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="#background">Background</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#source-position-tracking">Source position tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lexical-scopes">Lexical scopes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enhanced-variable-location-tracking">Enhanced variable location tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compressed-source-positions-updates-during-inlining">Compressed source positions, updates during inlining</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overall-existing-framework-for-debug-generation">Overall existing framework for debug generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mechanisms-provided-by-the-dwarf-standard-for-representing-inlining-info">Mechanisms provided by the DWARF standard for representing inlining info</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="#how-the-generated-dwarf-should-look">How the generated DWARF should look</a></li>
<li class="toctree-l1"><a class="reference internal" href="#outline-of-proposed-changes">Outline of proposed changes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#changes-to-the-inliner">Changes to the inliner</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changes-to-debug-generation">Changes to debug generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#changes-to-the-linker">Changes to the linker</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="24301-versioned-go.html">Proposal: Versioned Go Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="24543-non-cooperative-preemption.html">Proposal: Non-cooperative goroutine preemption</a></li>
<li class="toctree-l1"><a class="reference internal" href="25530-sumdb.html">Proposal: Secure the Public Go Module Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="25719-go15vendor.html">Go 1.5 Vendor Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="26160-dns-based-vanity-imports.html">Proposal: DNS Based Vanity Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="26756-rawxml-token.html">Proposal: Raw XML Token</a></li>
<li class="toctree-l1"><a class="reference internal" href="26903-simplify-mark-termination.html">Proposal: Simplify mark termination and eliminate mark 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="27539-internal-abi.html">Proposal: Create an undefined internal calling convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="2775-binary-only-packages.html">Proposal: Binary-Only Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="27935-unbounded-queue-package.html">Proposal: Built in support for high performance unbounded queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="28221-go2-transitions.html">Proposal: Go 2 transition</a></li>
<li class="toctree-l1"><a class="reference internal" href="2981-go-test-json.html">Proposal: <code class="docutils literal notranslate"><span class="pre">-json</span></code> flag in <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="29934-error-values.html">Proposal: Go 2 Error Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="30333-smarter-scavenging.html">Proposal: Smarter Scavenging</a></li>
<li class="toctree-l1"><a class="reference internal" href="30411-env.html">Proposal: <code class="docutils literal notranslate"><span class="pre">go</span></code> command configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="32437-try-builtin.html">Proposal: A built-in Go error check function, <code class="docutils literal notranslate"><span class="pre">try</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="33974-add-public-lockedfile-pkg.html">Proposal: make the internal lockedfile package public</a></li>
<li class="toctree-l1"><a class="reference internal" href="34481-opencoded-defers.html">Proposal: Low-cost defers through inline code, and extra funcdata to manage the panic case</a></li>
<li class="toctree-l1"><a class="reference internal" href="35112-scaling-the-page-allocator.html">Proposal: Scaling the Go page allocator</a></li>
<li class="toctree-l1"><a class="reference internal" href="36460-lazy-module-loading.html">Proposal: Lazy Module Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="36606-64-bit-field-alignment.html">Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="37112-unstable-runtime-metrics.html">Proposal: API for unstable runtime metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="37720-gopls-workspaces.html">Proposal: Multi-project gopls workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="4899-testing-helper.html">Proposal: testing: better support test helper functions with TB.Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="6282-table-data.html">Proposal: Multi-dimensional slices</a></li>
<li class="toctree-l1"><a class="reference internal" href="6977-overlapping-interfaces.html">Proposal: Permit embedding of interfaces with overlapping method sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="TEMPLATE.html">Proposal: [Title]</a></li>
<li class="toctree-l1"><a class="reference internal" href="cryptography-principles.html">Cryptography Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft.html">Go 2 Draft Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-contracts.html">Contracts — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling.html">Error Handling — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling-overview.html">Error Handling — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-inspection.html">Error Inspection — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-printing.html">Error Printing — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-values-overview.html">Error Values — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-generics-overview.html">Generics — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-type-parameters.html">Type Parameters - Draft Design</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Go Design Proposal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Proposal: emit DWARF inlining info in the Go compiler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/22080-dwarf-inlining.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="proposal-emit-dwarf-inlining-info-in-the-go-compiler">
<h1>Proposal: emit DWARF inlining info in the Go compiler<a class="headerlink" href="#proposal-emit-dwarf-inlining-info-in-the-go-compiler" title="Permalink to this headline">¶</a></h1>
<p>Author(s): Than McIntosh</p>
<p>Last updated: 2017-10-23</p>
<p>Discussion at: https://golang.org/issue/22080</p>
</div>
<div class="section" id="abstract">
<h1>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h1>
<p>In Go 1.9, the inliner was enhanced to support mid-stack inlining, including
tracking of inlines in the PC-value table to enable accurate tracebacks (see
<a class="reference external" href="https://golang.org/issue/19348">proposal</a>).
The mid-stack inlining proposal included plans to enhance DWARF generation to
emit inlining records, however the DWARF support has yet to be implemented.
This document outlines a proposal for completing this work.</p>
</div>
<div class="section" id="background">
<h1>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h1>
<p>This section discusses previous work done on the compiler related to inlining
and related to debug info generation, and outlines the what we want to see in
terms of generated DWARF.</p>
<div class="section" id="source-position-tracking">
<h2>Source position tracking<a class="headerlink" href="#source-position-tracking" title="Permalink to this headline">¶</a></h2>
<p>As part of the mid-stack inlining work, the Go compiler’s source position
tracking was enhanced, giving it the ability to capture the inlined call stack
for an instruction created during an inlining operation.
This additional source position information is then used to create an
inline-aware PC-value table (readable by the runtime) to provide accurate
tracebacks, but is not yet being used to emit DWARF inlining records.</p>
</div>
<div class="section" id="lexical-scopes">
<h2>Lexical scopes<a class="headerlink" href="#lexical-scopes" title="Permalink to this headline">¶</a></h2>
<p>The Go compiler also incorporates support for emitting DWARF lexical scope
records, so as to provide information to the debugger on which instance of a
given variable name is in scope at a given program point.
This feature is currently only operational when the user is compiling with “-l
-N” passed via -gcflags; these options disable inlining and turn off most
optimizations.
The scoping implementation currently relies on disabling the inliner; to enable
scope generation in combination with inlining would require a separate effort.</p>
</div>
<div class="section" id="enhanced-variable-location-tracking">
<h2>Enhanced variable location tracking<a class="headerlink" href="#enhanced-variable-location-tracking" title="Permalink to this headline">¶</a></h2>
<p>There is also work being done to enable more accurate DWARF location lists for
function parameters and local variables.
This better value tracking is currently checked in but not enabled by default,
however the hope is to make this the default behavior for all compilations.</p>
</div>
<div class="section" id="compressed-source-positions-updates-during-inlining">
<h2>Compressed source positions, updates during inlining<a class="headerlink" href="#compressed-source-positions-updates-during-inlining" title="Permalink to this headline">¶</a></h2>
<p>The compiler currently uses a compressed representation for source position
information.
AST nodes and SSA names incorporate a compact
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/src/xpos.go#L11"><code class="docutils literal notranslate"><span class="pre">src.XPos</span></code></a>
object of the form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">XPos</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">index</span> <span class="n">int32</span>    <span class="o">//</span> <span class="n">index</span> <span class="n">into</span> <span class="n">table</span> <span class="n">of</span> <span class="n">PosBase</span> <span class="n">objects</span>
	<span class="n">lico</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/src/pos.go#L130"><code class="docutils literal notranslate"><span class="pre">src.PosBase</span></code></a>
contains source file info and a line base:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">PosBase</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">pos</span>         <span class="n">Pos</span>
	<span class="n">filename</span>    <span class="n">string</span> <span class="o">//</span> <span class="n">file</span> <span class="n">name</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">source</span> <span class="n">file</span><span class="p">,</span> <span class="k">for</span> <span class="n">error</span> <span class="n">messages</span>
	<span class="n">absFilename</span> <span class="n">string</span> <span class="o">//</span> <span class="n">absolute</span> <span class="n">file</span> <span class="n">name</span><span class="p">,</span> <span class="k">for</span> <span class="n">PC</span><span class="o">-</span><span class="n">Line</span> <span class="n">tables</span>
	<span class="n">symFilename</span> <span class="n">string</span> <span class="o">//</span> <span class="n">cached</span> <span class="n">symbol</span> <span class="n">file</span> <span class="n">name</span>
	<span class="n">line</span>        <span class="n">uint</span>   <span class="o">//</span> <span class="n">relative</span> <span class="n">line</span> <span class="n">number</span> <span class="n">at</span> <span class="n">pos</span>
	<span class="n">inl</span>         <span class="nb">int</span>    <span class="o">//</span> <span class="n">inlining</span> <span class="n">index</span> <span class="p">(</span><span class="n">see</span> <span class="n">cmd</span><span class="o">/</span><span class="n">internal</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="n">inl</span><span class="o">.</span><span class="n">go</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the struct above, <code class="docutils literal notranslate"><span class="pre">inl</span></code> is an index into the global inlining
tree (maintained as a global slice of
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/obj/inl.go#L46"><code class="docutils literal notranslate"><span class="pre">obj.InlinedCall</span></code></a>
objects):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">InlinedCall</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">InlTree</span><span class="o">.</span>
<span class="nb">type</span> <span class="n">InlinedCall</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">Parent</span> <span class="nb">int</span>      <span class="o">//</span> <span class="n">index</span> <span class="n">of</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">InlTree</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">outermost</span> <span class="n">call</span>
	<span class="n">Pos</span>    <span class="n">src</span><span class="o">.</span><span class="n">XPos</span> <span class="o">//</span> <span class="n">position</span> <span class="n">of</span> <span class="n">the</span> <span class="n">inlined</span> <span class="n">call</span>
	<span class="n">Func</span>   <span class="o">*</span><span class="n">LSym</span>    <span class="o">//</span> <span class="n">function</span> <span class="n">that</span> <span class="n">was</span> <span class="n">inlined</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the inliner replaces a call with the body of an inlinable procedure, it
creates a new <code class="docutils literal notranslate"><span class="pre">inl.InlinedCall</span></code> object based on the call, then a new
<code class="docutils literal notranslate"><span class="pre">src.PosBase</span></code> referring to the InlinedCall’s index in the global tree.
It then rewrites/updates the src.XPos objects in the inlined blob to refer to
the new <code class="docutils literal notranslate"><span class="pre">src.PosBase</span></code> (this process is described in more detail in the
<a class="reference external" href="https://golang.org/design/19348-midstack-inlining">mid-stack inlining design
document</a>).</p>
</div>
<div class="section" id="overall-existing-framework-for-debug-generation">
<h2>Overall existing framework for debug generation<a class="headerlink" href="#overall-existing-framework-for-debug-generation" title="Permalink to this headline">¶</a></h2>
<p>DWARF generation is split between the Go compiler and Go linker; the top-level
driver routine for debug generation is
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/obj/objfile.go#L485"><code class="docutils literal notranslate"><span class="pre">obj.populateDWARF</span></code></a>.
This routine makes a call back into
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/compile/internal/gc/pgen.go#L304"><code class="docutils literal notranslate"><span class="pre">gc.debuginfo</span></code></a>
(via context pointer), which collects information on variables and scopes for a
function, then invokes
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/dwarf/dwarf.go#L687"><code class="docutils literal notranslate"><span class="pre">dwarf.PutFunc</span></code></a>
to create what amounts to an abstract version of the DWARF DIE chain for the
function itself and its children (formals, variables, scopes).</p>
<p>The linker starts with the skeleton DIE tree emitted by the compiler, then uses
it as a guide to emit the actual DWARF .debug_info section.
Other DWARF sections (<code class="docutils literal notranslate"><span class="pre">.debug_line</span></code>, <code class="docutils literal notranslate"><span class="pre">.debug_frame</span></code>) are emitted as well
based on non-DWARF-specific data structures (for example, the PCLN table).</p>
</div>
<div class="section" id="mechanisms-provided-by-the-dwarf-standard-for-representing-inlining-info">
<h2>Mechanisms provided by the DWARF standard for representing inlining info<a class="headerlink" href="#mechanisms-provided-by-the-dwarf-standard-for-representing-inlining-info" title="Permalink to this headline">¶</a></h2>
<p>The DWARF specification provides details on how compilers can capture and
encapsulate information about inlining.
See section 3.3.8 of the DWARF V4 standard for a start.</p>
<p>If a routine X winds up being inlined, the information that would ordinarily get
placed into the subprogram DIE is divided into two partitions: the abstract
attributes such as name, type (which will be the same regardless of whether
we’re talking about an inlined function body or an out-of-line function body),
and concrete attributes such as the location for a variable, hi/lo PC or PC
ranges for a function body.</p>
<p>The abstract items are placed into an “abstract” subprogram instance, then each
actual instance of a function body is given a “concrete” instance, which refers
back to its parent abstract instance.
This can be seen in more detail in the “how the generated DWARF should look”
section below.</p>
</div>
</div>
<div class="section" id="example">
<h1>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">package</span> <span class="n">s</span>

    <span class="n">func</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">lx</span><span class="p">,</span> <span class="n">ly</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lx</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">ly</span> <span class="o">&gt;&gt;</span> <span class="n">uint32</span><span class="p">(</span><span class="n">lx</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">func</span> <span class="n">Mid</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="n">my</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">mv</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="nb">int</span>
        <span class="n">mv</span><span class="p">[</span><span class="n">mx</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">mv</span><span class="p">[</span><span class="n">my</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">mx</span><span class="o">+</span><span class="n">my</span><span class="p">,</span> <span class="n">my</span><span class="o">-</span><span class="n">mx</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">func</span> <span class="n">Top</span><span class="p">(</span><span class="n">tq</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">int</span> <span class="p">{</span>
        <span class="n">var</span> <span class="n">tv</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="nb">int</span>
        <span class="n">tr</span> <span class="o">:=</span> <span class="n">Leaf</span><span class="p">(</span><span class="n">tq</span><span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="n">tq</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">tv</span><span class="p">[</span><span class="n">tq</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mid</span><span class="p">(</span><span class="n">tq</span><span class="p">,</span> <span class="n">tq</span><span class="o">*</span><span class="n">tq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tr</span> <span class="o">+</span> <span class="n">tq</span> <span class="o">+</span> <span class="n">tv</span><span class="p">[</span><span class="n">tr</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>If the code above is compiled with the existing compiler and the resulting DWARF
inspected, there is a single DW_TAG_subprogram DIE for <code class="docutils literal notranslate"><span class="pre">Top</span></code>, with variable DIEs
reflecting params and (selected) locals for that routine.
Two of the stack-allocated locals from the inlined routines (Mid and Leaf)
survive in the DWARF, but other inlined variables do not:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>
     <span class="n">DW_AT_name</span><span class="p">:</span>           <span class="n">s</span><span class="o">.</span><span class="n">Top</span>
     <span class="o">...</span>
     <span class="n">DW_TAG_variable</span> <span class="p">{</span>
       <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">tv</span>
       <span class="o">...</span>
     <span class="p">}</span>
     <span class="n">DW_TAG_variable</span> <span class="p">{</span>
       <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">mv</span>
       <span class="o">...</span>
     <span class="p">}</span>
     <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
       <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">tq</span>
       <span class="o">...</span>
     <span class="p">}</span>
     <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
       <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="o">~</span><span class="n">r1</span>
       <span class="o">...</span>
     <span class="p">}</span>
</pre></div>
</div>
<p>There are also subprogram DIE’s for the out-of-line copies of <code class="docutils literal notranslate"><span class="pre">Leaf</span></code> and <code class="docutils literal notranslate"><span class="pre">Mid</span></code>,
which look similar (variable DIEs for locals and params with stack locations).</p>
<p>When enhanced DWARF location tracking is turned on, in addition to more accurate
variable location expressions within <code class="docutils literal notranslate"><span class="pre">Top</span></code>, there are additional DW_TAG_variable
entries for variable such as “lx” and “ly” corresponding those values within the
inlined body of <code class="docutils literal notranslate"><span class="pre">Leaf</span></code>.
Since these vars are directly parented by <code class="docutils literal notranslate"><span class="pre">Top</span></code> there is no way to disambiguate
the various instances of a var such as “lx”.</p>
</div>
<div class="section" id="how-the-generated-dwarf-should-look">
<h1>How the generated DWARF should look<a class="headerlink" href="#how-the-generated-dwarf-should-look" title="Permalink to this headline">¶</a></h1>
<p>As mentioned above, emitting DWARF records that capture inlining decisions
involves splitting the subprogram DIE for a given function into two pieces, a
single “abstract instance” (containing location-independent info) and then a set
of “concrete instances”, one for each instantiation of the function.</p>
<p>Here is a representation of how the generated DWARF should look for the example
above.
First, the abstract subprogram instance for <code class="docutils literal notranslate"><span class="pre">Leaf</span></code>.
No high/lo PC, no locations, for variables etc (these are provided in concrete
instances):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>   <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D1</span>
      <span class="n">DW_AT_name</span><span class="p">:</span>            <span class="n">s</span><span class="o">.</span><span class="n">Leaf</span>
      <span class="n">DW_AT_inline</span> <span class="p">:</span> <span class="n">DW_INL_inlined</span> <span class="p">(</span><span class="ow">not</span> <span class="n">declared</span> <span class="k">as</span> <span class="n">inline</span> <span class="n">but</span> <span class="n">inlined</span><span class="p">)</span>
      <span class="o">...</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>   <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D2</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">lx</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>    <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D3</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">ly</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="o">...</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>Next we would expect to see a concrete subprogram instance for <code class="docutils literal notranslate"><span class="pre">s.Leaf</span></code>, corresponding to the out-of-line copy of the function (which may wind up being eliminated by the linker if all calls are inlined).
This DIE refers back to its abstract parent via the DW_AT_abstract_origin
attribute, then fills in location details (such as hi/lo PC, variable locations,
etc):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>
      <span class="n">DW_AT_abstract_origin</span><span class="p">:</span>  <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D1</span> <span class="n">above</span>
      <span class="n">DW_AT_low_pc</span>         <span class="p">:</span> <span class="o">...</span>
      <span class="n">DW_AT_high_pc</span>        <span class="p">:</span> <span class="o">...</span>
      <span class="o">...</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D2</span> <span class="n">above</span>
         <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D3</span> <span class="n">above</span>
         <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
      <span class="p">}</span>
      <span class="o">...</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>Similarly for <code class="docutils literal notranslate"><span class="pre">Mid</span></code>, there would be an abstract subprogram instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>   <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D4</span>
      <span class="n">DW_AT_name</span><span class="p">:</span>            <span class="n">s</span><span class="o">.</span><span class="n">Mid</span>
      <span class="n">DW_AT_inline</span> <span class="p">:</span> <span class="n">DW_INL_inlined</span> <span class="p">(</span><span class="ow">not</span> <span class="n">declared</span> <span class="k">as</span> <span class="n">inline</span> <span class="n">but</span> <span class="n">inlined</span><span class="p">)</span>
      <span class="o">...</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>    <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D5</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">mx</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>    <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D6</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">my</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_variable</span> <span class="p">{</span>         <span class="o">//</span> <span class="n">offset</span><span class="p">:</span> <span class="n">D7</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">mv</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>Then a concrete subprogram instance for out-of-line copy of <code class="docutils literal notranslate"><span class="pre">Mid</span></code>.
Note that incorporated into the concrete instance for <code class="docutils literal notranslate"><span class="pre">Mid</span></code> we also see an
inlined instance for <code class="docutils literal notranslate"><span class="pre">Leaf</span></code>.
This DIE (with tag DW_TAG_inlined_subroutine) contains a reference to the
abstract subprogram DIE for <code class="docutils literal notranslate"><span class="pre">Leaf</span></code>, also attributes for the file and line of
the callsite that was inlined:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>
      <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D4</span> <span class="n">above</span>
      <span class="n">DW_AT_low_pc</span>         <span class="p">:</span> <span class="o">...</span>
      <span class="n">DW_AT_high_pc</span>        <span class="p">:</span> <span class="o">...</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D5</span> <span class="n">above</span>
         <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D6</span> <span class="n">above</span>
         <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_variable</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D7</span> <span class="n">above</span>
         <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
      <span class="p">}</span>
      <span class="o">//</span> <span class="n">inlined</span> <span class="n">body</span> <span class="n">of</span> <span class="s1">&#39;Leaf&#39;</span>
      <span class="n">DW_TAG_inlined_subroutine</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D1</span> <span class="n">above</span>
         <span class="n">DW_AT_call_file</span><span class="p">:</span> <span class="mi">1</span>
         <span class="n">DW_AT_call_line</span><span class="p">:</span> <span class="mi">10</span>
         <span class="n">DW_AT_ranges</span>         <span class="p">:</span> <span class="o">...</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D2</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D3</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
        <span class="o">...</span>
      <span class="p">}</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>Finally we would expect to see a subprogram instance for <code class="docutils literal notranslate"><span class="pre">s.Top</span></code>.
Note that since <code class="docutils literal notranslate"><span class="pre">s.Top</span></code> is not inlined, we would have a single subprogram DIE
(as opposed to an abstract instance DIE and a concrete instance DIE):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">DW_TAG_subprogram</span> <span class="p">{</span>
      <span class="n">DW_AT_name</span><span class="p">:</span>            <span class="n">s</span><span class="o">.</span><span class="n">Top</span>
      <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">tq</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="o">...</span>
      <span class="o">//</span> <span class="n">inlined</span> <span class="n">body</span> <span class="n">of</span> <span class="s1">&#39;Leaf&#39;</span>
      <span class="n">DW_TAG_inlined_subroutine</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D1</span> <span class="n">above</span>
         <span class="n">DW_AT_call_file</span><span class="p">:</span> <span class="mi">1</span>
         <span class="n">DW_AT_call_line</span><span class="p">:</span> <span class="mi">15</span>
         <span class="n">DW_AT_ranges</span>         <span class="p">:</span> <span class="o">...</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D2</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D3</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_variable</span> <span class="p">{</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>         <span class="n">tr</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>         <span class="o">...</span>
      <span class="p">}</span>
      <span class="n">DW_TAG_variable</span> <span class="p">{</span>
         <span class="n">DW_AT_name</span><span class="p">:</span>      <span class="n">tv</span>
         <span class="n">DW_AT_type</span><span class="p">:</span>      <span class="o">...</span>
      <span class="p">}</span>
      <span class="o">//</span> <span class="n">inlined</span> <span class="n">body</span> <span class="n">of</span> <span class="s1">&#39;Mid&#39;</span>
      <span class="n">DW_TAG_inlined_subroutine</span> <span class="p">{</span>
         <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D4</span> <span class="n">above</span>
         <span class="n">DW_AT_call_file</span><span class="p">:</span> <span class="mi">1</span>
         <span class="n">DW_AT_call_line</span><span class="p">:</span> <span class="mi">16</span>
         <span class="n">DW_AT_low_pc</span>         <span class="p">:</span> <span class="o">...</span>
         <span class="n">DW_AT_high_pc</span>        <span class="p">:</span> <span class="o">...</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D5</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D6</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="n">DW_TAG_variable</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D7</span> <span class="n">above</span>
            <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
         <span class="p">}</span>
         <span class="o">//</span> <span class="n">inlined</span> <span class="n">body</span> <span class="n">of</span> <span class="s1">&#39;Leaf&#39;</span>
         <span class="n">DW_TAG_inlined_subroutine</span> <span class="p">{</span>
            <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D1</span> <span class="n">above</span>
            <span class="n">DW_AT_call_file</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">DW_AT_call_line</span><span class="p">:</span> <span class="mi">10</span>
            <span class="n">DW_AT_ranges</span>         <span class="p">:</span> <span class="o">...</span>
            <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
               <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D2</span> <span class="n">above</span>
               <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
            <span class="p">}</span>
            <span class="n">DW_TAG_formal_parameter</span> <span class="p">{</span>
               <span class="n">DW_AT_abstract_origin</span><span class="p">:</span> <span class="o">//</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">D3</span> <span class="n">above</span>
               <span class="n">DW_AT_location</span><span class="p">:</span>        <span class="o">...</span>
            <span class="p">}</span>
            <span class="o">...</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="outline-of-proposed-changes">
<h1>Outline of proposed changes<a class="headerlink" href="#outline-of-proposed-changes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="changes-to-the-inliner">
<h2>Changes to the inliner<a class="headerlink" href="#changes-to-the-inliner" title="Permalink to this headline">¶</a></h2>
<p>The inliner manufactures new temporaries for each of the inlined functions
formal parameters; it then creates code to assign the correct “actual”
expression to each temp, and finally walks the inlined body to replace formal
references with temp references.
For proper DWARF generation, we need to have a way to associate each of these
temps with the formal from which it was derived.
It should be possible to create such an association by making sure the temp has
the correct src pos (which refers to the callsite) and by giving the temp the
same name as the formal.</p>
</div>
<div class="section" id="changes-to-debug-generation">
<h2>Changes to debug generation<a class="headerlink" href="#changes-to-debug-generation" title="Permalink to this headline">¶</a></h2>
<p>For the abbreviation table
(<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/dwarf/dwarf.go#L245"><code class="docutils literal notranslate"><span class="pre">dwarf.dwAbbrev</span></code></a>
array), we will need to add abstract and concrete versions of the
DW_TAG_subprogram abbrev entry used for functions to the abbrev list.
top</p>
<p>For a given function,
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/internal/dwarf/dwarf.go#L687"><code class="docutils literal notranslate"><span class="pre">dwarf.PutFunc</span></code></a>
will need to emit either an ordinary subprogram DIE (if the function was never
inlined) or an abstract subprogram instance followed by a concrete subprogram
instance, corresponding to the out-of-line version of the function.</p>
<p>It probably makes sense to define a new <code class="docutils literal notranslate"><span class="pre">dwarf.InlinedCall</span></code> type; this will be a
struct holding information on the result of an inlined call in a function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">InlinedCall</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="n">Children</span> <span class="p">[]</span><span class="o">*</span><span class="n">InlinedCall</span>
    <span class="n">InlIndex</span> <span class="nb">int</span> <span class="o">//</span> <span class="n">index</span> <span class="n">into</span> <span class="n">ctx</span><span class="o">.</span><span class="n">InlTree</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Code can be added (presumably in <code class="docutils literal notranslate"><span class="pre">gc.debuginfo</span></code>) that collects a tree of
<code class="docutils literal notranslate"><span class="pre">dwarf.InlinedCall</span></code> objects corresponding to the functions inlined into the
current function being emitted.
This tree can then be used to drive creation of concrete inline instances as
children of the subprogram DIE of the function being emitted.</p>
<p>There will need to be code written that assigns variables and instructions
(progs/PCs) to specific concrete inlined routine instances, similar to what is
being done currently with scopes in
<a class="reference external" href="https://github.com/golang/go/blob/release-branch.go1.9/src/cmd/compile/internal/gc/scope.go#L29"><code class="docutils literal notranslate"><span class="pre">gc.assembleScopes</span></code></a>.</p>
<p>One wrinkle in that the existing machinery for creating intra-DWARF references
(attributes with form DW_FORM_ref_addr) assumes that the target of the reference
is a top-level DIE with an associated symbol (type, function, etc).
This assumption no longer holds for DW_AT_abstract_origin references to formal
parameters (where the param is a sub-attribute of a top-level DIE).
Some new mechanism will need to be invented to capture this flavor of reference.</p>
</div>
<div class="section" id="changes-to-the-linker">
<h2>Changes to the linker<a class="headerlink" href="#changes-to-the-linker" title="Permalink to this headline">¶</a></h2>
<p>There will probably need to be a few changes to the linker to accommodate
abstract origin references, but for the most part I think the bulk of the work
will be done in the compiler.</p>
</div>
</div>
<div class="section" id="compatibility">
<h1>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this headline">¶</a></h1>
<p>The DWARF constructs proposed here require DWARF version 4, however the compiler
is already emitting DWARF V4 as of 1.9.</p>
</div>
<div class="section" id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h1>
<p>Plan is for thanm&#64; to implement this in go 1.10 timeframe.</p>
</div>
<div class="section" id="prerequisite-changes">
<h1>Prerequisite Changes<a class="headerlink" href="#prerequisite-changes" title="Permalink to this headline">¶</a></h1>
<p>N/A</p>
</div>
<div class="section" id="preliminary-results">
<h1>Preliminary Results<a class="headerlink" href="#preliminary-results" title="Permalink to this headline">¶</a></h1>
<p>No data available yet.
Expectation is that this will increase the load module size due to the
additional DWARF records, but not clear to what degree.</p>
</div>
<div class="section" id="open-issues">
<h1>Open issues<a class="headerlink" href="#open-issues" title="Permalink to this headline">¶</a></h1>
<p>Once lexical scope tracking is enhanced to work for regular (not ‘-l -N’)
compilation, we’ll want to integrate inlined instance records with scopes (e.g.
if the topmost callsite in question is nested within a scope, then the top-level
inlined instance DIE should be parented by the appropriate scope DIE).</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="24301-versioned-go.html" class="btn btn-neutral float-right" title="Proposal: Versioned Go Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="19480-xml-stream.html" class="btn btn-neutral float-left" title="Proposal: XML Stream" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>