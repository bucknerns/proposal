

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Proposal: Lazy Module Loading &mdash; Go Design Proposal  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives" href="36606-64-bit-field-alignment.html" />
    <link rel="prev" title="Proposal: Scaling the Go page allocator" href="35112-scaling-the-page-allocator.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Go Design Proposal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="11502-securitypolicy.html">Proposal: Security Policy for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="11970-decentralized-gc.html">Proposal: Decentralized GC coordination</a></li>
<li class="toctree-l1"><a class="reference internal" href="12166-subtests.html">Proposal: testing: programmatic sub-test and sub-benchmark support</a></li>
<li class="toctree-l1"><a class="reference internal" href="12302-release-proposal.html">Proposal: A minimal release process for Go repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="12416-cgo-pointers.html">Proposal: Rules for passing pointers between Go and C</a></li>
<li class="toctree-l1"><a class="reference internal" href="12750-localization.html">Proposal: Localization support in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12800-sweep-free-alloc.html">Proposal: Dense mark bits and sweep-free allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html">Proposal: Monotonic Elapsed Time Measurements in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html#appendix-time-now-usage">Appendix: time.Now usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="13073-code-of-conduct.html">Proposal: A Code of Conduct for the Go community</a></li>
<li class="toctree-l1"><a class="reference internal" href="13432-mobile-audio.html">Proposal: Audio for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="13504-natural-xml.html">Proposal: Natural XML</a></li>
<li class="toctree-l1"><a class="reference internal" href="14313-benchmark-format.html">Proposal: Go Benchmark Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="14386-zip-package-archives.html">Proposal: Zip-based Go package archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="14951-soft-heap-limit.html">Proposal: Separate soft and hard heap size goal</a></li>
<li class="toctree-l1"><a class="reference internal" href="15292-generics.html">Proposal: Go should have generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="16085-conversions-ignore-tags.html">Proposal: Ignore tags in struct type conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html">Proposal: Alias declarations for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html#appendix">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="16410-heap-viewer.html">Proposal: Go Heap Dump Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="16704-cidr-notation-no-proxy.html">Proposal: Add support for CIDR notation in no_proxy variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="17280-profile-labels.html">Proposal: Support for pprof profiler labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="17503-eliminate-rescan.html">Proposal: Eliminate STW stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="17505-concurrent-rescan.html">Proposal: Concurrent stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="18130-type-alias.html">Proposal: Type Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html">Proposal: percpu.Sharded, an API for reducing cache contention</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#discussion">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#backwards-compatibility">Backwards compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19113-signed-shift-counts.html">Proposal: Permit Signed Integers as Shift Counts for Go 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="19308-number-literals.html">Proposal: Go 2 Number Literal Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html">Proposal: Mid-stack inlining in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#proposal">Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#rationale">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="19480-xml-stream.html">Proposal: XML Stream</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html">Proposal: emit DWARF inlining info in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#example">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#how-the-generated-dwarf-should-look">How the generated DWARF should look</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#outline-of-proposed-changes">Outline of proposed changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="24301-versioned-go.html">Proposal: Versioned Go Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="24543-non-cooperative-preemption.html">Proposal: Non-cooperative goroutine preemption</a></li>
<li class="toctree-l1"><a class="reference internal" href="25530-sumdb.html">Proposal: Secure the Public Go Module Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="25719-go15vendor.html">Go 1.5 Vendor Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="26160-dns-based-vanity-imports.html">Proposal: DNS Based Vanity Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="26756-rawxml-token.html">Proposal: Raw XML Token</a></li>
<li class="toctree-l1"><a class="reference internal" href="26903-simplify-mark-termination.html">Proposal: Simplify mark termination and eliminate mark 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="27539-internal-abi.html">Proposal: Create an undefined internal calling convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="2775-binary-only-packages.html">Proposal: Binary-Only Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="27935-unbounded-queue-package.html">Proposal: Built in support for high performance unbounded queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="28221-go2-transitions.html">Proposal: Go 2 transition</a></li>
<li class="toctree-l1"><a class="reference internal" href="2981-go-test-json.html">Proposal: <code class="docutils literal notranslate"><span class="pre">-json</span></code> flag in <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="29934-error-values.html">Proposal: Go 2 Error Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="30333-smarter-scavenging.html">Proposal: Smarter Scavenging</a></li>
<li class="toctree-l1"><a class="reference internal" href="30411-env.html">Proposal: <code class="docutils literal notranslate"><span class="pre">go</span></code> command configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="32437-try-builtin.html">Proposal: A built-in Go error check function, <code class="docutils literal notranslate"><span class="pre">try</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="33974-add-public-lockedfile-pkg.html">Proposal: make the internal lockedfile package public</a></li>
<li class="toctree-l1"><a class="reference internal" href="34481-opencoded-defers.html">Proposal: Low-cost defers through inline code, and extra funcdata to manage the panic case</a></li>
<li class="toctree-l1"><a class="reference internal" href="35112-scaling-the-page-allocator.html">Proposal: Scaling the Go page allocator</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Proposal: Lazy Module Loading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#properties">Properties</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#proposal">Proposal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#invariants">Invariants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-loading-procedure">Module loading procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-all-pattern-and-mod-subcommands">The <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern and <code class="docutils literal notranslate"><span class="pre">mod</span></code> subcommands</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#in-go-1-111-14">In Go 1.11–1.14</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-all-package-pattern-and-go-mod-tidy">The <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-all-and-module-patterns-and-go-mod-download">The <code class="docutils literal notranslate"><span class="pre">all</span></code> and <code class="docutils literal notranslate"><span class="pre">...</span></code> module patterns and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#effect-on-go-mod-size">Effect on <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> size</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#compatibility">Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#open-issues">Open issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#importing-a-new-package-from-an-existing-module-dependency">Importing a new package from an existing module dependency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-an-imported-package-found-in-another-module">Testing an imported package found in another module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-an-unimported-package-found-in-an-existing-module-dependency">Testing an unimported package found in an existing module dependency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing-a-package-imported-from-a-go-1-14-dependency">Testing a package imported from a <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.14</span></code> dependency</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="36606-64-bit-field-alignment.html">Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="37112-unstable-runtime-metrics.html">Proposal: API for unstable runtime metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="37720-gopls-workspaces.html">Proposal: Multi-project gopls workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="4899-testing-helper.html">Proposal: testing: better support test helper functions with TB.Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="6282-table-data.html">Proposal: Multi-dimensional slices</a></li>
<li class="toctree-l1"><a class="reference internal" href="6977-overlapping-interfaces.html">Proposal: Permit embedding of interfaces with overlapping method sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="TEMPLATE.html">Proposal: [Title]</a></li>
<li class="toctree-l1"><a class="reference internal" href="cryptography-principles.html">Cryptography Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft.html">Go 2 Draft Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-contracts.html">Contracts — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling.html">Error Handling — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling-overview.html">Error Handling — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-inspection.html">Error Inspection — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-printing.html">Error Printing — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-values-overview.html">Error Values — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-generics-overview.html">Generics — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-type-parameters.html">Type Parameters - Draft Design</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Go Design Proposal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Proposal: Lazy Module Loading</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/36460-lazy-module-loading.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="proposal-lazy-module-loading">
<h1>Proposal: Lazy Module Loading<a class="headerlink" href="#proposal-lazy-module-loading" title="Permalink to this headline">¶</a></h1>
<p>Author: Bryan C. Mills (with substantial input from Russ Cox, Jay Conrod, and
Michael Matloob)</p>
<p>Last updated: 2020-02-20</p>
<p>Discussion at https://golang.org/issue/36460.</p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>We propose to change <code class="docutils literal notranslate"><span class="pre">cmd/go</span></code> to avoid loading transitive module dependencies
that have no observable effect on the packages to be built.</p>
<p>The key insights that lead to this approach are:</p>
<ol class="simple">
<li><p>If <em>no</em> package in a given dependency module is ever (even transitively)
imported by any package loaded by an invocation of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command, then an
incompatibility between any package in that dependency and any other package
has no observable effect in the resulting program(s). Therefore, we can
safely ignore the (transitive) requirements of any module that does not
contribute any package to the build.</p></li>
<li><p>We can use the explicit requirements of the main module as a coarse filter
on the set of modules relevant to the main module and to previous
invocations of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command.</p></li>
</ol>
<p>Based on those insights, we propose to change the <code class="docutils literal notranslate"><span class="pre">go</span></code> command to retain more
transitive dependencies in <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files and to avoid loading <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files
for “irrelevant” modules, while still maintaining high reproducibility for build
and test operations.</p>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>In the initial implementation of modules, we attempted to make <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code>
prune out of the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file any module that did not provide a transitive
import of the main module. However, that did not always preserve the remaining
build list: a module that provided no packages might still raise the minimum
requirement on some <em>other</em> module that <em>did</em> provide a package.</p>
<p>We addressed that problem in <a class="reference external" href="https://golang.org/cl/121304">CL 121304</a> by explicitly retaining requirements on
all modules that provide <em>directly-imported</em> packages, <em>as well as</em> a minimal
set of module requirement roots needed to retain the selected versions of
transitively-imported packages.</p>
<p>In <a class="reference external" href="https://golang.org/issue/29773">#29773</a> and <a class="reference external" href="https://golang.org/issue/31248">#31248</a>, we realized that, due to the fact that the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code>
file is pruned to remove indirect dependencies already implied by other
requirements, we must load the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file for all versions of dependencies,
even if we know that they will not be selected — even including the main module
itself!</p>
<p>In <a class="reference external" href="https://golang.org/issue/30831">#30831</a> and <a class="reference external" href="https://golang.org/issue/34016">#34016</a>, we learned that following deep history makes
problematic dependencies very difficult to completely eliminate. If the
repository containing a module is no longer available and the module is not
cached in a module mirror, then we will encounter an error when loading any
module — even a very old, irrelevant one! — that required it.</p>
<p>In <a class="reference external" href="https://golang.org/issue/26904">#26904</a>, <a class="reference external" href="https://golang.org/issue/32058">#32058</a>, <a class="reference external" href="https://golang.org/issue/33370">#33370</a>, and <a class="reference external" href="https://golang.org/issue/34417">#34417</a>, we found that the need to
consider every version of a module separately, rather than only the selected
version, makes the <code class="docutils literal notranslate"><span class="pre">replace</span></code> directive difficult to understand, difficult to use
correctly, and generally more complex than we would like it to be.</p>
<p>In addition, users have repeatedly expressed the desire to avoid the cognitive
overhead of seeing “irrelevant” transitive dependencies (<a class="reference external" href="https://golang.org/issue/26955">#26955</a>, <a class="reference external" href="https://golang.org/issue/27900">#27900</a>,
<a class="reference external" href="https://golang.org/issue/32380">#32380</a>), reasoning about older-than-selected transitive dependencies
(<a class="reference external" href="https://golang.org/issue/36369">#36369</a>), and fetching large numbers of <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files (<a class="reference external" href="https://golang.org/issue/33669">#33669</a>, <a class="reference external" href="https://golang.org/issue/29935">#29935</a>).</p>
<div class="section" id="properties">
<h3>Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>In this proposal, we aim to achieve a property that we call <dfn>lazy
loading</dfn>:</p>
<ul class="simple">
<li><p>In the steady state, an invocation of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command should not load any
<code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file or source code for a module (other than the main module) that
provides no <em>packages</em> loaded by that invocation.</p>
<ul>
<li><p>In particular, if the selected version of a module is not changed by a
<code class="docutils literal notranslate"><span class="pre">go</span></code> command, the <code class="docutils literal notranslate"><span class="pre">go</span></code> command should not load a <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file or source
code for any <em>other</em> version of that module.</p></li>
</ul>
</li>
</ul>
<p>We also want to preserve <dfn>reproducibility</dfn> of <code class="docutils literal notranslate"><span class="pre">go</span></code> command invocations:</p>
<ul class="simple">
<li><p>An invocation of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command should either load the same version of
each package as every other invocation since the last edit to the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code>
file, or should edit the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file in a way that causes the next
invocation on any subset of the same packages to use the same versions.</p></li>
</ul>
</div>
</div>
<div class="section" id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">¶</a></h2>
<div class="section" id="invariants">
<h3>Invariants<a class="headerlink" href="#invariants" title="Permalink to this headline">¶</a></h3>
<p>We propose that, when the main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file specifies <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code> or
higher, every invocation of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command should update the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file to
maintain three invariants.</p>
<ol class="simple">
<li><p>(The <dfn>import invariant</dfn>.) The main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file
explicitly requires the selected version of every module that contains one
or more packages that were transitively imported by any package in the main
module.</p></li>
<li><p>(The <dfn>argument invariant<dfn>.) The main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file
explicitly requires the selected version of every module that contains one
or more packages that matched an explicit <a class="reference external" href="https://tip.golang.org/cmd/go/#hdr-Package_lists_and_patterns">package pattern</a> argument.</p></li>
<li><p>(The <dfn>completeness invariant</dfn>.) The version of every module that
contributed any package to the build is recorded in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file of
either the main module itself or one of modules it requires explicitly.</p></li>
</ol>
<p>The <em>completeness invariant</em> alone is sufficient to ensure <em>reproducibility</em> and
<em>lazy loading</em>. However, it is under-constrained: there are potentially many
<em>minimal</em> sets of requirements that satisfy the completeness invariant, and even
more <em>valid</em> solutions. The <em>import</em> and <em>argument</em> invariants guide us toward a
<em>specific</em> solution that is simple and intuitive to explain in terms of the <code class="docutils literal notranslate"><span class="pre">go</span></code>
commands invoked by the user.</p>
<p>If the main module satisfies the <em>import</em> and <em>argument</em> invariants, and all
explicit module dependencies also satisfy the import invariant, then the
<em>completeness</em> invariant is also trivially satisfied. Given those, the
completeness invariant exists only in order to tolerate <em>incomplete</em>
dependencies.</p>
<p>If the import invariant or argument invariant holds at the start of a <code class="docutils literal notranslate"><span class="pre">go</span></code>
invocation, we can trivially preserve that invariant (without loading any
additional packages or modules) at the end of the invocation by updating the
<code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file with explicit versions for all module paths that were already
present, in addition to any new main-module imports or package arguments found
during the invocation.</p>
</div>
<div class="section" id="module-loading-procedure">
<h3>Module loading procedure<a class="headerlink" href="#module-loading-procedure" title="Permalink to this headline">¶</a></h3>
<p>At the start of each operation, we load all of the explicit requirements from
the main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file.</p>
<p>If we encounter an import from any module that is not already <em>explicitly</em>
required by the main module, we perform a <dfn>deepening scan</dfn>. To perform
a deepening scan, we read the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file for each module explicitly required
by the main module, and add its requirements to the build list. If any
explicitly-required module uses <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.14</span></code> or earlier, we also read the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code>
files for all of that module’s (transitive) module dependencies.</p>
<p>(The deepening scan allows us to detect changes to the import graph without
loading the whole graph explicitly: if we encounter a new import from within a
previously-irrelevant package, the deepening scan will re-read the requirements
of the module containing that package, and will ensure that the selected version
of that import is compatible with all other relevant packages.)</p>
<p>As we load each imported package, we also read the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file for the module
containing that package and add its requirements to the build list — even if
that version of the module was already explicitly required by the main module.</p>
<p>(This step is theoretically redundant: the requirements of the main module will
already reflect any relevant dependencies, and the <em>deepening scan</em> will catch
any previously-irrelevant dependencies that subsequently <em>become</em> relevant.
However, reading the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file for each imported package makes the <code class="docutils literal notranslate"><span class="pre">go</span></code>
command much more robust to inconsistencies in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file — including
manual edits, erroneous version-control merge resolutions, incomplete
dependencies, and changes in <code class="docutils literal notranslate"><span class="pre">replace</span></code> directives and replacement directory
contents.)</p>
<p>If, after the <em>deepening scan,</em> the package to be imported is still not found in
any module in the build list, we resolve the <code class="docutils literal notranslate"><span class="pre">latest</span></code> version of a module
containing that package and add it to the build list (following the same search
procedure as in Go 1.14), then perform another deepening scan (this time
including the newly added-module) to ensure consistency.</p>
</div>
<div class="section" id="the-all-pattern-and-mod-subcommands">
<h3>The <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern and <code class="docutils literal notranslate"><span class="pre">mod</span></code> subcommands<a class="headerlink" href="#the-all-pattern-and-mod-subcommands" title="Permalink to this headline">¶</a></h3>
<div class="section" id="in-go-1-111-14">
<h4>In Go 1.11–1.14<a class="headerlink" href="#in-go-1-111-14" title="Permalink to this headline">¶</a></h4>
<p>In module mode in Go 1.11–1.14, the <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern matches each package
reachable by following imports <em>and tests of imported packages</em> recursively,
starting from the packages in the main module. (It is equivalent to the set of
packages obtained by iterating <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">list</span> <span class="pre">-deps</span> <span class="pre">-test</span> <span class="pre">./...</span></code> over its own output
until it reaches a fixed point.)</p>
<p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> adjusts the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> and <code class="docutils literal notranslate"><span class="pre">go.sum</span></code> files so that the main module
transitively requires a set of modules that provide every package matching the
<code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern, independent of build tags. After <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code>, every
package matching the <code class="docutils literal notranslate"><span class="pre">all</span></code> <em>package</em> pattern is provided by some module matching
the <code class="docutils literal notranslate"><span class="pre">all</span></code> <em>module</em> pattern.</p>
<p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> also updates a set of <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">indirect</span></code> comments indicating versions
added or upgraded beyond what is implied by transitive dependencies.</p>
<p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span></code> downloads all modules matching the <code class="docutils literal notranslate"><span class="pre">all</span></code> <em>module</em> pattern,
which normally includes a module providing every package in the <code class="docutils literal notranslate"><span class="pre">all</span></code> <em>package</em>
pattern.</p>
<p>In contrast, <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">vendor</span></code> copies in only the subset of packages transitively
<em>imported by</em> the packages and tests <em>in the main module</em>: it does not scan the
imports of tests outside of the main module, even if those tests are for
imported packages. (That is: <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">vendor</span></code> only covers the packages directly
reported by <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">list</span> <span class="pre">-deps</span> <span class="pre">-test</span> <span class="pre">./...</span></code>.)</p>
<p>As a result, when using <code class="docutils literal notranslate"><span class="pre">-mod=vendor</span></code> the <code class="docutils literal notranslate"><span class="pre">all</span></code> and <code class="docutils literal notranslate"><span class="pre">...</span></code> patterns may match
substantially fewer packages than when using <code class="docutils literal notranslate"><span class="pre">-mod=mod</span></code> (the default) or
<code class="docutils literal notranslate"><span class="pre">-mod=readonly</span></code>.</p>
<!-- Note: the behavior of `go mod vendor` was changed to its current form
during the `vgo` prototype, in https://golang.org/cl/122256. --></div>
<div class="section" id="the-all-package-pattern-and-go-mod-tidy">
<h4>The <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code><a class="headerlink" href="#the-all-package-pattern-and-go-mod-tidy" title="Permalink to this headline">¶</a></h4>
<p>We would like to preserve the property that, after <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code>, invocations of
the <code class="docutils literal notranslate"><span class="pre">go</span></code> command — including <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code> — are <em>reproducible</em> (without changing
the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file) for every package matching the <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern. The
<em>completeness invariant</em> is what ensures reproducibility, so <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> must
ensure that it holds.</p>
<p>Unfortunately, even if the <em>import invariant</em> holds for all of the dependencies
of the main module, the current definition of the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern includes
<em>dependencies of tests of dependencies</em>, recursively. In order to establish the
<em>completeness invariant</em> for distant test-of-test dependencies, <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code>
would sometimes need to record a substantial number of dependencies of tests
found outside of the main module in the main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file.</p>
<p>Fortunately, we can omit those distant dependencies a different way: by changing
the definition of the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern itself, so that test-of-test dependencies
are no longer included. Feedback from users (in <a class="reference external" href="https://golang.org/issue/29935">#29935</a>, <a class="reference external" href="https://golang.org/issue/26955">#26955</a>, <a class="reference external" href="https://golang.org/issue/32380">#32380</a>,
<a class="reference external" href="https://golang.org/issue/32419">#32419</a>, <a class="reference external" href="https://golang.org/issue/33669">#33669</a>, and perhaps others) has consistently favored omitting those
dependencies, and narrowing the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern would also establish a nice <em>new</em>
property: after running <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">vendor</span></code>, the <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern with
<code class="docutils literal notranslate"><span class="pre">-mod=vendor</span></code> would now match the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern with <code class="docutils literal notranslate"><span class="pre">-mod=mod</span></code>.</p>
<p>Taking those considerations into account, we propose that the <code class="docutils literal notranslate"><span class="pre">all</span></code> package
pattern in module mode should match only the packages transitively <em>imported by</em>
packages and tests in the main module: that is, exactly the set of packages
preserved by <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">vendor</span></code>. Since the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern is based on package
imports (more-or-less independent of module dependencies), this change should be
independent of the <code class="docutils literal notranslate"><span class="pre">go</span></code> version specified in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file.</p>
<p>The behavior of <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> should change depending on the <code class="docutils literal notranslate"><span class="pre">go</span></code> version. In a
module that specifies <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code> or later, <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> should scan the packages
matching the new definition of <code class="docutils literal notranslate"><span class="pre">all</span></code>, ignoring build tags. In a module that
specifies <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.14</span></code> or earlier, it should continue to scan the packages matching
the <em>old</em> definition (still ignoring build tags). (Note that both of those sets
are supersets of the new <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern.)</p>
</div>
<div class="section" id="the-all-and-module-patterns-and-go-mod-download">
<h4>The <code class="docutils literal notranslate"><span class="pre">all</span></code> and <code class="docutils literal notranslate"><span class="pre">...</span></code> module patterns and <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span></code><a class="headerlink" href="#the-all-and-module-patterns-and-go-mod-download" title="Permalink to this headline">¶</a></h4>
<p>In Go 1.11–1.14, the <code class="docutils literal notranslate"><span class="pre">all</span></code> module pattern matches each module reachable by
following module requirements recursively, starting with the main module and
visiting every version of every module encountered. The module pattern <code class="docutils literal notranslate"><span class="pre">...</span></code> has
the same behavior.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">all</span></code> module pattern is important primarily because it is the default set of
modules downloaded by the <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span></code> subcommand, which sets up the local
cache for offline use. However, it (along with <code class="docutils literal notranslate"><span class="pre">...</span></code>) is also currently used by
a few other tools (such as <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">doc</span></code>) to locate “modules of interest” for other
purposes.</p>
<p>Unfortunately, these patterns as defined in Go 1.11–1.14 are <em>not compatible
with lazy loading:</em> they examine transitive <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files without loading any
packages. Therefore, in order to achieve lazy loading we must change their
behavior.</p>
<p>Since we want to compute the list of modules without loading any packages or
irrelevant <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files, we propose that when the main module’s <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file
specifies <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code> or higher, the <code class="docutils literal notranslate"><span class="pre">all</span></code> and wildcard module patterns should
match only those modules found in a <em>deepening scan</em> of the main module’s
dependencies. That definition includes every module whose version is
reproducible due to the <em>completeness invariant,</em> including modules needed by
tests of transitive imports.</p>
<p>With this redefinition of the <code class="docutils literal notranslate"><span class="pre">all</span></code> module pattern, and the above redefinition
of the <code class="docutils literal notranslate"><span class="pre">all</span></code> package pattern, we again have the property that, after <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span> <span class="pre">&amp;&amp;</span> <span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span> <span class="pre">all</span></code>, invoking <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code> on any package within <code class="docutils literal notranslate"><span class="pre">all</span></code>
does not need to download any new dependencies.</p>
<p>Since the <code class="docutils literal notranslate"><span class="pre">all</span></code> pattern includes every module encountered in the deepening scan,
rather than only those that provide imported packages, <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">download</span></code> may
continue to download more source code than is strictly necessary to build the
packages in <code class="docutils literal notranslate"><span class="pre">all</span></code>. However, as is the case today, users may download only that
narrower set as a side effect of invoking <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">list</span> <span class="pre">all</span></code>.</p>
</div>
</div>
<div class="section" id="effect-on-go-mod-size">
<h3>Effect on <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> size<a class="headerlink" href="#effect-on-go-mod-size" title="Permalink to this headline">¶</a></h3>
<p>Under this approach, the set of modules recorded in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file would in
most cases increase beyond the set recorded in Go 1.14. However, the set of
modules recorded in the <code class="docutils literal notranslate"><span class="pre">go.sum</span></code> file would decrease: irrelevant modules would
no longer be included.</p>
<ul class="simple">
<li><p>The modules recorded in <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> under this proposal would be a strict
subset of the set of modules recorded in <code class="docutils literal notranslate"><span class="pre">go.sum</span></code> in Go 1.14.</p>
<ul>
<li><p>The set of recorded modules would more closely resemble a “lock” file as
used in other dependency-management systems. (However, the <code class="docutils literal notranslate"><span class="pre">go</span></code> command
would still not require a separate “manifest” file, and unlike a lock
file, the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file would still be updated automatically to reflect
new requirements discovered during package loading.)</p></li>
</ul>
</li>
<li><p>For modules with <em>few</em> test-of-test dependencies, the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file after
running <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> will typically be larger than in Go 1.14. For modules
with <em>many</em> test-of-test dependencies, it may be substantially smaller.</p></li>
<li><p>For modules that are <em>tidy:</em></p>
<ul>
<li><p>The module versions recorded in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file would be exactly those
listed in <code class="docutils literal notranslate"><span class="pre">vendor/modules.txt</span></code>, if present.</p></li>
<li><p>The module versions recorded in <code class="docutils literal notranslate"><span class="pre">vendor/modules.txt</span></code> would be the same
as under Go 1.14, although the <code class="docutils literal notranslate"><span class="pre">##</span> <span class="pre">explicit</span></code> annotations could perhaps
be removed (because <em>all</em> relevant dependencies would be recorded
explicitly).</p></li>
<li><p>The module versions recorded in the <code class="docutils literal notranslate"><span class="pre">go.sum</span></code> file would be exactly those
listed in the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file syntax and semantics proposed here are backward compatible
with previous Go releases: all <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files for existing <code class="docutils literal notranslate"><span class="pre">go</span></code> versions would
retain their current meaning.</p>
<p>Under this proposal, a <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> file that specifies <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code> or higher will
cause the <code class="docutils literal notranslate"><span class="pre">go</span></code> command to lazily load the <code class="docutils literal notranslate"><span class="pre">go.mod</span></code> files for its requirements.
When reading a <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code> file, previous versions of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command (which do
not prune irrelevant dependencies) may select <em>higher</em> versions than those
selected under this proposal, by following otherwise-irrelevant dependency
edges. However, because the <code class="docutils literal notranslate"><span class="pre">require</span></code> directive continues to specify a minimum
version for the required dependency, a previous version of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command will
never select a <em>lower</em> version of any dependency.</p>
<p>Moreover, any strategy that prunes out a dependency as interpreted by a previous
<code class="docutils literal notranslate"><span class="pre">go</span></code> version will continue to prune out that dependency as interpreted under
this proposal: module maintainers will not be forced to break users on new <code class="docutils literal notranslate"><span class="pre">go</span></code>
versions in order to support users on older versions (or vice-versa).</p>
<p>Versions of the <code class="docutils literal notranslate"><span class="pre">go</span></code> command before 1.14 do not preserve the proposed invariants
for the main module: if <code class="docutils literal notranslate"><span class="pre">go</span></code> command from before 1.14 is run in a <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.15</span></code>
module, it may automatically remove requirements that are now needed. However,
as a result of <a class="reference external" href="https://golang.org/cl/204878">CL 204878</a>, <code class="docutils literal notranslate"><span class="pre">go</span></code> version 1.14 does preserve those invariants in
all subcommands except for <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code>: Go 1.14 users will be able to work (in
a limited fashion) within a Go 1.15 main module without disrupting its
invariants.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">bcmills</span></code> is working on a prototype of this design for <code class="docutils literal notranslate"><span class="pre">cmd/go</span></code> in Go 1.15.</p>
<p>At this time, we do not believe that any other tooling changes will be needed.</p>
</div>
<div class="section" id="open-issues">
<h2>Open issues<a class="headerlink" href="#open-issues" title="Permalink to this headline">¶</a></h2>
<p>Because <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">mod</span> <span class="pre">tidy</span></code> will now preserve seemingly-redundant requirements, we may
find that we want to expand or update the <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">indirect</span></code> comments that it
currently manages. For example, we may want to indicate “indirect dependencies
at implied versions” separately from “upgraded or potentially-unused indirect
dependencies”, and we may want to indicate “direct or indirect dependencies of
tests” separately from “direct or indirect dependencies of non-tests”.</p>
<p>Since these comments do not have a semantic effect, we can fine-tune them after
implementation (based on user feedback) without breaking existing modules.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The following examples illustrate the proposed behavior using the <code class="docutils literal notranslate"><span class="pre">cmd/go</span></code>
<a class="reference external" href="https://go.googlesource.com/go/+/refs/heads/master/src/cmd/go/testdata/script/README">script test</a> format. For local testing and exploration, the test files can be
extracted using the <a class="reference external" href="https://pkg.go.dev/golang.org/x/exp/cmd/txtar"><code class="docutils literal notranslate"><span class="pre">txtar</span></code></a> tool.</p>
<div class="section" id="importing-a-new-package-from-an-existing-module-dependency">
<h3>Importing a new package from an existing module dependency<a class="headerlink" href="#importing-a-new-package-from-an-existing-module-dependency" title="Permalink to this headline">¶</a></h3>
<div class="highlight-txtar notranslate"><div class="highlight"><pre><span></span>cp go.mod go.mod.old
go mod tidy
cmp go.mod go.mod.old

# Before adding a new import, the go.mod file should
# enumerate modules for all packages already imported.

go list all
cmp go.mod go.mod.old

# When a new import is found, we should perform a deepening scan of the existing
# dependencies and add a requirement on the version required by those
# dependencies — not re-resolve &#39;latest&#39;.

cp lazy.go.new lazy.go
go list all
cmp go.mod go.mod.new

-- go.mod --
module example.com/lazy

go 1.15

require (
    example.com/a v0.1.0
    example.com/b v0.1.0 // indirect
)

replace (
    example.com/a v0.1.0 =&gt; ./a
    example.com/b v0.1.0 =&gt; ./b
    example.com/c v0.1.0 =&gt; ./c1
    example.com/c v0.2.0 =&gt; ./c2
)
-- lazy.go --
package lazy

import (
    _ &quot;example.com/a/x&quot;
)
-- lazy.go.new --
package lazy

import (
    _ &quot;example.com/a/x&quot;
    _ &quot;example.com/a/y&quot;
)
-- go.mod.new --
module example.com/lazy

go 1.15

require (
    example.com/a v0.1.0
    example.com/b v0.1.0 // indirect
    example.com/c v0.1.0 // indirect
)

replace (
    example.com/a v0.1.0 =&gt; ./a
    example.com/b v0.1.0 =&gt; ./b
    example.com/c v0.1.0 =&gt; ./c1
    example.com/c v0.2.0 =&gt; ./c2
)
-- a/go.mod --
module example.com/a

go 1.15

require (
    example.com/b v0.1.0
    example.com/c v0.1.0
)
-- a/x/x.go --
package x
import _ &quot;example.com/b&quot;
-- a/y/y.go --
package y
import _ &quot;example.com/c&quot;
-- b/go.mod --
module example.com/b

go 1.15
-- b/b.go --
package b
-- c1/go.mod --
module example.com/c

go 1.15
-- c1/c.go --
package c
-- c2/go.mod --
module example.com/c

go 1.15
-- c2/c.go --
package c
</pre></div>
</div>
</div>
<div class="section" id="testing-an-imported-package-found-in-another-module">
<h3>Testing an imported package found in another module<a class="headerlink" href="#testing-an-imported-package-found-in-another-module" title="Permalink to this headline">¶</a></h3>
<div class="highlight-txtar notranslate"><div class="highlight"><pre><span></span>cp go.mod go.mod.old
go mod tidy
cmp go.mod go.mod.old

# &#39;go list -m all&#39; should include modules that cover the test dependencies of
# the packages imported by the main module, found via a deepening scan.

go list -m all
stdout &#39;example.com/b v0.1.0&#39;
! stdout example.com/c
cmp go.mod go.mod.old

# &#39;go test&#39; of any package in &#39;all&#39; should use its existing dependencies without
# updating the go.mod file.

go list all
stdout example.com/a/x

go test example.com/a/x
cmp go.mod go.mod.old

-- go.mod --
module example.com/lazy

go 1.15

require example.com/a v0.1.0

replace (
    example.com/a v0.1.0 =&gt; ./a
    example.com/b v0.1.0 =&gt; ./b1
    example.com/b v0.2.0 =&gt; ./b2
    example.com/c v0.1.0 =&gt; ./c
)
-- lazy.go --
package lazy

import (
    _ &quot;example.com/a/x&quot;
)
-- a/go.mod --
module example.com/a

go 1.15

require example.com/b v0.1.0
-- a/x/x.go --
package x
-- a/x/x_test.go --
package x

import (
    &quot;testing&quot;

    _ &quot;example.com/b&quot;
)

func TestUsingB(t *testing.T) {
    // …
}
-- b1/go.mod --
module example.com/b

go 1.15

require example.com/c v0.1.0
-- b1/b.go --
package b
-- b1/b_test.go --
package b

import _ &quot;example.com/c&quot;
-- b2/go.mod --
module example.com/b

go 1.15

require example.com/c v0.1.0
-- b2/b.go --
package b
-- b2/b_test.go --
package b

import _ &quot;example.com/c&quot;
-- c/go.mod --
module example.com/c

go 1.15
-- c/c.go --
package c
</pre></div>
</div>
</div>
<div class="section" id="testing-an-unimported-package-found-in-an-existing-module-dependency">
<h3>Testing an unimported package found in an existing module dependency<a class="headerlink" href="#testing-an-unimported-package-found-in-an-existing-module-dependency" title="Permalink to this headline">¶</a></h3>
<div class="highlight-txtar notranslate"><div class="highlight"><pre><span></span>cp go.mod go.mod.old
go mod tidy
cmp go.mod go.mod.old

# &#39;go list -m all&#39; should include modules that cover the test dependencies of
# the packages imported by the main module, found via a deepening scan.

go list -m all
stdout &#39;example.com/b v0.1.0&#39;
cmp go.mod go.mod.old

# &#39;go test all&#39; should use those existing dependencies without updating the
# go.mod file.

go test all
cmp go.mod go.mod.old

-- go.mod --
module example.com/lazy

go 1.15

require (
    example.com/a v0.1.0
)

replace (
    example.com/a v0.1.0 =&gt; ./a
    example.com/b v0.1.0 =&gt; ./b1
    example.com/b v0.2.0 =&gt; ./b2
    example.com/c v0.1.0 =&gt; ./c
)
-- lazy.go --
package lazy

import (
    _ &quot;example.com/a/x&quot;
)
-- a/go.mod --
module example.com/a

go 1.15

require (
    example.com/b v0.1.0
)
-- a/x/x.go --
package x
-- a/x/x_test.go --
package x

import _ &quot;example.com/b&quot;

func TestUsingB(t *testing.T) {
    // …
}
-- b1/go.mod --
module example.com/b

go 1.15
-- b1/b.go --
package b
-- b1/b_test.go --
package b

import _ &quot;example.com/c&quot;
-- b2/go.mod --
module example.com/b

go 1.15

require (
    example.com/c v0.1.0
)
-- b2/b.go --
package b
-- b2/b_test.go --
package b

import _ &quot;example.com/c&quot;
-- c/go.mod --
module example.com/c

go 1.15
-- c/c.go --
package c
</pre></div>
</div>
</div>
<div class="section" id="testing-a-package-imported-from-a-go-1-14-dependency">
<h3>Testing a package imported from a <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">1.14</span></code> dependency<a class="headerlink" href="#testing-a-package-imported-from-a-go-1-14-dependency" title="Permalink to this headline">¶</a></h3>
<div class="highlight-txtar notranslate"><div class="highlight"><pre><span></span>cp go.mod go.mod.old
go mod tidy
cmp go.mod go.mod.old

# &#39;go list -m all&#39; should include modules that cover the test dependencies of
# the packages imported by the main module, found via a deepening scan.

go list -m all
stdout &#39;example.com/b v0.1.0&#39;
stdout &#39;example.com/c v0.1.0&#39;
cmp go.mod go.mod.old

# &#39;go test&#39; of any package in &#39;all&#39; should use its existing dependencies without
# updating the go.mod file.
#
# In order to satisfy reproducibility for the loaded packages, the deepening
# scan must follow the transitive module dependencies of &#39;go 1.14&#39; modules.

go list all
stdout example.com/a/x

go test example.com/a/x
cmp go.mod go.mod.old

-- go.mod --
module example.com/lazy

go 1.15

require example.com/a v0.1.0

replace (
    example.com/a v0.1.0 =&gt; ./a
    example.com/b v0.1.0 =&gt; ./b
    example.com/c v0.1.0 =&gt; ./c1
    example.com/c v0.2.0 =&gt; ./c2
)
-- lazy.go --
package lazy

import (
    _ &quot;example.com/a/x&quot;
)
-- a/go.mod --
module example.com/a

go 1.14

require example.com/b v0.1.0
-- a/x/x.go --
package x
-- a/x/x_test.go --
package x

import (
    &quot;testing&quot;

    _ &quot;example.com/b&quot;
)

func TestUsingB(t *testing.T) {
    // …
}
-- b/go.mod --
module example.com/b

go 1.14

require example.com/c v0.1.0
-- b/b.go --
package b

import _ &quot;example.com/c&quot;
-- c1/go.mod --
module example.com/c

go 1.14
-- c1/c.go --
package c
-- c2/go.mod --
module example.com/c

go 1.14
-- c2/c.go --
package c
</pre></div>
</div>
<!-- References --></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="36606-64-bit-field-alignment.html" class="btn btn-neutral float-right" title="Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="35112-scaling-the-page-allocator.html" class="btn btn-neutral float-left" title="Proposal: Scaling the Go page allocator" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>