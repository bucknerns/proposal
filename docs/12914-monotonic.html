

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Proposal: Monotonic Elapsed Time Measurements in Go &mdash; Go Design Proposal  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Proposal: A Code of Conduct for the Go community" href="13073-code-of-conduct.html" />
    <link rel="prev" title="Proposal: Dense mark bits and sweep-free allocation" href="12800-sweep-free-alloc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Go Design Proposal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="11502-securitypolicy.html">Proposal: Security Policy for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="11970-decentralized-gc.html">Proposal: Decentralized GC coordination</a></li>
<li class="toctree-l1"><a class="reference internal" href="12166-subtests.html">Proposal: testing: programmatic sub-test and sub-benchmark support</a></li>
<li class="toctree-l1"><a class="reference internal" href="12302-release-proposal.html">Proposal: A minimal release process for Go repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="12416-cgo-pointers.html">Proposal: Rules for passing pointers between Go and C</a></li>
<li class="toctree-l1"><a class="reference internal" href="12750-localization.html">Proposal: Localization support in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12800-sweep-free-alloc.html">Proposal: Dense mark bits and sweep-free allocation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Proposal: Monotonic Elapsed Time Measurements in Go</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#clocks">Clocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#computer-clocks">Computer clocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#go-time">Go time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#proposal">Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rationale">Rationale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#design">Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simplicity">Simplicity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#compatibility">Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#reading-the-clocks">Reading the clocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-representation">Time representation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#appendix-time-now-usage">Appendix: time.Now usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#unaffected">Unaffected</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-guestbook-guestbook-go-97">github.com/mitchellh/packer/vendor/google.golang.org/appengine/demos/guestbook/guestbook.go:97</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-aws-aws-sdk-go-service-databasemigrationservice-examples-test-go-887">github.com/aws/aws-sdk-go/service/databasemigrationservice/examples_test.go:887</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-94">github.com/influxdata/telegraf/plugins/inputs/mongodb/mongodb_data_test.go:94</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-spf13-fsync-fsync-test-go-23">github.com/spf13/fsync/fsync_test.go:23</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-flynn-flynn-vendor-github-com-gorilla-handlers-handlers-go-66">github.com/flynn/flynn/vendor/github.com/gorilla/handlers/handlers.go:66</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ncw-rclone-vendor-google-golang-org-grpc-server-go-586">github.com/ncw/rclone/vendor/google.golang.org/grpc/server.go:586</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-github-com-influxdata-influxdb-models-points-go-1316">github.com/openshift/origin/vendor/github.com/influxdata/influxdb/models/points.go:1316</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-zyedidia-micro-cmd-micro-util-go">github.com/zyedidia/micro/cmd/micro/util.go</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-gravitational-teleport-lib-auth-init-test-go-59">github.com/gravitational/teleport/lib/auth/init_test.go:59</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-aws-aws-sdk-go-private-model-api-operation-go-420">github.com/aws/aws-sdk-go/private/model/api/operation.go:420</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-17">github.com/influxdata/telegraf/plugins/inputs/mongodb/mongodb_data_test.go:17</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-aws-aws-sdk-go-service-datapipeline-examples-test-go-36">github.com/aws/aws-sdk-go/service/datapipeline/examples_test.go:36</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-jessevdk-go-flags-man-go-177">github.com/jessevdk/go-flags/man.go:177</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k8s-io-heapster-events-manager-manager-test-go-28">k8s.io/heapster/events/manager/manager_test.go:28</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k8s-io-heapster-metrics-storage-podmetrics-reststorage-go-121">k8s.io/heapster/metrics/storage/podmetrics/reststorage.go:121</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-revel-revel-server-go-46">github.com/revel/revel/server.go:46</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-command-agent-agent-go-1426">github.com/hashicorp/consul/command/agent/agent.go:1426</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-drone-drone-server-login-go-143">github.com/drone/drone/server/login.go:143</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-pkg-transport-listener-go-113">github.com/openshift/origin/vendor/github.com/coreos/etcd/pkg/transport/listener.go:113:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ethereum-go-ethereum-swarm-api-http-server-go-189">github.com/ethereum/go-ethereum/swarm/api/http/server.go:189</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-vendor-google-golang-org-grpc-call-go-187">github.com/hashicorp/consul/vendor/google.golang.org/grpc/call.go:187</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-vault-builtin-logical-pki-backend-test-go-396">github.com/hashicorp/vault/builtin/logical/pki/backend_test.go:396</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-plugin-pkg-admission-namespace-lifecycle-admission-test-go-194">github.com/openshift/origin/vendor/k8s.io/kubernetes/plugin/pkg/admission/namespace/lifecycle/admission_test.go:194</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#unaffected-but-uses-time-time-as-wall-time-multiple-times">Unaffected (but uses time.Time as wall time multiple times)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-distribution-registry-storage-driver-inmemory-mfs-go-195">github.com/docker/distribution/registry/storage/driver/inmemory/mfs.go:195</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-minio-minio-cmd-server-startup-msg-test-go-52">github.com/minio/minio/cmd/server-startup-msg_test.go:52</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-pingcap-tidb-expression-builtin-string-test-go-42">github.com/pingcap/tidb/expression/builtin_string_test.go:42</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-docker-vendor-github-com-docker-distribution-registry-client-repository-go-750">github.com/docker/docker/vendor/github.com/docker/distribution/registry/client/repository.go:750</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-pingcap-pd-vendor-vendor-golang-org-x-net-internal-timeseries-timeseries-go-83">github.com/pingcap/pd/_vendor/vendor/golang.org/x/net/internal/timeseries/timeseries.go:83</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-astaxie-beego-logs-logger-test-go-24">github.com/astaxie/beego/logs/logger_test.go:24</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-attic-labs-noms-vendor-github-com-aws-aws-sdk-go-aws-signer-v4-v4-test-go-418">github.com/attic-labs/noms/vendor/github.com/aws/aws-sdk-go/aws/signer/v4/v4_test.go:418</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-zenazn-goji-example-models-go-21">github.com/zenazn/goji/example/models.go:21</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-afex-hystrix-go-hystrix-rolling-rolling-timing-go-77">github.com/afex/hystrix-go/hystrix/rolling/rolling_timing.go:77</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#fixed">Fixed</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-vault-vendor-golang-org-x-net-http2-transport-go-721">github.com/hashicorp/vault/vendor/golang.org/x/net/http2/transport.go:721</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-docker-vendor-github-com-hashicorp-serf-serf-serf-go-1417">github.com/docker/docker/vendor/github.com/hashicorp/serf/serf/serf.go:1417</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-consul-acl-replication-go-173">github.com/hashicorp/consul/consul/acl_replication.go:173</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-flynn-flynn-vendor-gopkg-in-mgo-v2-session-go-3598">github.com/flynn/flynn/vendor/gopkg.in/mgo.v2/session.go:3598</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-huichen-wukong-examples-benchmark-go-173">github.com/huichen/wukong/examples/benchmark.go:173</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ncw-rclone-vendor-google-golang-org-grpc-call-go-171">github.com/ncw/rclone/vendor/google.golang.org/grpc/call.go:171</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-consul-fsm-go-281">github.com/hashicorp/consul/consul/fsm.go:281</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-libnetwork-vendor-github-com-sirupsen-logrus-text-formatter-go-27">github.com/docker/libnetwork/vendor/github.com/Sirupsen/logrus/text_formatter.go:27</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-flynn-flynn-vendor-golang-org-x-net-http2-go17-go-54">github.com/flynn/flynn/vendor/golang.org/x/net/http2/go17.go:54</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-zyedidia-micro-cmd-micro-eventhandler-go-102">github.com/zyedidia/micro/cmd/micro/eventhandler.go:102</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-186">github.com/ethereum/go-ethereum/cmd/geth/chaincmd.go:186</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-drone-drone-shared-oauth2-oauth2-go-176">github.com/drone/drone/shared/oauth2/oauth2.go:176</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-coreos-etcd-auth-simple-token-go-88">github.com/coreos/etcd/auth/simple_token.go:88</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-docker-cli-command-node-ps-test-go-105">github.com/docker/docker/cli/command/node/ps_test.go:105</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-docker-integration-cli-docker-api-attach-test-go-130">github.com/docker/docker/integration-cli/docker_api_attach_test.go:130</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-test-e2e-framework-util-go-1696">github.com/openshift/origin/vendor/k8s.io/kubernetes/test/e2e/framework/util.go:1696</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-onsi-gomega-internal-asyncassertion-async-assertion-test-go-318">github.com/onsi/gomega/internal/asyncassertion/async_assertion_test.go:318</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-vault-physical-consul-go-344">github.com/hashicorp/vault/physical/consul.go:344</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hyperledger-fabric-vendor-golang-org-x-net-context-go17-go-62">github.com/hyperledger/fabric/vendor/golang.org/x/net/context/go17.go:62</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-consul-state-tombstone-gc-go-134">github.com/hashicorp/consul/consul/state/tombstone_gc.go:134</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-storage-etcd-etcd-helper-go-310">github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/storage/etcd/etcd_helper.go:310</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-pingcap-pd-server-util-go-215">github.com/pingcap/pd/server/util.go:215</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-kuberuntime-instrumented-services-go-235">github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubelet/kuberuntime/instrumented_services.go:235</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-dockertools-instrumented-docker-go-58">github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubelet/dockertools/instrumented_docker.go:58</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-coreos-etcd-tools-functional-tester-etcd-runner-command-global-go-103">github.com/coreos/etcd/tools/functional-tester/etcd-runner/command/global.go:103</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-reducedb-encoding-benchtools-benchtools-go-98">github.com/reducedb/encoding/benchtools/benchtools.go:98</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-swarm-vendor-github-com-hashicorp-consul-api-semaphore-go-200">github.com/docker/swarm/vendor/github.com/hashicorp/consul/api/semaphore.go:200</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-gravitational-teleport-lib-reversetunnel-localsite-go-83">github.com/gravitational/teleport/lib/reversetunnel/localsite.go:83</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-coreos-etcd-tools-benchmark-cmd-watch-go-201">github.com/coreos/etcd/tools/benchmark/cmd/watch.go:201</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-flynn-flynn-vendor-github-com-flynn-oauth2-internal-token-go-191">github.com/flynn/flynn/vendor/github.com/flynn/oauth2/internal/token.go:191</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-consul-fsm-go-266">github.com/hashicorp/consul/consul/fsm.go:266</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-clientv3-lease-go-437">github.com/openshift/origin/vendor/github.com/coreos/etcd/clientv3/lease.go:437</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ebay-fabio-cert-source-test-go-567">github.com/eBay/fabio/cert/source_test.go:567</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-lucas-clemente-quic-go-ackhandler-sent-packet-handler-test-go-524">github.com/lucas-clemente/quic-go/ackhandler/sent_packet_handler_test.go:524</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-codislabs-codis-pkg-proxy-redis-conn-go-140">github.com/CodisLabs/codis/pkg/proxy/redis/conn.go:140</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-docker-docker-vendor-github-com-docker-swarmkit-manager-scheduler-scheduler-go-173">github.com/docker/docker/vendor/github.com/docker/swarmkit/manager/scheduler/scheduler.go:173</a></li>
<li class="toctree-l3"><a class="reference internal" href="#golang-org-x-net-nettest-conntest-go-361">golang.org/x/net/nettest/conntest.go:361</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-minio-minio-vendor-github-com-eapache-go-resiliency-breaker-breaker-go-120">github.com/minio/minio/vendor/github.com/eapache/go-resiliency/breaker/breaker.go:120</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-pingcap-tidb-store-tikv-client-go-65">github.com/pingcap/tidb/store/tikv/client.go:65</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-coreos-etcd-cmd-vendor-golang-org-x-net-context-go17-go-62">github.com/coreos/etcd/cmd/vendor/golang.org/x/net/context/go17.go:62</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-coreos-rkt-rkt-image-common-test-go-161">github.com/coreos/rkt/rkt/image/common_test.go:161</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-lucas-clemente-quic-go-flowcontrol-flow-controller-go-131">github.com/lucas-clemente/quic-go/flowcontrol/flow_controller.go:131</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-serf-serf-snapshot-go-327">github.com/hashicorp/serf/serf/snapshot.go:327</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-junegunn-fzf-src-matcher-go-210">github.com/junegunn/fzf/src/matcher.go:210</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-helloworld-helloworld-go-19">github.com/mitchellh/packer/vendor/google.golang.org/appengine/demos/helloworld/helloworld.go:19</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ncw-rclone-vendor-google-golang-org-appengine-internal-api-go-549">github.com/ncw/rclone/vendor/google.golang.org/appengine/internal/api.go:549</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-159">github.com/ethereum/go-ethereum/cmd/geth/chaincmd.go:159</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-nats-io-nats-test-conn-test-go-652">github.com/nats-io/nats/test/conn_test.go:652</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-google-cadvisor-manager-container-go-456">github.com/google/cadvisor/manager/container.go:456</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-google-cadvisor-vendor-golang-org-x-oauth2-token-go-98">github.com/google/cadvisor/vendor/golang.org/x/oauth2/token.go:98</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-consul-consul-fsm-go-109">github.com/hashicorp/consul/consul/fsm.go:109</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-hashicorp-vault-vendor-github-com-hashicorp-yamux-session-go-295">github.com/hashicorp/vault/vendor/github.com/hashicorp/yamux/session.go:295</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-go-kit-kit-examples-shipping-booking-instrumenting-go-31">github.com/go-kit/kit/examples/shipping/booking/instrumenting.go:31</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-cyfdecyf-cow-timeoutset-go-22">github.com/cyfdecyf/cow/timeoutset.go:22</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-prometheus-prometheus-vendor-k8s-io-client-go-1-5-rest-request-go-761">github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/rest/request.go:761</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-ethereum-go-ethereum-p2p-discover-udp-go-383">github.com/ethereum/go-ethereum/p2p/discover/udp.go:383</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k8s-io-heapster-metrics-sinks-manager-go-150">k8s.io/heapster/metrics/sinks/manager.go:150</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-vmware-harbor-src-ui-auth-lock-go-43">github.com/vmware/harbor/src/ui/auth/lock.go:43</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubectl-resource-printer-test-go-1410">github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubectl/resource_printer_test.go:1410</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-pingcap-pd-server-kv-go-194">github.com/pingcap/pd/server/kv.go:194</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-xtaci-kcp-go-sess-go-489">github.com/xtaci/kcp-go/sess.go:489</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-go-xorm-xorm-lru-cacher-go-202">github.com/go-xorm/xorm/lru_cacher.go:202</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-github-com-samuel-go-zookeeper-zk-conn-go-510">github.com/openshift/origin/vendor/github.com/samuel/go-zookeeper/zk/conn.go:510</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-client-leaderelection-leaderelection-go-236">github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/client/leaderelection/leaderelection.go:236</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k8s-io-heapster-events-sinks-manager-go-139">k8s.io/heapster/events/sinks/manager.go:139</a></li>
<li class="toctree-l3"><a class="reference internal" href="#golang-org-x-net-ipv4-unicast-test-go-64">golang.org/x/net/ipv4/unicast_test.go:64</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-kelseyhightower-confd-vendor-github-com-sirupsen-logrus-text-formatter-go-27">github.com/kelseyhightower/confd/vendor/github.com/Sirupsen/logrus/text_formatter.go:27</a></li>
<li class="toctree-l3"><a class="reference internal" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-etcdserver-v3-server-go-693">github.com/openshift/origin/vendor/github.com/coreos/etcd/etcdserver/v3_server.go:693</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="13073-code-of-conduct.html">Proposal: A Code of Conduct for the Go community</a></li>
<li class="toctree-l1"><a class="reference internal" href="13432-mobile-audio.html">Proposal: Audio for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="13504-natural-xml.html">Proposal: Natural XML</a></li>
<li class="toctree-l1"><a class="reference internal" href="14313-benchmark-format.html">Proposal: Go Benchmark Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="14386-zip-package-archives.html">Proposal: Zip-based Go package archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="14951-soft-heap-limit.html">Proposal: Separate soft and hard heap size goal</a></li>
<li class="toctree-l1"><a class="reference internal" href="15292-generics.html">Proposal: Go should have generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="16085-conversions-ignore-tags.html">Proposal: Ignore tags in struct type conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html">Proposal: Alias declarations for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html#appendix">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="16410-heap-viewer.html">Proposal: Go Heap Dump Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="16704-cidr-notation-no-proxy.html">Proposal: Add support for CIDR notation in no_proxy variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="17280-profile-labels.html">Proposal: Support for pprof profiler labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="17503-eliminate-rescan.html">Proposal: Eliminate STW stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="17505-concurrent-rescan.html">Proposal: Concurrent stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="18130-type-alias.html">Proposal: Type Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html">Proposal: percpu.Sharded, an API for reducing cache contention</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#discussion">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#backwards-compatibility">Backwards compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19113-signed-shift-counts.html">Proposal: Permit Signed Integers as Shift Counts for Go 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="19308-number-literals.html">Proposal: Go 2 Number Literal Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html">Proposal: Mid-stack inlining in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#proposal">Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#rationale">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="19480-xml-stream.html">Proposal: XML Stream</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html">Proposal: emit DWARF inlining info in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#example">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#how-the-generated-dwarf-should-look">How the generated DWARF should look</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#outline-of-proposed-changes">Outline of proposed changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="24301-versioned-go.html">Proposal: Versioned Go Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="24543-non-cooperative-preemption.html">Proposal: Non-cooperative goroutine preemption</a></li>
<li class="toctree-l1"><a class="reference internal" href="25530-sumdb.html">Proposal: Secure the Public Go Module Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="25719-go15vendor.html">Go 1.5 Vendor Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="26160-dns-based-vanity-imports.html">Proposal: DNS Based Vanity Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="26756-rawxml-token.html">Proposal: Raw XML Token</a></li>
<li class="toctree-l1"><a class="reference internal" href="26903-simplify-mark-termination.html">Proposal: Simplify mark termination and eliminate mark 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="27539-internal-abi.html">Proposal: Create an undefined internal calling convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="2775-binary-only-packages.html">Proposal: Binary-Only Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="27935-unbounded-queue-package.html">Proposal: Built in support for high performance unbounded queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="28221-go2-transitions.html">Proposal: Go 2 transition</a></li>
<li class="toctree-l1"><a class="reference internal" href="2981-go-test-json.html">Proposal: <code class="docutils literal notranslate"><span class="pre">-json</span></code> flag in <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="29934-error-values.html">Proposal: Go 2 Error Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="30333-smarter-scavenging.html">Proposal: Smarter Scavenging</a></li>
<li class="toctree-l1"><a class="reference internal" href="30411-env.html">Proposal: <code class="docutils literal notranslate"><span class="pre">go</span></code> command configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="32437-try-builtin.html">Proposal: A built-in Go error check function, <code class="docutils literal notranslate"><span class="pre">try</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="33974-add-public-lockedfile-pkg.html">Proposal: make the internal lockedfile package public</a></li>
<li class="toctree-l1"><a class="reference internal" href="34481-opencoded-defers.html">Proposal: Low-cost defers through inline code, and extra funcdata to manage the panic case</a></li>
<li class="toctree-l1"><a class="reference internal" href="35112-scaling-the-page-allocator.html">Proposal: Scaling the Go page allocator</a></li>
<li class="toctree-l1"><a class="reference internal" href="36460-lazy-module-loading.html">Proposal: Lazy Module Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="36606-64-bit-field-alignment.html">Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="37112-unstable-runtime-metrics.html">Proposal: API for unstable runtime metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="37720-gopls-workspaces.html">Proposal: Multi-project gopls workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="4899-testing-helper.html">Proposal: testing: better support test helper functions with TB.Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="6282-table-data.html">Proposal: Multi-dimensional slices</a></li>
<li class="toctree-l1"><a class="reference internal" href="6977-overlapping-interfaces.html">Proposal: Permit embedding of interfaces with overlapping method sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="TEMPLATE.html">Proposal: [Title]</a></li>
<li class="toctree-l1"><a class="reference internal" href="cryptography-principles.html">Cryptography Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft.html">Go 2 Draft Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-contracts.html">Contracts — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling.html">Error Handling — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling-overview.html">Error Handling — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-inspection.html">Error Inspection — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-printing.html">Error Printing — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-values-overview.html">Error Values — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-generics-overview.html">Generics — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-type-parameters.html">Type Parameters - Draft Design</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Go Design Proposal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Proposal: Monotonic Elapsed Time Measurements in Go</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/12914-monotonic.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="proposal-monotonic-elapsed-time-measurements-in-go">
<h1>Proposal: Monotonic Elapsed Time Measurements in Go<a class="headerlink" href="#proposal-monotonic-elapsed-time-measurements-in-go" title="Permalink to this headline">¶</a></h1>
<p>Author: Russ Cox</p>
<p>Last updated: January 26, 2017<br>
Discussion: <a class="reference external" href="https://golang.org/issue/12914">https://golang.org/issue/12914</a>.<br>
URL: https://golang.org/design/12914-monotonic</p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Comparison and subtraction of times observed by <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> can return incorrect
results if the system wall clock is reset between the two observations.
We propose to extend the <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> representation to hold an
additional monotonic clock reading for use in those calculations.
Among other benefits, this should make it impossible for a basic elapsed time
measurement using <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> and <code class="docutils literal notranslate"><span class="pre">time.Since</span></code> to report a negative duration
or other result not grounded in reality.</p>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="clocks">
<h3>Clocks<a class="headerlink" href="#clocks" title="Permalink to this headline">¶</a></h3>
<p>A clock never keeps perfect time.
Eventually, someone notices,
decides the accumulated error—compared to a reference clock deemed more reliable—is
large enough to be worth fixing,
and resets the clock to match the reference.
As I write this, the watch on my wrist is 44 seconds ahead of the clock on my computer.
Compared to the computer, my watch gains about five seconds a day.
In a few days I will probably be bothered enough to reset it to match the computer.</p>
<p>My watch may not be perfect for identifying the precise
moment when a meeting should begin,
but it’s quite good for measuring elapsed time.
If I start timing an event by checking the time,
and then I stop timing the event by checking again
and subtracting the two times,
the error contributed by the watch speed
will be under 0.01%.</p>
<p>Resetting a clock makes it better for telling time
but useless, in that moment, for measuring time.
If I reset my watch to match my computer while I am timing an event,
the time of day it shows is now more accurate,
but subtracting the start and end times for the event
will produce a measurement that includes the reset.
If I turn my watch back 44 seconds
while timing a 60-second event, I would
(unless I correct for the reset)
measure the event as taking 16 seconds.
Worse, I could measure a 10-second event
as taking −34 seconds, ending before it began.</p>
<p>Since I know the watch is consistently
gaining five seconds per day,
I could reduce the need for resets
by taking it to a watchmaker to adjust the
mechanism to tick ever so slightly slower.
I could also reduce the size of the resets
by doing them more often.
If, five times a day at regular intervals,
I stopped my watch for one second,
I wouldn’t ever need a 44-second reset,
reducing the maximum possible error
introduced in the timing of an event.
Similarly, if instead my watch lost five seconds each day,
I could turn it forward one second five times a day
to avoid larger forward resets.</p>
</div>
<div class="section" id="computer-clocks">
<h3>Computer clocks<a class="headerlink" href="#computer-clocks" title="Permalink to this headline">¶</a></h3>
<p>All the same problems affect computer clocks,
usually with smaller time units.</p>
<p>Most computers have some kind of
high-precision clock and a way to convert ticks of that clock
to an equivalent number of seconds.
Often, software on the computer compares that
clock to a higher-accuracy reference clock
<a class="reference external" href="https://tools.ietf.org/html/rfc5905">accessed over the network</a>.
If the local clock is observed to be
slightly ahead, it can be slowed a little
by dropping an occasional tick;
if slightly behind, sped up by counting some ticks twice.
If the local clock is observed to run at a
consistent speed relative to the reference clock
(for example, five seconds fast per day),
the software can change the conversion formula,
making the slight corrections less frequent.
These minor adjustments, applied regularly,
can keep the local clock matched to the reference clock
without observable resets,
giving the outward appearance of a perfectly synchronized clock.</p>
<p>Unfortunately, many systems fall short of this
appearance of perfection, for two main reasons.</p>
<p>First, some computer clocks are unreliable or
don’t run at all when the computer is off.
The time starts out very wrong.
After learning the correct time from the network,
the only correction option is a reset.</p>
<p>Second, most computer time representations ignore leap seconds,
in part because leap seconds—unlike leap years—follow no predictable pattern:
the <a class="reference external" href="https://en.wikipedia.org/wiki/Leap_second">IERS decides about six months in advance</a>
whether to insert (or in theory remove)
a leap second at the end of a particular calendar month.
In the real world, the leap second 23:59:60 UTC is inserted
between 23:59:59 UTC and 00:00:00 UTC.
Most computers, unable to represent 23:59:60,
instead insert a clock reset and repeat 23:59:59.</p>
<p>Just like my watch,
resetting a computer clock makes it better for telling time
but useless, in that moment, for measuring time.
Entering a leap second,
the clock might report 23:59:59.995 at one instant
and then report 23:59:59.005 ten milliseconds later;
subtracting these to compute elapsed time results in
−990 ms instead of +10 ms.</p>
<p>To avoid the problem of measuring elapsed times across clock resets,
operating systems provide access to two different clocks:
a wall clock and a monotonic clock.
Both are adjusted to move forward at a target rate of one clock second per real second,
but the monotonic clock starts at an undefined absolute value and is never reset.
The wall clock is for telling time;
the monotonic clock is for measuring time.</p>
<p>C/C++ programs use the operating system-provided mechanisms
for querying one clock or the other.
Java’s <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#nanoTime--"><code class="docutils literal notranslate"><span class="pre">System.nanoTime</span></code></a>
is widely believed to read a monotonic clock where available,
returning an int64 counting nanoseconds since an arbitrary start point.
Python 3.3 added monotonic clock support in <a class="reference external" href="https://www.python.org/dev/peps/pep-0418/">PEP 418</a>.
The new function <code class="docutils literal notranslate"><span class="pre">time.monotonic</span></code> reads the monotonic clock, returning a float64 counting seconds since
an arbitrary start point; the old function <code class="docutils literal notranslate"><span class="pre">time.time</span></code> reads the system wall clock,
returning a float64 counting seconds since 1970.</p>
</div>
<div class="section" id="go-time">
<h3>Go time<a class="headerlink" href="#go-time" title="Permalink to this headline">¶</a></h3>
<p>Go’s current <a class="reference external" href="https://golang.org/pkg/time/">time API</a>,
which Rob Pike and I designed in 2011,
defines an opaque type <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>,
a function <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> that returns the current time,
and a method <code class="docutils literal notranslate"><span class="pre">t.Sub(u)</span></code> to subtract two times,
along with other methods interpreting a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> as a wall clock time.
These are widely used by Go programs to measure elapsed times.
The implementation of these functions only reads the system wall clock,
never the monotonic clock,
making the measurements incorrect in the event of clock resets.</p>
<p>Go’s original target was Google’s production servers, on which
the wall clock never resets: the time is set very early in
system startup, before any Go software runs,
and leap seconds are handled by a <a class="reference external" href="https://developers.google.com/time/smear#standardsmear">leap smear</a>,
spreading the extra second
over a 20-hour window in which the clock runs at 99.9986% speed
(20 hours on that clock corresponds to 20 hours and one second
in the real world).
In 2011, I hoped that the trend toward reliable, reset-free computer clocks
would continue and that Go programs could safely use the system wall clock
to measure elapsed times.
I was wrong.
Although Akamai, Amazon, and Microsoft use leap smears now too,
many systems still implement leap seconds by clock reset.
A Go program measuring a negative elapsed time during a leap second
caused <a class="reference external" href="https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/">CloudFlare’s recent DNS outage</a>.
Wikipedia’s
<a class="reference external" href="https://en.wikipedia.org/wiki/Leap_second#Examples_of_problems_associated_with_the_leap_second">list of examples of problems associated with the leap second</a>
now includes CloudFlare’s outage and
notes Go’s time APIs as the root cause.
Beyond the problem of leap seconds, Go has also expanded to systems
in non-production environments
that may have less well-regulated clocks and consequently
more frequent clock resets.
Go must handle clock resets gracefully.</p>
<p>The internals of both the Go runtime and the Go time package
originally used wall time but have already been converted as much as possible
(without changing exported APIs)
to use the monotonic clock.
For example, if a goroutine runs <code class="docutils literal notranslate"><span class="pre">time.Sleep(1*time.Minute)</span></code> and then
the wall clock resets backward one hour,
in the original Go implementation that goroutine would have slept for
61 real minutes.
Today, that goroutine always sleeps for only 1 real minute.
All other time APIs using <code class="docutils literal notranslate"><span class="pre">time.Duration</span></code>, such as
<code class="docutils literal notranslate"><span class="pre">time.After</span></code>, <code class="docutils literal notranslate"><span class="pre">time.Tick</span></code>, and <code class="docutils literal notranslate"><span class="pre">time.NewTimer</span></code>,
have similarly been converted to implement those durations
using the monotonic clock.</p>
<p>Three standard Go APIs remain that use the system wall clock that should
more properly use the monotonic clock.
Due to <a class="reference external" href="https://golang.org/doc/go1compat">Go 1 compatibility</a>,
the types and method names used in the APIs cannot be changed.</p>
<p>The first problematic Go API is measurement of elapsed times.
Much code exists that uses patterns like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="n">something</span> <span class="o">...</span>
<span class="n">end</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">elapsed</span> <span class="o">:=</span> <span class="n">start</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
<p>or, equivalently:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="n">something</span> <span class="o">...</span>
<span class="n">elapsed</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>Because today <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> reads the wall clock,
those measurements are wrong if the wall clock resets
between calls,
as happened at CloudFlare.</p>
<p>The second problematic Go API is network connection timeouts.
Originally, the <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code> interface included methods to set timeouts in terms of durations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Conn</span> <span class="n">interface</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">SetTimeout</span><span class="p">(</span><span class="n">d</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span>
	<span class="n">SetReadTimeout</span><span class="p">(</span><span class="n">d</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span>
	<span class="n">SetWriteTimeout</span><span class="p">(</span><span class="n">d</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This API confused users: it wasn’t clear whether the duration measurement began
when the timeout was set or began anew at each I/O operation.
That is, if you call <code class="docutils literal notranslate"><span class="pre">SetReadTimeout(100*time.Millisecond)</span></code>,
does every <code class="docutils literal notranslate"><span class="pre">Read</span></code> call wait 100ms before timing out,
or do all <code class="docutils literal notranslate"><span class="pre">Read</span></code>s simply stop working 100ms after the call to <code class="docutils literal notranslate"><span class="pre">SetReadTimeout</span></code>?
To avoid this confusion, we changed and renamed the APIs for Go 1 to use
deadlines represented as <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>s:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Conn</span> <span class="n">interface</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">SetDeadline</span><span class="p">(</span><span class="n">t</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
	<span class="n">SetReadDeadline</span><span class="p">(</span><span class="n">t</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
	<span class="n">SetWriteDeadline</span><span class="p">(</span><span class="n">t</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These are almost always invoked by adding a duration to the current time, as in
<code class="docutils literal notranslate"><span class="pre">c.SetDeadline(time.Now().Add(5*time.Second))</span></code>,
which is longer but clearer than <code class="docutils literal notranslate"><span class="pre">SetTimeout(5*time.Second)</span></code>.</p>
<p>Internally, the standard implementations of <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code> implement
deadlines by converting the wall clock time to monotonic clock time
immediately.
In the call <code class="docutils literal notranslate"><span class="pre">c.SetDeadline(time.Now().Add(5*time.Second))</span></code>,
the deadline exists in wall clock form only for the hundreds of nanoseconds
between adding the current wall clock time while preparing the argument
and subtracting it again at the start of <code class="docutils literal notranslate"><span class="pre">SetDeadline</span></code>.
Even so, if the system wall clock resets
during that tiny window, the deadline will be extended or contracted
by the reset amount,
resulting in possible hangs or spurious timeouts.</p>
<p>The third problematic Go API is <a class="reference external" href="https://golang.org/pkg/context/#Context">context deadlines</a>.
The <code class="docutils literal notranslate"><span class="pre">context.Context</span></code> interface defines a method that returns a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Context</span> <span class="n">interface</span> <span class="p">{</span>
	<span class="n">Deadline</span><span class="p">()</span> <span class="p">(</span><span class="n">deadline</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">ok</span> <span class="nb">bool</span><span class="p">)</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Context uses a time instead of a duration for much the same
reasons as <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code>: the returned deadline
may be stored and consulted occasionally,
and using a fixed <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> makes those later
consultations refer to a fixed instant instead of a floating one.</p>
<p>In addition to these three standard APIs, there are any number of
APIs outside the standard library that also use <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>s in similar ways.
For example a common metrics collection package encourages
users to time functions by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p>It seems clear that Go must better support
computations involving elapsed times, including checking deadlines:
wall clocks do reset and cause problems on systems where Go runs.</p>
<p>A survey of existing Go usage suggests that about 30%
of the calls to <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> (by source code appearance, not dynamic call count)
are used for measuring elapsed time and should use the system monotonic clock.
Identifying and fixing all of these would be a large undertaking,
as would developer education to correct future uses.</p>
</div>
</div>
<div class="section" id="proposal">
<h2>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">¶</a></h2>
<p>For both backwards compatibility and API simplicity,
we propose not to introduce
any new API in the time package exposing the idea of monotonic clocks.</p>
<p>Instead, we propose to change <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> to store both a wall clock reading
and an optional, additional monotonic clock reading;
to change <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> to read both clocks and return a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> containing both readings;
to change <code class="docutils literal notranslate"><span class="pre">t.Add(d)</span></code> to return a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> in which both readings (if present)
have been adjusted by <code class="docutils literal notranslate"><span class="pre">d</span></code>;
and to change <code class="docutils literal notranslate"><span class="pre">t.Sub(u)</span></code> to operate on monotonic clock times
when both <code class="docutils literal notranslate"><span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">u</span></code> have them.
In this way, developers keep using <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> always,
leaving the implementation to follow the rule:
use the wall clock for telling time, the monotonic clock for measuring time.</p>
<p>More specifically, we propose to make these changes to the <a class="reference external" href="https://golang.org/pkg/time/">package time documentation</a>,
along with corresponding changes to the implementation.</p>
<p>Add this paragraph to the end of the <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> documentation:</p>
<blockquote>
<div><p>In addition to the required “wall clock” reading, a Time may contain an
optional reading of the current process’s monotonic clock,
to provide additional precision for comparison or subtraction.
See the “Monotonic Clocks” section in the package documentation
for details.</p>
</div></blockquote>
<p>Add this section to the end of the package documentation:</p>
<blockquote>
<div><p>Monotonic Clocks</p>
<p>Operating systems provide both a “wall clock,” which is subject
to resets for clock synchronization, and a “monotonic clock,” which is not.
The general rule is that the wall clock is for telling time and the
monotonic clock is for measuring time.
Rather than split the API, in this package the Time returned by time.Now
contains both a wall clock reading and a monotonic clock reading;
later time-telling operations use the wall clock reading,
but later time-measuring operations, specifically comparisons
and subtractions, use the monotonic clock reading.</p>
<p>For example, this code always computes a positive elapsed time of
approximately 20 milliseconds, even if the wall clock is reset
during the operation being timed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="n">operation</span> <span class="n">that</span> <span class="n">takes</span> <span class="mi">20</span> <span class="n">milliseconds</span> <span class="o">...</span>
<span class="n">t</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">elapsed</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>Other idioms, such as time.Since(start), time.Until(deadline),
and time.Now().Before(deadline), are similarly robust against
wall clock resets.</p>
<p>The rest of this section gives the precise details of how operations
use monotonic clocks, but understanding those details is not required
to use this package.</p>
<p>The Time returned by time.Now contains a monotonic clock reading.
If Time t has a monotonic clock reading, t.Add(d), t.Round(d),
or t.Truncate(d) adds the same duration to both the wall clock
and monotonic clock readings to compute the result.
Similarly, t.In(loc), t.Local(), or t.UTC(), which are defined to change
only the Time’s Location, pass any monotonic clock reading
through unmodified.
Because t.AddDate(y, m, d) is a wall time computation,
it always strips any monotonic clock reading from its result.</p>
<p>If Times t and u both contain monotonic clock readings, the operations
t.After(u), t.Before(u), t.Equal(u), and t.Sub(u) are carried out using
the monotonic clock readings alone, ignoring the wall clock readings.
(If either t or u contains no monotonic clock reading, these operations
use the wall clock readings.)</p>
<p>Note that the Go == operator includes the monotonic clock reading in its comparison.
If time values returned from time.Now and time values constructed by other means
(for example, by time.Parse or time.Unix) are meant to compare equal when used
as map keys, the times returned by time.Now must have the monotonic clock
reading stripped, by setting t = t.AddDate(0, 0, 0).
In general, prefer t.Equal(u) to t == u, since t.Equal uses the most accurate
comparison available and correctly handles the case when only one of its
arguments has a monotonic clock reading.</p>
</div></blockquote>
</div>
<div class="section" id="rationale">
<h2>Rationale<a class="headerlink" href="#rationale" title="Permalink to this headline">¶</a></h2>
<div class="section" id="design">
<h3>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h3>
<p>The main design question is whether to overload <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>
or to provide a separate API for accessing the monotonic clock.</p>
<p>Most other systems provide separate APIs to read the wall clock
and the monotonic clock, leaving the developer to decide
between them at each use, hopefully by applying the rule stated above:
“The wall clock is for telling time.
The monotonic clock is for measuring time.”</p>
<p>if a developer uses a wall clock to measure time,
that program will work correctly, almost always,
except in the rare event of a clock reset.
Providing two APIs that behave the same 99% of the time
makes it very easy (and likely) for a developer to write
a program that fails only rarely and not notice.</p>
<p>It gets worse.
The program failures aren’t random, like a race condition:
they’re caused by external events, namely clock resets.
The most common clock reset in a well-run production setting
is the leap second, which occurs simultaneously on all systems.
When it does, all the copies of the program
across the entire distributed system fail simultaneously,
defeating any redundancy the system might have had.</p>
<p>So providing two APIs makes it very easy (and likely)
for a developer to write programs that fail only rarely,
but typically all at the same time.</p>
<p>This proposal instead treats the monotonic clock not as
a new concept for developers to learn but instead as an
implementation detail that can improve the accuracy of
measuring time with the existing API.
Developers don’t need to learn anything new,
and the obvious code just works.
The implementation applies the rule;
the developer doesn’t have to think about it.</p>
<p>As noted earlier,
a survey of existing Go usage (see Appendix below)
suggests that about 30% of calls to <code class="docutils literal notranslate"><span class="pre">time.Now</span></code>
are used for measuring elapsed time and should use a monotonic clock.
The same survey shows that all of those calls
are fixed by this proposal, with no change in the programs themselves.</p>
</div>
<div class="section" id="simplicity">
<h3>Simplicity<a class="headerlink" href="#simplicity" title="Permalink to this headline">¶</a></h3>
<p>It is certainly simpler, in terms of implementation,
to provide separate routines to read the wall clock and
the monotonic clock and leave proper usage to developers.
The API in this proposal is a bit more complex to specify
and to implement but much simpler for developers to use.</p>
<p>No matter what, the effects of clock resets, especially leap seconds,
can be counterintuitive.</p>
<p>Suppose a program starts just before a leap second:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">t2</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">t3</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">const</span> <span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;15:04:05.000&quot;</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">t2</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span> <span class="n">t2</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">t3</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t2</span><span class="p">),</span> <span class="n">t3</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
<p>In Go 1.8, the program can print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.985</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.995</span> <span class="o">-</span><span class="mi">990</span><span class="n">ms</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.005</span>
</pre></div>
</div>
<p>In the design proposed above, the program instead prints:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.985</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.995</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">59.005</span>
</pre></div>
</div>
<p>Although in both cases the second elapsed time requires some explanation,
I’d rather explain 10ms than −990ms.
Most importantly, the actual time elapsed between the t2 and t3 calls to <code class="docutils literal notranslate"><span class="pre">time.Now</span></code>
really is 10 milliseconds.</p>
<p>In this case, 23:59:59.005 minus 23:59:59.995 can be 10 milliseconds,
even though the printed times would suggest −990ms,
because the printed time is incomplete.</p>
<p>The printed time is incomplete in other settings too.
Suppose a program starts just before noon, printing only hours and minutes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">t2</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">t3</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span> <span class="mi">10</span> <span class="n">ms</span> <span class="n">of</span> <span class="n">work</span>
<span class="n">const</span> <span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;15:04&quot;</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">t2</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t1</span><span class="p">),</span> <span class="n">t2</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">t3</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t2</span><span class="p">),</span> <span class="n">t3</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
<p>In Go 1.8, the program can print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">11</span><span class="p">:</span><span class="mi">59</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">11</span><span class="p">:</span><span class="mi">59</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">12</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
<p>This is easily understood, even though the printed times indicate durations of 0 and 1 minute.
The printed time is incomplete: it omits second and subsecond resolution.</p>
<p>Suppose instead that the program starts just before a 1am daylight savings shift.
In Go 1.8, the program can print:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">00</span><span class="p">:</span><span class="mi">59</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">00</span><span class="p">:</span><span class="mi">59</span> <span class="mi">10</span><span class="n">ms</span> <span class="mi">02</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
<p>This too is easily understood, even though the printed times indicate durations of 0 and 61 minutes.
The printed time is incomplete: it omits the time zone.</p>
<p>In the original example, printing 10ms instead of −990ms.
The printed time is incomplete: it omits clock resets.</p>
<p>The Go 1.8 time representation makes correct time calculations across time zone changes
by storing a time unaffected by time zone changes,
along with additional information used for printing the time.
Similarly, the proposed new time representation makes correct time calculations across clock resets
by storing a time unaffected by clock resets (the monotonic clock reading),
along with additional information used for printing the time (the wall clock reading).</p>
</div>
</div>
<div class="section" id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://golang.org/doc/go1compat">Go 1 compatibility</a>
keeps us from changing any of the types in the APIs mentioned above.
In particular, <code class="docutils literal notranslate"><span class="pre">net.Conn</span></code>’s <code class="docutils literal notranslate"><span class="pre">SetDeadline</span></code> method must continue to
take a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code>, and <code class="docutils literal notranslate"><span class="pre">context.Context</span></code>’s <code class="docutils literal notranslate"><span class="pre">Deadline</span></code> method
must continue to return one.
We arrived at the current proposal due to these compatibility
constraints, but as explained in the Rationale above,
it may actually be the best choice anyway.</p>
<p>Also mentioned above,
about 30% of calls to <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> are used for measuring elapsed time
and would be affected by this proposal.
In every case we’ve examined (see Appendix below), the effect is to eliminate
the possibility of incorrect measurement results due to clock resets.
We have found no existing Go code that is broken by
the improved measurements.</p>
<p>If the proposal is adopted, the implementation should be landed at the
start of a <a class="reference external" href="https://golang.org/wiki/Go-Release-Cycle">release cycle</a>,
to maximize the time in which to find unexpected compatibility problems.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>The implementation work in package time is fairly straightforward,
since the runtime has already worked out access to the monotonic clock on
(nearly) all supported operating systems.</p>
<div class="section" id="reading-the-clocks">
<h3>Reading the clocks<a class="headerlink" href="#reading-the-clocks" title="Permalink to this headline">¶</a></h3>
<p><strong>Precision</strong>:
In general, operating systems provide different system operations to read the
wall clock and the monotonic clock, so the
implementation of <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> must read both in sequence.
Time will advance between the calls, with the effect that even in the absence of
clock resets, <code class="docutils literal notranslate"><span class="pre">t.Sub(u)</span></code> (using monotonic clock readings) and <code class="docutils literal notranslate"><span class="pre">t.AddDate(0,0,0).Sub(u)</span></code> (using wall clock readings)
will differ slightly.
Since both cases are subtracting times obtained <code class="docutils literal notranslate"><span class="pre">time.Now</span></code>, both results are arguably correct:
any discrepancy is necessarily less than the overhead of the calls to <code class="docutils literal notranslate"><span class="pre">time.Now</span></code>.
This discrepancy only arises if code actively looks for it, by doing the subtraction or comparison both ways.
In the survey of extant Go code (see Appendix below),
we found no such code that would detect this discrepancy.</p>
<p>On x86 systems, Linux, macOS, and Windows convey clock information to user
processes by publishing a page of memory containing the coefficients for a formula
converting the processor’s time stamp counter to monotonic clock and to wall clock readings.
A perfectly synchronized read of both clocks could be obtained in this case by
doing a single read of the time stamp counter and applying both formulas to the
same input.
This is an option if we decide it is important to eliminate the discrepancy
on commonly used systems.
This would improve precision but again it is false precision beyond the actual accuracy
of the calls.</p>
<p><strong>Overhead</strong>:
There is obviously an overhead to having <code class="docutils literal notranslate"><span class="pre">time.Now</span></code> read two system clocks instead of one.
However, as just mentioned, the usual implementation of these operations
does not typically enter the operating system kernel,
making two calls still quite cheap.
The same “simultaneous computation” we could apply for additional precision
would also reduce the overhead.</p>
</div>
<div class="section" id="time-representation">
<h3>Time representation<a class="headerlink" href="#time-representation" title="Permalink to this headline">¶</a></h3>
<p>The current definition of a <code class="docutils literal notranslate"><span class="pre">time.Time</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Time</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">sec</span>  <span class="n">int64</span>     <span class="o">//</span> <span class="n">seconds</span> <span class="n">since</span> <span class="n">Jan</span> <span class="mi">1</span><span class="p">,</span> <span class="n">year</span> <span class="mi">1</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">UTC</span>
	<span class="n">nsec</span> <span class="n">int32</span>     <span class="o">//</span> <span class="n">nanoseconds</span><span class="p">,</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999999999</span><span class="p">]</span>
	<span class="n">loc</span>  <span class="o">*</span><span class="n">Location</span> <span class="o">//</span> <span class="n">location</span><span class="p">,</span> <span class="k">for</span> <span class="n">minute</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">year</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To add the optional monotonic clock reading, we can change the representation to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Time</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">wall</span> <span class="n">uint64</span>    <span class="o">//</span> <span class="n">wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="o">-</span><span class="n">bit</span> <span class="n">flag</span><span class="p">,</span> <span class="mi">33</span><span class="o">-</span><span class="n">bit</span> <span class="n">sec</span> <span class="n">since</span> <span class="mi">1885</span><span class="p">,</span> <span class="mi">30</span><span class="o">-</span><span class="n">bit</span> <span class="n">nsec</span>
	<span class="n">ext</span>  <span class="n">int64</span>     <span class="o">//</span> <span class="n">extended</span> <span class="n">time</span> <span class="n">information</span>
	<span class="n">loc</span>  <span class="o">*</span><span class="n">Location</span> <span class="o">//</span> <span class="n">location</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The wall field can encode the wall time, packed into a 33-bit seconds and 30-bit nsecs
(keeping them separate avoids costly divisions).
2<sup>33</sup> seconds is 272 years, so the wall field by itself
can encode times from the years 1885 to 2157 to nanosecond precision.
If the top flag bit in <code class="docutils literal notranslate"><span class="pre">t.wall</span></code> is set, then the wall seconds are packed into <code class="docutils literal notranslate"><span class="pre">t.wall</span></code>
as just described, and <code class="docutils literal notranslate"><span class="pre">t.ext</span></code> holds
a monotonic clock reading, stored as nanoseconds since Go process startup
(translating to process start ensures we can store monotonic clock readings
even if the operating system returns a representation larger than 64 bits).
Otherwise (the top flag bit is clear), the 33-bit field in <code class="docutils literal notranslate"><span class="pre">t.wall</span></code> must be zero,
and <code class="docutils literal notranslate"><span class="pre">t.ext</span></code> holds the full 64-bit seconds since Jan 1, year 1, as in the
original Time representation.
Note that the meaning of the zero Time is unchanged.</p>
<p>An implication is that monotonic clock readings can only be stored
alongside wall clock readings for the years 1885 to 2157.
We only need to store monotonic clock readings in the result of <code class="docutils literal notranslate"><span class="pre">time.Now</span></code>
and derived nearby times,
and we expect those times to lie well within the range 1885 to 2157.
The low end of the range is constrained by the default boot time
used on a system with a dead clock:
in this common case, we must be able to store a
monotonic clock reading alongside the wall clock reading.
Unix-based systems often use 1970, and Windows-based systems often use 1980.
We are unaware of any systems using earlier default wall times,
but since the NTP protocol epoch uses 1900, it seemed more future-proof
to choose a year before 1900.</p>
<p>On 64-bit systems, there is a 32-bit padding gap between <code class="docutils literal notranslate"><span class="pre">nsec</span></code> and <code class="docutils literal notranslate"><span class="pre">loc</span></code>
in the current representation, which the new representation fills,
keeping the overall struct size at 24 bytes.
On 32-bit systems, there is no such gap, and the overall struct size
grows from 16 to 20 bytes.</p>
</div>
</div>
</div>
<div class="section" id="appendix-time-now-usage">
<h1>Appendix: time.Now usage<a class="headerlink" href="#appendix-time-now-usage" title="Permalink to this headline">¶</a></h1>
<p>We analyzed uses of time.Now in <a class="reference external" href="https://github.com/rsc/corpus">Go Corpus v0.01</a>.</p>
<p>Overall estimates:</p>
<ul class="simple">
<li><p>71% unaffected</p></li>
<li><p>29% fixed in event of wall clock time warps (subtractions or comparisons)</p></li>
</ul>
<p>Basic counts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cg -f $(pwd)&#39;.*\.go$&#39; &#39;time\.Now\(\)&#39; | sed &#39;s;//.*;;&#39; |grep time.Now &gt;alltimenow
$ wc -l alltimenow
   16569 alltimenow
$ egrep -c &#39;time\.Now\(\).*time\.Now\(\)&#39; alltimenow
63

$ 9 sed -n &#39;s/.*(time\.Now\(\)(\.[A-Za-z0-9]+)?).*/\1/p&#39; alltimenow | sort | uniq -c
4910 time.Now()
1511 time.Now().Add
  45 time.Now().AddDate
  69 time.Now().After
  77 time.Now().Before
   4 time.Now().Date
   5 time.Now().Day
   1 time.Now().Equal
 130 time.Now().Format
  23 time.Now().In
   8 time.Now().Local
   4 time.Now().Location
   1 time.Now().MarshalBinary
   2 time.Now().MarshalText
   2 time.Now().Minute
  68 time.Now().Nanosecond
  14 time.Now().Round
  22 time.Now().Second
  37 time.Now().String
 370 time.Now().Sub
  28 time.Now().Truncate
 570 time.Now().UTC
 582 time.Now().Unix
8067 time.Now().UnixNano
  17 time.Now().Year
   2 time.Now().Zone
</pre></div>
</div>
<p>That splits into completely unaffected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="mi">45</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">AddDate</span>
   <span class="mi">4</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Date</span>
   <span class="mi">5</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Day</span>
 <span class="mi">130</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span>
  <span class="mi">23</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">In</span>
   <span class="mi">8</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Local</span>
   <span class="mi">4</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Location</span>
   <span class="mi">1</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">MarshalBinary</span>
   <span class="mi">2</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">MarshalText</span>
   <span class="mi">2</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Minute</span>
  <span class="mi">68</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Nanosecond</span>
  <span class="mi">14</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Round</span>
  <span class="mi">22</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Second</span>
  <span class="mi">37</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">String</span>
  <span class="mi">28</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Truncate</span>
 <span class="mi">570</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span>
 <span class="mi">582</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Unix</span>
<span class="mi">8067</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UnixNano</span>
  <span class="mi">17</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Year</span>
   <span class="mi">2</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Zone</span>
<span class="mi">9631</span> <span class="n">TOTAL</span>
</pre></div>
</div>
<p>and possibly affected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">4910</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="mi">1511</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span>
  <span class="mi">69</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">After</span>
  <span class="mi">77</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Before</span>
   <span class="mi">1</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Equal</span>
 <span class="mi">370</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span>
<span class="mi">6938</span> <span class="n">TOTAL</span>
</pre></div>
</div>
<p>If we pull out the possibly affected lines, the overall count is slightly higher because of the 63 lines with more than one time.Now call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ egrep &#39;time\.Now\(\)([^.]|\.(Add|After|Before|Equal|Sub)|$)&#39; alltimenow &gt;checktimenow
$ wc -l checktimenow
    6982 checktimenow
</pre></div>
</div>
<p>From the start, then, 58% of time.Now uses immediately flip to wall time and are unaffected.
The remaining 42% may be affected.</p>
<p>Randomly sampling 100 of the 42%, we find:</p>
<ul class="simple">
<li><p>32 unaffected (23 use wall time once; 9 use wall time multiple times)</p></li>
<li><p>68 fixed</p></li>
</ul>
<p>We estimate therefore that the 42% is made up of 13% additional unaffected and 29% fixed, giving an overall total of 71% unaffected, 29% fixed.</p>
<div class="section" id="unaffected">
<h2>Unaffected<a class="headerlink" href="#unaffected" title="Permalink to this headline">¶</a></h2>
<div class="section" id="github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-guestbook-guestbook-go-97">
<h3>github.com/mitchellh/packer/vendor/google.golang.org/appengine/demos/guestbook/guestbook.go:97<a class="headerlink" href="#github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-guestbook-guestbook-go-97" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">handleSign</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">g</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Greeting</span><span class="p">{</span>
		<span class="n">Content</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">FormValue</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span>
		<span class="n">Date</span><span class="p">:</span>    <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
	<span class="p">}</span>
	<span class="o">...</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong>
The time will be used exactly once, during the serialization of g.Date in datastore.Put.</p>
</div>
<div class="section" id="github-com-aws-aws-sdk-go-service-databasemigrationservice-examples-test-go-887">
<h3>github.com/aws/aws-sdk-go/service/databasemigrationservice/examples_test.go:887<a class="headerlink" href="#github-com-aws-aws-sdk-go-service-databasemigrationservice-examples-test-go-887" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">ExampleDatabaseMigrationService_ModifyReplicationTask</span><span class="p">()</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">params</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">databasemigrationservice</span><span class="o">.</span><span class="n">ModifyReplicationTaskInput</span><span class="p">{</span>
		<span class="o">...</span>
		<span class="n">CdcStartTime</span><span class="p">:</span>              <span class="n">aws</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()),</span>
		<span class="o">...</span>
	<span class="p">}</span>
	<span class="o">...</span> <span class="n">svc</span><span class="o">.</span><span class="n">ModifyReplicationTask</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong>
The time will be used exactly once, during the serialization of params.CdcStartTime in svc.ModifyReplicationTask.</p>
</div>
<div class="section" id="github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-94">
<h3>github.com/influxdata/telegraf/plugins/inputs/mongodb/mongodb_data_test.go:94<a class="headerlink" href="#github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-94" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">:=</span> <span class="n">NewMongodbData</span><span class="p">(</span>
	<span class="o">&amp;</span><span class="n">StatLine</span><span class="p">{</span>
		<span class="o">...</span>
		<span class="n">Time</span><span class="p">:</span>          <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
		<span class="o">...</span>
	<span class="p">},</span>
	<span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>StatLine.Time is commented as “the time at which this StatLine was generated’’ and is only used
by passing to acc.AddFields, where acc is a telegraf.Accumulator.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">AddFields</span> <span class="n">adds</span> <span class="n">a</span> <span class="n">metric</span> <span class="n">to</span> <span class="n">the</span> <span class="n">accumulator</span> <span class="k">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">measurement</span>
<span class="o">//</span> <span class="n">name</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="ow">and</span> <span class="n">tags</span> <span class="p">(</span><span class="ow">and</span> <span class="n">timestamp</span><span class="p">)</span><span class="o">.</span> <span class="n">If</span> <span class="n">a</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">provided</span><span class="p">,</span>
<span class="o">//</span> <span class="n">then</span> <span class="n">the</span> <span class="n">accumulator</span> <span class="n">sets</span> <span class="n">it</span> <span class="n">to</span> <span class="s2">&quot;now&quot;</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">point</span> <span class="k">with</span> <span class="n">a</span> <span class="n">value</span><span class="p">,</span> <span class="n">decorating</span> <span class="n">it</span> <span class="k">with</span> <span class="n">tags</span>
<span class="o">//</span> <span class="n">NOTE</span><span class="p">:</span> <span class="n">tags</span> <span class="ow">is</span> <span class="n">expected</span> <span class="n">to</span> <span class="n">be</span> <span class="n">owned</span> <span class="n">by</span> <span class="n">the</span> <span class="n">caller</span><span class="p">,</span> <span class="n">don</span><span class="s1">&#39;t mutate</span>
<span class="o">//</span> <span class="n">it</span> <span class="n">after</span> <span class="n">passing</span> <span class="n">to</span> <span class="n">Add</span><span class="o">.</span>
<span class="n">AddFields</span><span class="p">(</span><span class="n">measurement</span> <span class="n">string</span><span class="p">,</span>
	<span class="n">fields</span> <span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">interface</span><span class="p">{},</span>
	<span class="n">tags</span> <span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">string</span><span class="p">,</span>
	<span class="n">t</span> <span class="o">...</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
</pre></div>
</div>
<p>The non-test implementation of Accumulator calls t.Round, which will convert to wall time.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-spf13-fsync-fsync-test-go-23">
<h3>github.com/spf13/fsync/fsync_test.go:23<a class="headerlink" href="#github-com-spf13-fsync-fsync-test-go-23" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="nb">set</span> <span class="n">times</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">past</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">times</span> <span class="n">are</span> <span class="n">synced</span><span class="p">,</span> <span class="ow">not</span> <span class="n">accidentally</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">same</span>
<span class="n">tt</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)</span>
<span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Chtimes</span><span class="p">(</span><span class="s2">&quot;src/a/b&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tt</span><span class="p">))</span>
<span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Chtimes</span><span class="p">(</span><span class="s2">&quot;src/a&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tt</span><span class="p">))</span>
<span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Chtimes</span><span class="p">(</span><span class="s2">&quot;src/c&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tt</span><span class="p">))</span>
<span class="n">check</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Chtimes</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">tt</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-flynn-flynn-vendor-github-com-gorilla-handlers-handlers-go-66">
<h3>github.com/flynn/flynn/vendor/github.com/gorilla/handlers/handlers.go:66<a class="headerlink" href="#github-com-flynn-flynn-vendor-github-com-gorilla-handlers-handlers-go-66" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">writeLog</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">writer</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">Status</span><span class="p">(),</span> <span class="n">logger</span><span class="o">.</span><span class="n">Size</span><span class="p">())</span>
</pre></div>
</div>
<p>writeLog calls buildCommonLogLine, which eventually calls t.Format.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-ncw-rclone-vendor-google-golang-org-grpc-server-go-586">
<h3>github.com/ncw/rclone/vendor/google.golang.org/grpc/server.go:586<a class="headerlink" href="#github-com-ncw-rclone-vendor-google-golang-org-grpc-server-go-586" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">nil</span> <span class="o">&amp;&amp;</span> <span class="n">outPayload</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="n">outPayload</span><span class="o">.</span><span class="n">SentTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">stats</span><span class="o">.</span><span class="n">HandleRPC</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">Context</span><span class="p">(),</span> <span class="n">outPayload</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>SentTime seems to never be used. Client code could call stats.RegisterRPCHandler to do stats processing and look at SentTime.
Any use of time.Since(SentTime) would be improved by having SentTime be monotonic here.</p>
<p>There are no calls to stats.RegisterRPCHandler in the entire corpus.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-github-com-influxdata-influxdb-models-points-go-1316">
<h3>github.com/openshift/origin/vendor/github.com/influxdata/influxdb/models/points.go:1316<a class="headerlink" href="#github-com-openshift-origin-vendor-github-com-influxdata-influxdb-models-points-go-1316" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">point</span><span class="p">)</span> <span class="n">UnmarshalBinary</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>	
	<span class="o">...</span>
	<span class="n">p</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">p</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">UnmarshalBinary</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s weird. It looks like it is setting p.time in case of an error in UnmarshalBinary, instead of checking for and propagating an error. All the other ways that a p.time is initalized end up using non-monotonic times, because they came from time.Unix or t.Round. Assuming that bad decodings are rare, going to call it unaffected.</p>
<p><strong>Unaffected</strong> (but not completely sure).</p>
</div>
<div class="section" id="github-com-zyedidia-micro-cmd-micro-util-go">
<h3>github.com/zyedidia/micro/cmd/micro/util.go<a class="headerlink" href="#github-com-zyedidia-micro-cmd-micro-util-go" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">GetModTime</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">last</span> <span class="n">modification</span> <span class="n">time</span> <span class="k">for</span> <span class="n">a</span> <span class="n">given</span> <span class="n">file</span>
<span class="o">//</span> <span class="n">It</span> <span class="n">also</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">boolean</span> <span class="k">if</span> <span class="n">there</span> <span class="n">was</span> <span class="n">a</span> <span class="n">problem</span> <span class="n">accessing</span> <span class="n">the</span> <span class="n">file</span>
<span class="n">func</span> <span class="n">GetModTime</span><span class="p">(</span><span class="n">path</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">info</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span> <span class="n">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">.</span><span class="n">ModTime</span><span class="p">(),</span> <span class="n">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The result is recorded in the field Buffer.ModTime and then checked against future calls to GetModTime to see if the file changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">We</span> <span class="n">should</span> <span class="n">only</span> <span class="n">use</span> <span class="n">last</span> <span class="n">time</span><span class="s1">&#39;s eventhandler if the file wasn&#39;</span><span class="n">t</span> <span class="n">by</span> <span class="n">someone</span> <span class="k">else</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">meantime</span>
<span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">ModTime</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">.</span><span class="n">ModTime</span> <span class="p">{</span>
	<span class="n">b</span><span class="o">.</span><span class="n">EventHandler</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">EventHandler</span>
	<span class="n">b</span><span class="o">.</span><span class="n">EventHandler</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">modTime</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">ModTime</span> <span class="p">{</span>
	<span class="n">choice</span><span class="p">,</span> <span class="n">canceled</span> <span class="o">:=</span> <span class="n">messenger</span><span class="o">.</span><span class="n">YesNoPrompt</span><span class="p">(</span><span class="s2">&quot;The file has changed since it was last read. Reload file? (y,n)&quot;</span><span class="p">)</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Normally Buffer.ModTime will be a wall time, but if the file doesn’t exist Buffer.ModTime will be a monotonic time that will not compare == to any file time. That’s the desired behavior here.</p>
<p><strong>Unaffected</strong> (or maybe fixed).</p>
</div>
<div class="section" id="github-com-gravitational-teleport-lib-auth-init-test-go-59">
<h3>github.com/gravitational/teleport/lib/auth/init_test.go:59<a class="headerlink" href="#github-com-gravitational-teleport-lib-auth-init-test-go-59" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">test</span> <span class="n">TTL</span> <span class="n">by</span> <span class="n">converting</span> <span class="n">the</span> <span class="n">generated</span> <span class="n">cert</span> <span class="n">to</span> <span class="n">text</span> <span class="o">-&gt;</span> <span class="n">back</span> <span class="ow">and</span> <span class="n">making</span> <span class="n">sure</span> <span class="n">ExpireAfter</span> <span class="ow">is</span> <span class="n">valid</span>
<span class="n">ttl</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">expiryDate</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
<span class="nb">bytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">GenerateHostCert</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">pub</span><span class="p">,</span> <span class="s2">&quot;id1&quot;</span><span class="p">,</span> <span class="s2">&quot;example.com&quot;</span><span class="p">,</span> <span class="n">teleport</span><span class="o">.</span><span class="n">Roles</span><span class="p">{</span><span class="n">teleport</span><span class="o">.</span><span class="n">RoleNode</span><span class="p">},</span> <span class="n">ttl</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">IsNil</span><span class="p">)</span>
<span class="n">pk</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">ParseAuthorizedKey</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">IsNil</span><span class="p">)</span>
<span class="n">copy</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">pk</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">ssh</span><span class="o">.</span><span class="n">Certificate</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="n">Equals</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">uint64</span><span class="p">(</span><span class="n">expiryDate</span><span class="o">.</span><span class="n">Unix</span><span class="p">()),</span> <span class="n">Equals</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">ValidBefore</span><span class="p">)</span>
</pre></div>
</div>
<p>This is jittery, in the sense that the computed expiryDate may not exactly match the cert generation that—one must assume—grabs the current time and adds the passed ttl to it to compute ValidBefore. It’s unclear without digging exactly how the cert gets generated (there seems to be an RPC, but I don’t know if it’s to a test server in the same process). Either way, the two times are only possibly equal because of the rounding to second granularity. Even today, if the call expiryDate := time.Now().Add(ttl) happens 1 nanosecond before a wall time second boundary, this test will fail. Moving to monotonic time will not change the fact that it’s jittery.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-aws-aws-sdk-go-private-model-api-operation-go-420">
<h3>github.com/aws/aws-sdk-go/private/model/api/operation.go:420<a class="headerlink" href="#github-com-aws-aws-sdk-go-private-model-api-operation-go-420" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>case &quot;timestamp&quot;:
	str = `aws.Time(time.Now())`
</pre></div>
</div>
<p>This is the example generator for the AWS documentation. An aws.Time is always just being put into a structure to send over the wire in JSON format to AWS, so these remain OK.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-17">
<h3>github.com/influxdata/telegraf/plugins/inputs/mongodb/mongodb_data_test.go:17<a class="headerlink" href="#github-com-influxdata-telegraf-plugins-inputs-mongodb-mongodb-data-test-go-17" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">:=</span> <span class="n">NewMongodbData</span><span class="p">(</span>
	<span class="o">&amp;</span><span class="n">StatLine</span><span class="p">{</span>
		<span class="o">...</span>
		<span class="n">Time</span><span class="p">:</span>             <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
		<span class="o">...</span>
	<span class="p">},</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected</strong> (see above from same file).</p>
</div>
<div class="section" id="github-com-aws-aws-sdk-go-service-datapipeline-examples-test-go-36">
<h3>github.com/aws/aws-sdk-go/service/datapipeline/examples_test.go:36<a class="headerlink" href="#github-com-aws-aws-sdk-go-service-datapipeline-examples-test-go-36" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">datapipeline</span><span class="o">.</span><span class="n">ActivatePipelineInput</span><span class="p">{</span>
	<span class="o">...</span>
	<span class="n">StartTimestamp</span><span class="p">:</span> <span class="n">aws</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()),</span>
<span class="p">}</span>
<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">svc</span><span class="o">.</span><span class="n">ActivatePipeline</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>The svc.ActivatePipeline call serializes StartTimestamp to JSON (just once).</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-jessevdk-go-flags-man-go-177">
<h3>github.com/jessevdk/go-flags/man.go:177<a class="headerlink" href="#github-com-jessevdk-go-flags-man-go-177" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">wr</span><span class="p">,</span> <span class="s2">&quot;.TH </span><span class="si">%s</span><span class="s2"> 1 </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">manQuote</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Name</span><span class="p">),</span> <span class="n">t</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="s2">&quot;2 January 2006&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="k8s-io-heapster-events-manager-manager-test-go-28">
<h3>k8s.io/heapster/events/manager/manager_test.go:28<a class="headerlink" href="#k8s-io-heapster-events-manager-manager-test-go-28" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">core</span><span class="o">.</span><span class="n">EventBatch</span><span class="p">{</span>
	<span class="n">Timestamp</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
	<span class="n">Events</span><span class="p">:</span>    <span class="p">[]</span><span class="o">*</span><span class="n">kube_api</span><span class="o">.</span><span class="n">Event</span><span class="p">{},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Later used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">buffer</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&quot;EventBatch     Timestamp: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="k8s-io-heapster-metrics-storage-podmetrics-reststorage-go-121">
<h3>k8s.io/heapster/metrics/storage/podmetrics/reststorage.go:121<a class="headerlink" href="#k8s-io-heapster-metrics-storage-podmetrics-reststorage-go-121" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CreationTimestamp</span><span class="p">:</span> <span class="n">unversioned</span><span class="o">.</span><span class="n">NewTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p>But CreationTimestamp is only ever checked for being the zero time or not.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-revel-revel-server-go-46">
<h3>github.com/revel/revel/server.go:46<a class="headerlink" href="#github-com-revel-revel-server-go-46" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">//</span> <span class="n">Revel</span> <span class="n">request</span> <span class="n">access</span> <span class="n">log</span> <span class="nb">format</span>
<span class="o">//</span> <span class="n">RequestStartTime</span> <span class="n">ClientIP</span> <span class="n">ResponseStatus</span> <span class="n">RequestLatency</span> <span class="n">HTTPMethod</span> <span class="n">URLPath</span>
<span class="o">//</span> <span class="n">Sample</span> <span class="nb">format</span><span class="p">:</span>
<span class="o">//</span> <span class="mi">2016</span><span class="o">/</span><span class="mi">05</span><span class="o">/</span><span class="mi">25</span> <span class="mi">17</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mf">37.112</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="mi">200</span>  <span class="mf">270.157</span><span class="n">µs</span> <span class="n">GET</span> <span class="o">/</span>
<span class="n">requestLog</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;%v %v %v %10v %v %v&quot;</span><span class="p">,</span>
	<span class="n">start</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">requestLogTimeFormat</span><span class="p">),</span>
	<span class="n">ClientIP</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
	<span class="n">c</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
	<span class="n">r</span><span class="o">.</span><span class="n">Method</span><span class="p">,</span>
	<span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-command-agent-agent-go-1426">
<h3>github.com/hashicorp/consul/command/agent/agent.go:1426<a class="headerlink" href="#github-com-hashicorp-consul-command-agent-agent-go-1426" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Expires</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">check</span><span class="o">.</span><span class="n">TTL</span><span class="p">)</span><span class="o">.</span><span class="n">Unix</span><span class="p">(),</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-drone-drone-server-login-go-143">
<h3>github.com/drone/drone/server/login.go:143<a class="headerlink" href="#github-com-drone-drone-server-login-go-143" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exp</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span> <span class="o">*</span> <span class="mi">72</span><span class="p">)</span><span class="o">.</span><span class="n">Unix</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-github-com-coreos-etcd-pkg-transport-listener-go-113">
<h3>github.com/openshift/origin/vendor/github.com/coreos/etcd/pkg/transport/listener.go:113:<a class="headerlink" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-pkg-transport-listener-go-113" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tmpl</span> <span class="o">:=</span> <span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">{</span>
	<span class="n">NotBefore</span><span class="p">:</span>    <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
	<span class="n">NotAfter</span><span class="p">:</span>     <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)),</span>
	<span class="o">...</span>
<span class="p">}</span>
<span class="o">...</span>
<span class="n">derBytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">x509</span><span class="o">.</span><span class="n">CreateCertificate</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Reader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmpl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">.</span><span class="n">PublicKey</span><span class="p">,</span> <span class="n">priv</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-ethereum-go-ethereum-swarm-api-http-server-go-189">
<h3>github.com/ethereum/go-ethereum/swarm/api/http/server.go:189<a class="headerlink" href="#github-com-ethereum-go-ethereum-swarm-api-http-server-go-189" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="o">.</span><span class="n">ServeContent</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">([]</span><span class="n">byte</span><span class="p">(</span><span class="n">newKey</span><span class="p">)))</span>
</pre></div>
</div>
<p>eventually uses the passed time in formatting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">w</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">,</span> <span class="n">modtime</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">TimeFormat</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-vendor-google-golang-org-grpc-call-go-187">
<h3>github.com/hashicorp/consul/vendor/google.golang.org/grpc/call.go:187<a class="headerlink" href="#github-com-hashicorp-consul-vendor-google-golang-org-grpc-call-go-187" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">TagRPC</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">.</span><span class="n">RPCTagInfo</span><span class="p">{</span><span class="n">FullMethodName</span><span class="p">:</span> <span class="n">method</span><span class="p">})</span>
	<span class="n">begin</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">.</span><span class="n">Begin</span><span class="p">{</span>
		<span class="n">Client</span><span class="p">:</span>    <span class="n">true</span><span class="p">,</span>
		<span class="n">BeginTime</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
		<span class="n">FailFast</span><span class="p">:</span>  <span class="n">c</span><span class="o">.</span><span class="n">failFast</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="n">sh</span><span class="o">.</span><span class="n">HandleRPC</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">defer</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">sh</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="n">end</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">.</span><span class="n">End</span><span class="p">{</span>
			<span class="n">Client</span><span class="p">:</span>  <span class="n">true</span><span class="p">,</span>
			<span class="n">EndTime</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
			<span class="n">Error</span><span class="p">:</span>   <span class="n">e</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="n">sh</span><span class="o">.</span><span class="n">HandleRPC</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}()</span>
</pre></div>
</div>
<p>If something subtracted BeginTime and EndTime, that would be fixed by monotonic times.
I don’t see any implementations of StatsHandler in the tree, though, so sh must be nil.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-vault-builtin-logical-pki-backend-test-go-396">
<h3>github.com/hashicorp/vault/builtin/logical/pki/backend_test.go:396<a class="headerlink" href="#github-com-hashicorp-vault-builtin-logical-pki-backend-test-go-396" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if !cert.NotBefore.Before(time.Now().Add(-10 * time.Second)) {
	return nil, fmt.Errorf(&quot;Validity period not far enough in the past&quot;)
}
</pre></div>
</div>
<p>cert.NotBefore is usually the result of decoding an wire format certificate,
so it’s not monotonic, so the time will collapse to wall time during the Before check.</p>
<p><strong>Unaffected.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-plugin-pkg-admission-namespace-lifecycle-admission-test-go-194">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/plugin/pkg/admission/namespace/lifecycle/admission_test.go:194<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-plugin-pkg-admission-namespace-lifecycle-admission-test-go-194" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fakeClock</span> <span class="o">:=</span> <span class="n">clock</span><span class="o">.</span><span class="n">NewFakeClock</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p>The clock being implemented does Since, After, and other relative manipulation only.</p>
<p><strong>Unaffected.</strong></p>
</div>
</div>
<div class="section" id="unaffected-but-uses-time-time-as-wall-time-multiple-times">
<h2>Unaffected (but uses time.Time as wall time multiple times)<a class="headerlink" href="#unaffected-but-uses-time-time-as-wall-time-multiple-times" title="Permalink to this headline">¶</a></h2>
<p>These are split out because an obvious optimization would be to store just the monotonic time
and rederive the wall time using the current wall-vs-monotonic correspondence from the
operating system. Using a wall form multiple times in this case could show up as jitter.
The proposal does <em>not</em> suggest this optimization, precisely because of cases like these.</p>
<div class="section" id="github-com-docker-distribution-registry-storage-driver-inmemory-mfs-go-195">
<h3>github.com/docker/distribution/registry/storage/driver/inmemory/mfs.go:195<a class="headerlink" href="#github-com-docker-distribution-registry-storage-driver-inmemory-mfs-go-195" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">mkdir</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">child</span> <span class="n">directory</span> <span class="n">under</span> <span class="n">d</span> <span class="k">with</span> <span class="n">the</span> <span class="n">given</span> <span class="n">name</span><span class="o">.</span>
<span class="n">func</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span><span class="nb">dir</span><span class="p">)</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">name</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nb">dir</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span> <span class="n">d</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ends up being used by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fi</span> <span class="o">:=</span> <span class="n">storagedriver</span><span class="o">.</span><span class="n">FileInfoFields</span><span class="p">{</span>
	<span class="n">Path</span><span class="p">:</span>    <span class="n">path</span><span class="p">,</span>
	<span class="n">IsDir</span><span class="p">:</span>   <span class="n">found</span><span class="o">.</span><span class="n">isdir</span><span class="p">(),</span>
	<span class="n">ModTime</span><span class="p">:</span> <span class="n">found</span><span class="o">.</span><span class="n">modtime</span><span class="p">(),</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which will result in that time being returned by an os.FileInfo implementation’s ModTime method.</p>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-minio-minio-cmd-server-startup-msg-test-go-52">
<h3>github.com/minio/minio/cmd/server-startup-msg_test.go:52<a class="headerlink" href="#github-com-minio-minio-cmd-server-startup-msg-test-go-52" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">given</span>
<span class="n">var</span> <span class="n">expiredDate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">29</span> <span class="n">days</span><span class="o">.</span>
<span class="n">var</span> <span class="n">fakeCerts</span> <span class="o">=</span> <span class="p">[]</span><span class="o">*</span><span class="n">x509</span><span class="o">.</span><span class="n">Certificate</span><span class="p">{</span>
	<span class="o">...</span> <span class="n">NotAfter</span><span class="p">:</span> <span class="n">expiredDate</span> <span class="o">...</span>
<span class="p">}</span>

<span class="n">expectedMsg</span> <span class="o">:=</span> <span class="n">colorBlue</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Certificate expiry info:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">colorBold</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s2">&quot;#1 Test cert will expire on </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expiredDate</span><span class="p">))</span>

<span class="n">msg</span> <span class="o">:=</span> <span class="n">getCertificateChainMsg</span><span class="p">(</span><span class="n">fakeCerts</span><span class="p">)</span>
<span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="n">expectedMsg</span> <span class="p">{</span>
	<span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s2">&quot;Expected message was: </span><span class="si">%s</span><span class="s2">, got: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expectedMsg</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-pingcap-tidb-expression-builtin-string-test-go-42">
<h3>github.com/pingcap/tidb/expression/builtin_string_test.go:42<a class="headerlink" href="#github-com-pingcap-tidb-expression-builtin-string-test-go-42" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">types</span><span class="o">.</span><span class="n">Time</span><span class="p">{</span><span class="n">Time</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">FromGoTime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()),</span> <span class="n">Fsp</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">Type</span><span class="p">:</span> <span class="n">mysql</span><span class="o">.</span><span class="n">TypeDatetime</span><span class="p">},</span> <span class="mi">26</span><span class="p">},</span>
</pre></div>
</div>
<p>The call to FromGoTime does:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">FromGoTime</span><span class="p">(</span><span class="n">t</span> <span class="n">gotime</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="n">TimeInternal</span> <span class="p">{</span>
	<span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">Date</span><span class="p">()</span>
	<span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>
	<span class="n">microsecond</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">Nanosecond</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>
	<span class="k">return</span> <span class="n">newMysqlTime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-docker-docker-vendor-github-com-docker-distribution-registry-client-repository-go-750">
<h3>github.com/docker/docker/vendor/github.com/docker/distribution/registry/client/repository.go:750<a class="headerlink" href="#github-com-docker-docker-vendor-github-com-docker-distribution-registry-client-repository-go-750" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">bs</span> <span class="o">*</span><span class="n">blobs</span><span class="p">)</span> <span class="n">Create</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">options</span> <span class="o">...</span><span class="n">distribution</span><span class="o">.</span><span class="n">BlobCreateOption</span><span class="p">)</span> <span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">BlobWriter</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">httpBlobUpload</span><span class="p">{</span>
		<span class="n">statter</span><span class="p">:</span>   <span class="n">bs</span><span class="o">.</span><span class="n">statter</span><span class="p">,</span>
		<span class="n">client</span><span class="p">:</span>    <span class="n">bs</span><span class="o">.</span><span class="n">client</span><span class="p">,</span>
		<span class="n">uuid</span><span class="p">:</span>      <span class="n">uuid</span><span class="p">,</span>
		<span class="n">startedAt</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
		<span class="n">location</span><span class="p">:</span>  <span class="n">location</span><span class="p">,</span>
	<span class="p">},</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That field is used to implement distribution.BlobWriter interface’s StartedAt method, which is eventually copied into a handlers.blobUploadState, which is sometimes serialized to JSON and reconstructed. The serialization seems to be the single use.</p>
<p><strong>Unaffected</strong> (but not completely sure about use count).</p>
</div>
<div class="section" id="github-com-pingcap-pd-vendor-vendor-golang-org-x-net-internal-timeseries-timeseries-go-83">
<h3>github.com/pingcap/pd/_vendor/vendor/golang.org/x/net/internal/timeseries/timeseries.go:83<a class="headerlink" href="#github-com-pingcap-pd-vendor-vendor-golang-org-x-net-internal-timeseries-timeseries-go-83" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">A</span> <span class="n">Clock</span> <span class="n">tells</span> <span class="n">the</span> <span class="n">current</span> <span class="n">time</span><span class="o">.</span>
<span class="nb">type</span> <span class="n">Clock</span> <span class="n">interface</span> <span class="p">{</span>
	<span class="n">Time</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
<span class="p">}</span>

<span class="nb">type</span> <span class="n">defaultClock</span> <span class="nb">int</span>
<span class="n">var</span> <span class="n">defaultClockInstance</span> <span class="n">defaultClock</span>
<span class="n">func</span> <span class="p">(</span><span class="n">defaultClock</span><span class="p">)</span> <span class="n">Time</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span> <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span> <span class="p">}</span>
</pre></div>
</div>
<p>Let’s look at how that gets used.</p>
<p>The main use is to get a now time and then check whether</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>but levels[0].end was rounded, meaning its a wall time. advance then does:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if !t.After(ts.levels[0].end) {
	return
}
for i := 0; i &lt; len(ts.levels); i++ {
	level := ts.levels[i]
	if !level.end.Before(t) {
		break
	}

	// If the time is sufficiently far, just clear the level and advance
	// directly.
	if !t.Before(level.end.Add(level.size * time.Duration(ts.numBuckets))) {
		for _, b := range level.buckets {
			ts.resetObservation(b)
		}
		level.end = time.Unix(0, (t.UnixNano()/level.size.Nanoseconds())*level.size.Nanoseconds())
	}

	for t.After(level.end) {
		level.end = level.end.Add(level.size)
		level.newest = level.oldest
		level.oldest = (level.oldest + 1) % ts.numBuckets
		ts.resetObservation(level.buckets[level.newest])
	}

	t = level.end
}
</pre></div>
</div>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-astaxie-beego-logs-logger-test-go-24">
<h3>github.com/astaxie/beego/logs/logger_test.go:24<a class="headerlink" href="#github-com-astaxie-beego-logs-logger-test-go-24" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">TestFormatHeader_0</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tm</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">Year</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2100</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">FailNow</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="n">dur</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">Year</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">2100</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">formatTimeHeader</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tm</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="s2">&quot;2006/01/02 15:04:05 &quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">string</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Log</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>
			<span class="n">t</span><span class="o">.</span><span class="n">FailNow</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="n">tm</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dur</span><span class="p">)</span>
		<span class="n">dur</span> <span class="o">*=</span> <span class="mi">2</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-attic-labs-noms-vendor-github-com-aws-aws-sdk-go-aws-signer-v4-v4-test-go-418">
<h3>github.com/attic-labs/noms/vendor/github.com/aws/aws-sdk-go/aws/signer/v4/v4_test.go:418<a class="headerlink" href="#github-com-attic-labs-noms-vendor-github-com-aws-aws-sdk-go-aws-signer-v4-v4-test-go-418" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">signingCtx</span><span class="p">{</span>
	<span class="o">...</span>
	<span class="n">Time</span><span class="p">:</span>        <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
	<span class="n">ExpireTime</span><span class="p">:</span>  <span class="mi">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ctx</span><span class="o">.</span><span class="n">buildCanonicalString</span><span class="p">()</span>
<span class="n">expected</span> <span class="o">:=</span> <span class="s2">&quot;https://example.org/bucket/key-._~,!@#$%^&amp;*()?Foo=z&amp;Foo=o&amp;Foo=m&amp;Foo=a&quot;</span>
<span class="k">assert</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
</pre></div>
</div>
<p>ctx is used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span><span class="o">.</span><span class="n">formattedTime</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">timeFormat</span><span class="p">)</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">formattedShortTime</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">shortTimeFormat</span><span class="p">)</span>
</pre></div>
</div>
<p>and then ctx.formattedTime is used sometimes and ctx.formattedShortTime is used other times.</p>
<p><strong>Unaffected</strong> (but uses time multiple times).</p>
</div>
<div class="section" id="github-com-zenazn-goji-example-models-go-21">
<h3>github.com/zenazn/goji/example/models.go:21<a class="headerlink" href="#github-com-zenazn-goji-example-models-go-21" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">Greets</span> <span class="o">=</span> <span class="p">[]</span><span class="n">Greet</span><span class="p">{</span>
	<span class="p">{</span><span class="s2">&quot;carl&quot;</span><span class="p">,</span> <span class="s2">&quot;Welcome to Gritter!&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()},</span>
	<span class="p">{</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;Wanna know a secret?&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()},</span>
	<span class="p">{</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span> <span class="s2">&quot;Okay!&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()},</span>
	<span class="p">{</span><span class="s2">&quot;eve&quot;</span><span class="p">,</span> <span class="s2">&quot;I&#39;m listening...&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>used by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Write</span> <span class="n">out</span> <span class="n">a</span> <span class="n">representation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">greet</span>
<span class="n">func</span> <span class="p">(</span><span class="n">g</span> <span class="n">Greet</span><span class="p">)</span> <span class="n">Write</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
		<span class="n">g</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">UnixDate</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Unaffected</strong> (but may use wall representation multiple times).</p>
</div>
<div class="section" id="github-com-afex-hystrix-go-hystrix-rolling-rolling-timing-go-77">
<h3>github.com/afex/hystrix-go/hystrix/rolling/rolling_timing.go:77<a class="headerlink" href="#github-com-afex-hystrix-go-hystrix-rolling-rolling-timing-go-77" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>r.Mutex.RLock()
now := time.Now()
bucket, exists := r.Buckets[now.Unix()]
r.Mutex.RUnlock()

if !exists {
	r.Mutex.Lock()
	defer r.Mutex.Unlock()

	r.Buckets[now.Unix()] = &amp;timingBucket{}
	bucket = r.Buckets[now.Unix()]
}
</pre></div>
</div>
<p><strong>Unaffected</strong> (but uses wall representation multiple times).</p>
</div>
</div>
<div class="section" id="fixed">
<h2>Fixed<a class="headerlink" href="#fixed" title="Permalink to this headline">¶</a></h2>
<div class="section" id="github-com-hashicorp-vault-vendor-golang-org-x-net-http2-transport-go-721">
<h3>github.com/hashicorp/vault/vendor/golang.org/x/net/http2/transport.go:721<a class="headerlink" href="#github-com-hashicorp-vault-vendor-golang-org-x-net-http2-transport-go-721" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">cc</span> <span class="o">*</span><span class="n">ClientConn</span><span class="p">)</span> <span class="n">RoundTrip</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">cc</span><span class="o">.</span><span class="n">lastActive</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>matches against:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">traceGotConn</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">cc</span> <span class="o">*</span><span class="n">ClientConn</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span> <span class="n">ci</span><span class="o">.</span><span class="n">IdleTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">lastActive</span><span class="p">)</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong>
Only for debugging, though.</p>
</div>
<div class="section" id="github-com-docker-docker-vendor-github-com-hashicorp-serf-serf-serf-go-1417">
<h3>github.com/docker/docker/vendor/github.com/hashicorp/serf/serf/serf.go:1417<a class="headerlink" href="#github-com-docker-docker-vendor-github-com-hashicorp-serf-serf-serf-go-1417" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">reap</span> <span class="ow">is</span> <span class="n">called</span> <span class="k">with</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">old</span> <span class="n">members</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">timeout</span><span class="p">,</span> <span class="ow">and</span> <span class="n">removes</span>
<span class="o">//</span> <span class="n">members</span> <span class="n">that</span> <span class="n">have</span> <span class="n">exceeded</span> <span class="n">the</span> <span class="n">timeout</span><span class="o">.</span> <span class="n">The</span> <span class="n">members</span> <span class="n">are</span> <span class="n">removed</span> <span class="kn">from</span>
<span class="o">//</span> <span class="n">both</span> <span class="n">the</span> <span class="n">old</span> <span class="nb">list</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">members</span> <span class="n">itself</span><span class="o">.</span> <span class="n">Locking</span> <span class="ow">is</span> <span class="n">left</span> <span class="n">to</span> <span class="n">the</span> <span class="n">caller</span><span class="o">.</span>
<span class="n">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Serf</span><span class="p">)</span> <span class="n">reap</span><span class="p">(</span><span class="n">old</span> <span class="p">[]</span><span class="o">*</span><span class="n">memberState</span><span class="p">,</span> <span class="n">timeout</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="n">memberState</span> <span class="p">{</span>
	<span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="o">...</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="o">//</span> <span class="n">Skip</span> <span class="k">if</span> <span class="n">the</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">reached</span>
		<span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">leaveTime</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">timeout</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="o">...</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and m.leaveTime is always initialized by calling time.Now.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-consul-acl-replication-go-173">
<h3>github.com/hashicorp/consul/consul/acl_replication.go:173<a class="headerlink" href="#github-com-hashicorp-consul-consul-acl-replication-go-173" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">([]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;consul&quot;</span><span class="p">,</span> <span class="s2">&quot;leader&quot;</span><span class="p">,</span> <span class="s2">&quot;updateLocalACLs&quot;</span><span class="p">},</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p>This is the canonical way to use the github.com/armon/go-metrics package.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">MeasureSince</span><span class="p">(</span><span class="n">key</span> <span class="p">[]</span><span class="n">string</span><span class="p">,</span> <span class="n">start</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">globalMetrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Metrics</span><span class="p">)</span> <span class="n">MeasureSince</span><span class="p">(</span><span class="n">key</span> <span class="p">[]</span><span class="n">string</span><span class="p">,</span> <span class="n">start</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">elapsed</span> <span class="o">:=</span> <span class="n">now</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
	<span class="n">msec</span> <span class="o">:=</span> <span class="n">float32</span><span class="p">(</span><span class="n">elapsed</span><span class="o">.</span><span class="n">Nanoseconds</span><span class="p">())</span> <span class="o">/</span> <span class="n">float32</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">TimerGranularity</span><span class="p">)</span>
	<span class="n">m</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">AddSample</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-flynn-flynn-vendor-gopkg-in-mgo-v2-session-go-3598">
<h3>github.com/flynn/flynn/vendor/gopkg.in/mgo.v2/session.go:3598<a class="headerlink" href="#github-com-flynn-flynn-vendor-gopkg-in-mgo-v2-session-go-3598" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">iter</span><span class="o">.</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">timeout</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="nb">iter</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">iter</span><span class="o">.</span><span class="n">timedout</span> <span class="o">=</span> <span class="n">true</span>
		<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-huichen-wukong-examples-benchmark-go-173">
<h3>github.com/huichen/wukong/examples/benchmark.go:173<a class="headerlink" href="#github-com-huichen-wukong-examples-benchmark-go-173" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t4</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">done</span> <span class="o">:=</span> <span class="n">make</span><span class="p">(</span><span class="n">chan</span> <span class="nb">bool</span><span class="p">)</span>
<span class="n">recordResponse</span> <span class="o">:=</span> <span class="n">recordResponseLock</span><span class="p">{}</span>
<span class="n">recordResponse</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">iThread</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iThread</span> <span class="o">&lt;</span> <span class="n">numQueryThreads</span><span class="p">;</span> <span class="n">iThread</span><span class="o">++</span> <span class="p">{</span>
	<span class="n">go</span> <span class="n">search</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recordResponse</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">iThread</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iThread</span> <span class="o">&lt;</span> <span class="n">numQueryThreads</span><span class="p">;</span> <span class="n">iThread</span><span class="o">++</span> <span class="p">{</span>
	<span class="o">&lt;-</span><span class="n">done</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">记录时间并计算分词速度</span>
<span class="n">t5</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;搜索平均响应时间 %v 毫秒&quot;</span><span class="p">,</span>
	<span class="n">t5</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">float64</span><span class="p">(</span><span class="n">numRepeatQuery</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">searchQueries</span><span class="p">)))</span>
<span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;搜索吞吐量每秒 %v 次查询&quot;</span><span class="p">,</span>
	<span class="n">float64</span><span class="p">(</span><span class="n">numRepeatQuery</span><span class="o">*</span><span class="n">numQueryThreads</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">searchQueries</span><span class="p">))</span><span class="o">/</span>
		<span class="n">t5</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
</pre></div>
</div>
<p>The first print is “Search average response time %v milliseconds” and the second is “Search Throughput %v queries per second.”</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-ncw-rclone-vendor-google-golang-org-grpc-call-go-171">
<h3>github.com/ncw/rclone/vendor/google.golang.org/grpc/call.go:171<a class="headerlink" href="#github-com-ncw-rclone-vendor-google-golang-org-grpc-call-go-171" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">EnableTracing</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Deadline</span><span class="p">();</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">.</span><span class="n">traceInfo</span><span class="o">.</span><span class="n">firstLine</span><span class="o">.</span><span class="n">deadline</span> <span class="o">=</span> <span class="n">deadline</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here ctx is a context.Context. We should probably arrange for ctx.Deadline to return monotonic times.
If it does, then this code is fixed.
If it does not, then this code is unaffected.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-consul-fsm-go-281">
<h3>github.com/hashicorp/consul/consul/fsm.go:281<a class="headerlink" href="#github-com-hashicorp-consul-consul-fsm-go-281" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">([]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;consul&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm&quot;</span><span class="p">,</span> <span class="s2">&quot;prepared-query&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">Op</span><span class="p">)},</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p>See MeasureSince above.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-docker-libnetwork-vendor-github-com-sirupsen-logrus-text-formatter-go-27">
<h3>github.com/docker/libnetwork/vendor/github.com/Sirupsen/logrus/text_formatter.go:27<a class="headerlink" href="#github-com-docker-libnetwork-vendor-github-com-sirupsen-logrus-text-formatter-go-27" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="p">(</span>
	<span class="n">baseTimestamp</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
	<span class="n">isTerminal</span>    <span class="nb">bool</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">baseTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">isTerminal</span> <span class="o">=</span> <span class="n">IsTerminal</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">miniTS</span><span class="p">()</span> <span class="nb">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">baseTimestamp</span><span class="p">)</span> <span class="o">/</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-flynn-flynn-vendor-golang-org-x-net-http2-go17-go-54">
<h3>github.com/flynn/flynn/vendor/golang.org/x/net/http2/go17.go:54<a class="headerlink" href="#github-com-flynn-flynn-vendor-golang-org-x-net-http2-go17-go-54" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if ci.WasIdle &amp;&amp; !cc.lastActive.IsZero() {
	ci.IdleTime = time.Now().Sub(cc.lastActive)
}
</pre></div>
</div>
<p>See above.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-zyedidia-micro-cmd-micro-eventhandler-go-102">
<h3>github.com/zyedidia/micro/cmd/micro/eventhandler.go:102<a class="headerlink" href="#github-com-zyedidia-micro-cmd-micro-eventhandler-go-102" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Remove</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">remove</span> <span class="n">text</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">executes</span> <span class="n">it</span>
<span class="n">func</span> <span class="p">(</span><span class="n">eh</span> <span class="o">*</span><span class="n">EventHandler</span><span class="p">)</span> <span class="n">Remove</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="n">Loc</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">e</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">TextEvent</span><span class="p">{</span>
		<span class="n">C</span><span class="p">:</span>         <span class="n">eh</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">Cursor</span><span class="p">,</span>
		<span class="n">EventType</span><span class="p">:</span> <span class="n">TextEventRemove</span><span class="p">,</span>
		<span class="n">Start</span><span class="p">:</span>     <span class="n">start</span><span class="p">,</span>
		<span class="n">End</span><span class="p">:</span>       <span class="n">end</span><span class="p">,</span>
		<span class="n">Time</span><span class="p">:</span>      <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">(),</span>
	<span class="p">}</span>
	<span class="n">eh</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The time here is used by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Undo</span> <span class="n">the</span> <span class="n">first</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">undo</span> <span class="n">stack</span>
<span class="n">func</span> <span class="p">(</span><span class="n">eh</span> <span class="o">*</span><span class="n">EventHandler</span><span class="p">)</span> <span class="n">Undo</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">t</span> <span class="o">:=</span> <span class="n">eh</span><span class="o">.</span><span class="n">UndoStack</span><span class="o">.</span><span class="n">Peek</span><span class="p">()</span>
	<span class="o">...</span>
	<span class="n">startTime</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()</span> <span class="o">/</span> <span class="n">int64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">eh</span><span class="o">.</span><span class="n">UndoStack</span><span class="o">.</span><span class="n">Peek</span><span class="p">()</span>
		<span class="o">...</span>
		<span class="k">if</span> <span class="n">startTime</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()</span><span class="o">/</span><span class="n">int64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">undoThreshold</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()</span> <span class="o">/</span> <span class="n">int64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
		<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If this avoided the call to UnixNano (used t.Sub instead), then all the times involved would be monotonic and the elapsed time computation would be independent of wall time. As written, a wall time adjustment during Undo will still break the code. Without any monotonic times, a wall time adjustment before Undo also breaks the code; that no longer happens.</p>
<p>*<em>Fixed.</em></p>
</div>
<div class="section" id="github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-186">
<h3>github.com/ethereum/go-ethereum/cmd/geth/chaincmd.go:186<a class="headerlink" href="#github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-186" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;Compacting entire database...&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">LDB</span><span class="p">()</span><span class="o">.</span><span class="n">CompactRange</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Range</span><span class="p">{});</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="n">utils</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s2">&quot;Compaction failed: %v&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;Compaction done in %v.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-drone-drone-shared-oauth2-oauth2-go-176">
<h3>github.com/drone/drone/shared/oauth2/oauth2.go:176<a class="headerlink" href="#github-com-drone-drone-shared-oauth2-oauth2-go-176" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Expired</span> <span class="n">reports</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">token</span> <span class="n">has</span> <span class="n">expired</span> <span class="ow">or</span> <span class="ow">is</span> <span class="n">invalid</span><span class="o">.</span>
<span class="n">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">Token</span><span class="p">)</span> <span class="n">Expired</span><span class="p">()</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">AccessToken</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">true</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">Expiry</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">Expiry</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>t.Expiry is set with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">ExpiresIn</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
	<span class="n">tok</span><span class="o">.</span><span class="n">Expiry</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">tok</span><span class="o">.</span><span class="n">Expiry</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ExpiresIn</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-coreos-etcd-auth-simple-token-go-88">
<h3>github.com/coreos/etcd/auth/simple_token.go:88<a class="headerlink" href="#github-com-coreos-etcd-auth-simple-token-go-88" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">{</span>
	<span class="n">select</span> <span class="p">{</span>
	<span class="n">case</span> <span class="n">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">tm</span><span class="o">.</span><span class="n">addSimpleTokenCh</span><span class="p">:</span>
		<span class="n">tm</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">simpleTokenTTL</span><span class="p">)</span>
	<span class="n">case</span> <span class="n">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">tm</span><span class="o">.</span><span class="n">resetSimpleTokenCh</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">tm</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">t</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
			<span class="n">tm</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">simpleTokenTTL</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="n">case</span> <span class="n">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">tm</span><span class="o">.</span><span class="n">deleteSimpleTokenCh</span><span class="p">:</span>
		<span class="n">delete</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
	<span class="n">case</span> <span class="o">&lt;-</span><span class="n">tokenTicker</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
		<span class="n">nowtime</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tokenendtime</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">tm</span><span class="o">.</span><span class="n">tokens</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">nowtime</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">tokenendtime</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tm</span><span class="o">.</span><span class="n">deleteTokenFunc</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
				<span class="n">delete</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">case</span> <span class="n">waitCh</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">tm</span><span class="o">.</span><span class="n">stopCh</span><span class="p">:</span>
		<span class="n">tm</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="nb">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
		<span class="n">waitCh</span> <span class="o">&lt;-</span> <span class="n">struct</span><span class="p">{}{}</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-docker-docker-cli-command-node-ps-test-go-105">
<h3>github.com/docker/docker/cli/command/node/ps_test.go:105<a class="headerlink" href="#github-com-docker-docker-cli-command-node-ps-test-go-105" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">[]</span><span class="n">swarm</span><span class="o">.</span><span class="n">Task</span><span class="p">{</span>
	<span class="o">*</span><span class="n">Task</span><span class="p">(</span><span class="n">TaskID</span><span class="p">(</span><span class="s2">&quot;taskID1&quot;</span><span class="p">),</span> <span class="n">ServiceID</span><span class="p">(</span><span class="s2">&quot;failure&quot;</span><span class="p">),</span>
		<span class="n">WithStatus</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)),</span> <span class="n">StatusErr</span><span class="p">(</span><span class="s2">&quot;a task error&quot;</span><span class="p">))),</span>
	<span class="o">*</span><span class="n">Task</span><span class="p">(</span><span class="n">TaskID</span><span class="p">(</span><span class="s2">&quot;taskID2&quot;</span><span class="p">),</span> <span class="n">ServiceID</span><span class="p">(</span><span class="s2">&quot;failure&quot;</span><span class="p">),</span>
		<span class="n">WithStatus</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)),</span> <span class="n">StatusErr</span><span class="p">(</span><span class="s2">&quot;a task error&quot;</span><span class="p">))),</span>
	<span class="o">*</span><span class="n">Task</span><span class="p">(</span><span class="n">TaskID</span><span class="p">(</span><span class="s2">&quot;taskID3&quot;</span><span class="p">),</span> <span class="n">ServiceID</span><span class="p">(</span><span class="s2">&quot;failure&quot;</span><span class="p">),</span>
		<span class="n">WithStatus</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)),</span> <span class="n">StatusErr</span><span class="p">(</span><span class="s2">&quot;a task error&quot;</span><span class="p">))),</span>
<span class="p">},</span> <span class="n">nil</span>
</pre></div>
</div>
<p>It’s just a test, but Timestamp sets the Timestamp field in the swarm.TaskStatus used eventually in docker/cli/command/task/print.go:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span><span class="o">.</span><span class="n">ToLower</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">HumanDuration</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">))),</span>
</pre></div>
</div>
<p>Having a monotonic time in the swam.TaskStatus makes time.Since more accurate.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-docker-docker-integration-cli-docker-api-attach-test-go-130">
<h3>github.com/docker/docker/integration-cli/docker_api_attach_test.go:130<a class="headerlink" href="#github-com-docker-docker-integration-cli-docker-api-attach-test-go-130" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">SetReadDeadline</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-test-e2e-framework-util-go-1696">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/test/e2e/framework/util.go:1696<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-test-e2e-framework-util-go-1696" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">timeout</span> <span class="o">:=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Minute</span>
<span class="k">for</span> <span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-onsi-gomega-internal-asyncassertion-async-assertion-test-go-318">
<h3>github.com/onsi/gomega/internal/asyncassertion/async_assertion_test.go:318<a class="headerlink" href="#github-com-onsi-gomega-internal-asyncassertion-async-assertion-test-go-318" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">failures</span> <span class="o">:=</span> <span class="n">InterceptGomegaFailures</span><span class="p">(</span><span class="n">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">Eventually</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">Should</span><span class="p">(</span><span class="n">Receive</span><span class="p">())</span>
<span class="p">})</span>
<span class="n">Ω</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">Should</span><span class="p">(</span><span class="n">BeNumerically</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="mi">90</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-vault-physical-consul-go-344">
<h3>github.com/hashicorp/vault/physical/consul.go:344<a class="headerlink" href="#github-com-hashicorp-vault-physical-consul-go-344" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">([]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;consul&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">},</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hyperledger-fabric-vendor-golang-org-x-net-context-go17-go-62">
<h3>github.com/hyperledger/fabric/vendor/golang.org/x/net/context/go17.go:62<a class="headerlink" href="#github-com-hyperledger-fabric-vendor-golang-org-x-net-context-go17-go-62" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">WithTimeout</span> <span class="n">returns</span> <span class="n">WithDeadline</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span><span class="o">.</span>
<span class="o">//</span> <span class="o">...</span>
<span class="n">func</span> <span class="n">WithTimeout</span><span class="p">(</span><span class="n">parent</span> <span class="n">Context</span><span class="p">,</span> <span class="n">timeout</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="n">CancelFunc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">WithDeadline</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-consul-state-tombstone-gc-go-134">
<h3>github.com/hashicorp/consul/consul/state/tombstone_gc.go:134<a class="headerlink" href="#github-com-hashicorp-consul-consul-state-tombstone-gc-go-134" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">nextExpires</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">calculate</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">expiration</span> <span class="n">time</span>
<span class="n">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">TombstoneGC</span><span class="p">)</span> <span class="n">nextExpires</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span>
	<span class="n">expires</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span>
	<span class="n">remain</span> <span class="o">:=</span> <span class="n">expires</span><span class="o">.</span><span class="n">UnixNano</span><span class="p">()</span> <span class="o">%</span> <span class="n">int64</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">granularity</span><span class="p">)</span>
	<span class="n">adj</span> <span class="o">:=</span> <span class="n">expires</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">granularity</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">remain</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">adj</span>
<span class="p">}</span>
</pre></div>
</div>
<p>used by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">TombstoneGC</span><span class="p">)</span> <span class="n">Hint</span><span class="p">(</span><span class="n">index</span> <span class="n">uint64</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">expires</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">nextExpires</span><span class="p">()</span>
	<span class="o">...</span>
	<span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">expiration</span> <span class="n">timer</span>
	<span class="n">exp</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">t</span><span class="o">.</span><span class="n">expires</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="o">...</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="o">//</span> <span class="n">Create</span> <span class="n">new</span> <span class="n">expiration</span> <span class="n">time</span>
	<span class="n">t</span><span class="o">.</span><span class="n">expires</span><span class="p">[</span><span class="n">expires</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">expireInterval</span><span class="p">{</span>
		<span class="n">maxIndex</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
		<span class="n">timer</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">AfterFunc</span><span class="p">(</span><span class="n">expires</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()),</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">expireTime</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span>
		<span class="p">}),</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The granularity rounding will usually reuslt in something that can be used in a map key but not always.
The code is using the rounding only as an optimization, so it doesn’t actually matter if a few extra keys get generated.
More importantly, the time passd to time.AfterFunc ends up monotonic, so that timers fire correctly.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-storage-etcd-etcd-helper-go-310">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/storage/etcd/etcd_helper.go:310<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-storage-etcd-etcd-helper-go-310" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startTime</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">metrics</span><span class="o">.</span><span class="n">RecordEtcdRequestLatency</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">getTypeName</span><span class="p">(</span><span class="n">listPtr</span><span class="p">),</span> <span class="n">startTime</span><span class="p">)</span>
</pre></div>
</div>
<p>which ends up in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">RecordEtcdRequestLatency</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">resource</span> <span class="n">string</span><span class="p">,</span> <span class="n">startTime</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">etcdRequestLatenciesSummary</span><span class="o">.</span><span class="n">WithLabelValues</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span><span class="o">.</span><span class="n">Observe</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">startTime</span><span class="p">)</span> <span class="o">/</span> <span class="n">time</span><span class="o">.</span><span class="n">Microsecond</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-pingcap-pd-server-util-go-215">
<h3>github.com/pingcap/pd/server/util.go:215<a class="headerlink" href="#github-com-pingcap-pd-server-util-go-215" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Ctx</span><span class="p">(),</span> <span class="n">requestTimeout</span><span class="p">)</span>
<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Status</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>
<span class="n">cancel</span><span class="p">()</span>

<span class="k">if</span> <span class="n">cost</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">);</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="n">slowRequestTime</span> <span class="p">{</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Warnf</span><span class="p">(</span><span class="s2">&quot;check etcd </span><span class="si">%s</span><span class="s2"> status, resp: %v, err: %v, cost: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-kuberuntime-instrumented-services-go-235">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubelet/kuberuntime/instrumented_services.go:235<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-kuberuntime-instrumented-services-go-235" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="ow">in</span> <span class="n">instrumentedImageManagerService</span><span class="p">)</span> <span class="n">ImageStatus</span><span class="p">(</span><span class="n">image</span> <span class="o">*</span><span class="n">runtimeApi</span><span class="o">.</span><span class="n">ImageSpec</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">runtimeApi</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">defer</span> <span class="n">recordOperation</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
	<span class="o">...</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">recordOperation</span> <span class="n">records</span> <span class="n">the</span> <span class="n">duration</span> <span class="n">of</span> <span class="n">the</span> <span class="n">operation</span><span class="o">.</span>
<span class="n">func</span> <span class="n">recordOperation</span><span class="p">(</span><span class="n">operation</span> <span class="n">string</span><span class="p">,</span> <span class="n">start</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">metrics</span><span class="o">.</span><span class="n">RuntimeOperations</span><span class="o">.</span><span class="n">WithLabelValues</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span><span class="o">.</span><span class="n">Inc</span><span class="p">()</span>
	<span class="n">metrics</span><span class="o">.</span><span class="n">RuntimeOperationsLatency</span><span class="o">.</span><span class="n">WithLabelValues</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span><span class="o">.</span><span class="n">Observe</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">SinceInMicroseconds</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-dockertools-instrumented-docker-go-58">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubelet/dockertools/instrumented_docker.go:58<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubelet-dockertools-instrumented-docker-go-58" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">recordOperation</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed.</strong> (see previous)</p>
</div>
<div class="section" id="github-com-coreos-etcd-tools-functional-tester-etcd-runner-command-global-go-103">
<h3>github.com/coreos/etcd/tools/functional-tester/etcd-runner/command/global.go:103<a class="headerlink" href="#github-com-coreos-etcd-tools-functional-tester-etcd-runner-command-global-go-103" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rcs</span><span class="p">)</span><span class="o">*</span><span class="n">rounds</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
	<span class="n">select</span> <span class="p">{</span>
	<span class="n">case</span> <span class="o">&lt;-</span><span class="n">finished</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;finished </span><span class="si">%d</span><span class="s2">, took %v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
		<span class="p">}</span>
	<span class="n">case</span> <span class="o">&lt;-</span><span class="n">time</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">):</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Panic</span><span class="p">(</span><span class="s2">&quot;no progress after 1 minute!&quot;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-reducedb-encoding-benchtools-benchtools-go-98">
<h3>github.com/reducedb/encoding/benchtools/benchtools.go:98<a class="headerlink" href="#github-com-reducedb-encoding-benchtools-benchtools-go-98" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">codec</span><span class="o">.</span><span class="n">Compress</span><span class="p">(</span><span class="ow">in</span><span class="p">,</span> <span class="n">inpos</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="ow">in</span><span class="p">),</span> <span class="n">out</span><span class="p">,</span> <span class="n">outpos</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>
<span class="n">since</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">Nanoseconds</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-docker-swarm-vendor-github-com-hashicorp-consul-api-semaphore-go-200">
<h3>github.com/docker/swarm/vendor/github.com/hashicorp/consul/api/semaphore.go:200<a class="headerlink" href="#github-com-docker-swarm-vendor-github-com-hashicorp-consul-api-semaphore-go-200" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>	<span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">attempts</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="n">WAIT</span><span class="p">:</span>
	<span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">should</span> <span class="n">quit</span>
	<span class="n">select</span> <span class="p">{</span>
	<span class="n">case</span> <span class="o">&lt;-</span><span class="n">stopCh</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">nil</span>
	<span class="n">default</span><span class="p">:</span>
	<span class="p">}</span>

	<span class="o">//</span> <span class="n">Handle</span> <span class="n">the</span> <span class="n">one</span><span class="o">-</span><span class="n">shot</span> <span class="n">mode</span><span class="o">.</span>
	<span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">SemaphoreTryOnce</span> <span class="o">&amp;&amp;</span> <span class="n">attempts</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="n">elapsed</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">qOpts</span><span class="o">.</span><span class="n">WaitTime</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">nil</span>
		<span class="p">}</span>

		<span class="n">qOpts</span><span class="o">.</span><span class="n">WaitTime</span> <span class="o">-=</span> <span class="n">elapsed</span>
	<span class="p">}</span>
	<span class="n">attempts</span><span class="o">++</span>
	<span class="o">...</span> <span class="n">goto</span> <span class="n">WAIT</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-gravitational-teleport-lib-reversetunnel-localsite-go-83">
<h3>github.com/gravitational/teleport/lib/reversetunnel/localsite.go:83<a class="headerlink" href="#github-com-gravitational-teleport-lib-reversetunnel-localsite-go-83" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">localSite</span><span class="p">)</span> <span class="n">GetLastConnected</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This gets recorded in a services.Site’s LastConnected field, the only use of which is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">LastConnected</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="n">Equals</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-coreos-etcd-tools-benchmark-cmd-watch-go-201">
<h3>github.com/coreos/etcd/tools/benchmark/cmd/watch.go:201<a class="headerlink" href="#github-com-coreos-etcd-tools-benchmark-cmd-watch-go-201" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">st</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">range</span> <span class="n">r</span><span class="o">.</span><span class="n">Events</span> <span class="p">{</span>
	<span class="n">results</span> <span class="o">&lt;-</span> <span class="n">report</span><span class="o">.</span><span class="n">Result</span><span class="p">{</span><span class="n">Start</span><span class="p">:</span> <span class="n">st</span><span class="p">,</span> <span class="n">End</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()}</span>
	<span class="n">bar</span><span class="o">.</span><span class="n">Increment</span><span class="p">()</span>
	<span class="n">atomic</span><span class="o">.</span><span class="n">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nrRecvCompleted</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Those fields get used by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">res</span> <span class="o">*</span><span class="n">Result</span><span class="p">)</span> <span class="n">Duration</span><span class="p">()</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span> <span class="p">{</span> <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">End</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Start</span><span class="p">)</span> <span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span> <span class="n">processResult</span><span class="p">(</span><span class="n">res</span> <span class="o">*</span><span class="n">Result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">Err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">errorDist</span><span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">Err</span><span class="o">.</span><span class="n">Error</span><span class="p">()]</span><span class="o">++</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="n">dur</span> <span class="o">:=</span> <span class="n">res</span><span class="o">.</span><span class="n">Duration</span><span class="p">()</span>
	<span class="n">r</span><span class="o">.</span><span class="n">lats</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="n">dur</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
	<span class="n">r</span><span class="o">.</span><span class="n">avgTotal</span> <span class="o">+=</span> <span class="n">dur</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sps</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">.</span><span class="n">sps</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">Start</span><span class="p">,</span> <span class="n">dur</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The duration computation is fixed by use of monotonic time. The call tp r.sps.Add buckets the start time by converting to Unix seconds and is therefore unaffected (start time only used once other than the duration calculation, so no visible jitter).</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-flynn-flynn-vendor-github-com-flynn-oauth2-internal-token-go-191">
<h3>github.com/flynn/flynn/vendor/github.com/flynn/oauth2/internal/token.go:191<a class="headerlink" href="#github-com-flynn-flynn-vendor-github-com-flynn-oauth2-internal-token-go-191" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">token</span><span class="o">.</span><span class="n">Expiry</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">expires</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
</pre></div>
</div>
<p>used by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">Token</span><span class="p">)</span> <span class="n">expired</span><span class="p">()</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">Expiry</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">Expiry</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="n">expiryDelta</span><span class="p">)</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Only partly fixed because sometimes token.Expiry has been loaded from a JSON serialization of a fixed time. But in the case where the expiry was set from a duration, the duration is now correctly enforced.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-consul-consul-fsm-go-266">
<h3>github.com/hashicorp/consul/consul/fsm.go:266<a class="headerlink" href="#github-com-hashicorp-consul-consul-fsm-go-266" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">([]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;consul&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm&quot;</span><span class="p">,</span> <span class="s2">&quot;coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;batch-update&quot;</span><span class="p">},</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-github-com-coreos-etcd-clientv3-lease-go-437">
<h3>github.com/openshift/origin/vendor/github.com/coreos/etcd/clientv3/lease.go:437<a class="headerlink" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-clientv3-lease-go-437" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">l</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ka</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">l</span><span class="o">.</span><span class="n">keepAlives</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">ka</span><span class="o">.</span><span class="n">nextKeepAlive</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tosend</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">tosend</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">l</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
</pre></div>
</div>
<p>ka.nextKeepAlive is set to either time.Now() or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nextKeepAlive</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">karesp</span><span class="o">.</span><span class="n">TTL</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-ebay-fabio-cert-source-test-go-567">
<h3>github.com/eBay/fabio/cert/source_test.go:567<a class="headerlink" href="#github-com-ebay-fabio-cert-source-test-go-567" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">waitFor</span><span class="p">(</span><span class="n">timeout</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">,</span> <span class="n">up</span> <span class="n">func</span><span class="p">()</span> <span class="nb">bool</span><span class="p">)</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="n">until</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">until</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">false</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">up</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">true</span>
		<span class="p">}</span>
		<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-lucas-clemente-quic-go-ackhandler-sent-packet-handler-test-go-524">
<h3>github.com/lucas-clemente/quic-go/ackhandler/sent_packet_handler_test.go:524<a class="headerlink" href="#github-com-lucas-clemente-quic-go-ackhandler-sent-packet-handler-test-go-524" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">err</span> <span class="o">:=</span> <span class="n">handler</span><span class="o">.</span><span class="n">ReceivedAck</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frames</span><span class="o">.</span><span class="n">AckFrame</span><span class="p">{</span><span class="n">LargestAcked</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">rttStats</span><span class="o">.</span><span class="n">LatestRTT</span><span class="p">())</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">BeNumerically</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">))</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">ReceivedAck</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frames</span><span class="o">.</span><span class="n">AckFrame</span><span class="p">{</span><span class="n">LargestAcked</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="mi">2</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">rttStats</span><span class="o">.</span><span class="n">LatestRTT</span><span class="p">())</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">BeNumerically</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">))</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">ReceivedAck</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frames</span><span class="o">.</span><span class="n">AckFrame</span><span class="p">{</span><span class="n">LargestAcked</span><span class="p">:</span> <span class="mi">6</span><span class="p">},</span> <span class="mi">3</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">NotTo</span><span class="p">(</span><span class="n">HaveOccurred</span><span class="p">())</span>
<span class="n">Expect</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">rttStats</span><span class="o">.</span><span class="n">LatestRTT</span><span class="p">())</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">BeNumerically</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">))</span>
</pre></div>
</div>
<p>where:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">sentPacketHandler</span><span class="p">)</span> <span class="n">ReceivedAck</span><span class="p">(</span><span class="n">ackFrame</span> <span class="o">*</span><span class="n">frames</span><span class="o">.</span><span class="n">AckFrame</span><span class="p">,</span> <span class="n">withPacketNumber</span> <span class="n">protocol</span><span class="o">.</span><span class="n">PacketNumber</span><span class="p">,</span> <span class="n">rcvTime</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">timeDelta</span> <span class="o">:=</span> <span class="n">rcvTime</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">SendTime</span><span class="p">)</span>
	<span class="n">h</span><span class="o">.</span><span class="n">rttStats</span><span class="o">.</span><span class="n">UpdateRTT</span><span class="p">(</span><span class="n">timeDelta</span><span class="p">,</span> <span class="n">ackFrame</span><span class="o">.</span><span class="n">DelayTime</span><span class="p">,</span> <span class="n">rcvTime</span><span class="p">)</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and packet.SendTime is initialized (earlier) with time.Now.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-codislabs-codis-pkg-proxy-redis-conn-go-140">
<h3>github.com/CodisLabs/codis/pkg/proxy/redis/conn.go:140<a class="headerlink" href="#github-com-codislabs-codis-pkg-proxy-redis-conn-go-140" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span><span class="n">connWriter</span><span class="p">)</span> <span class="n">Write</span><span class="p">(</span><span class="n">b</span> <span class="p">[]</span><span class="n">byte</span><span class="p">)</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">w</span><span class="o">.</span><span class="n">LastWrite</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>used by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">FlushEncoder</span><span class="p">)</span> <span class="n">NeedFlush</span><span class="p">()</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">MaxInterval</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Conn</span><span class="o">.</span><span class="n">LastWrite</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">true</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-docker-docker-vendor-github-com-docker-swarmkit-manager-scheduler-scheduler-go-173">
<h3>github.com/docker/docker/vendor/github.com/docker/swarmkit/manager/scheduler/scheduler.go:173<a class="headerlink" href="#github-com-docker-docker-vendor-github-com-docker-swarmkit-manager-scheduler-scheduler-go-173" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">Scheduler</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">var</span> <span class="p">(</span>
		<span class="n">debouncingStarted</span>     <span class="n">time</span><span class="o">.</span><span class="n">Time</span>
		<span class="n">commitDebounceTimer</span>   <span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Timer</span>
	<span class="p">)</span>
	<span class="o">...</span>

	<span class="o">//</span> <span class="n">Watch</span> <span class="k">for</span> <span class="n">changes</span><span class="o">.</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="n">select</span> <span class="p">{</span>
		<span class="n">case</span> <span class="n">event</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">updates</span><span class="p">:</span>
			<span class="n">switch</span> <span class="n">v</span> <span class="o">:=</span> <span class="n">event</span><span class="o">.</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">case</span> <span class="n">state</span><span class="o">.</span><span class="n">EventCommit</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">commitDebounceTimer</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
					<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">debouncingStarted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxLatency</span> <span class="p">{</span>
						<span class="o">...</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">commitDebounceTimer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">NewTimer</span><span class="p">(</span><span class="n">commitDebounceGap</span><span class="p">)</span>
					<span class="n">debouncingStarted</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
					<span class="o">...</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="o">...</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="golang-org-x-net-nettest-conntest-go-361">
<h3>golang.org/x/net/nettest/conntest.go:361<a class="headerlink" href="#golang-org-x-net-nettest-conntest-go-361" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c1</span><span class="o">.</span><span class="n">SetDeadline</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-minio-minio-vendor-github-com-eapache-go-resiliency-breaker-breaker-go-120">
<h3>github.com/minio/minio/vendor/github.com/eapache/go-resiliency/breaker/breaker.go:120<a class="headerlink" href="#github-com-minio-minio-vendor-github-com-eapache-go-resiliency-breaker-breaker-go-120" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expiry</span> <span class="o">:=</span> <span class="n">b</span><span class="o">.</span><span class="n">lastError</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">expiry</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">b</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where b.lastError is set using time.Now.</p>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-pingcap-tidb-store-tikv-client-go-65">
<h3>github.com/pingcap/tidb/store/tikv/client.go:65<a class="headerlink" href="#github-com-pingcap-tidb-store-tikv-client-go-65" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">defer</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">sendReqHistogram</span><span class="o">.</span><span class="n">WithLabelValues</span><span class="p">(</span><span class="s2">&quot;cop&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Observe</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span> <span class="p">}()</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-coreos-etcd-cmd-vendor-golang-org-x-net-context-go17-go-62">
<h3>github.com/coreos/etcd/cmd/vendor/golang.org/x/net/context/go17.go:62<a class="headerlink" href="#github-com-coreos-etcd-cmd-vendor-golang-org-x-net-context-go17-go-62" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">WithDeadline</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed</strong> (see above).</p>
</div>
<div class="section" id="github-com-coreos-rkt-rkt-image-common-test-go-161">
<h3>github.com/coreos/rkt/rkt/image/common_test.go:161<a class="headerlink" href="#github-com-coreos-rkt-rkt-image-common-test-go-161" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">maxAge</span> <span class="o">:=</span> <span class="mi">10</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">tests</span> <span class="p">{</span>
	<span class="n">age</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">age</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="n">got</span> <span class="o">:=</span> <span class="n">useCached</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">maxAge</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">got</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">use</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;expected useCached(%v, %v) to return %v, but it returned %v&quot;</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">maxAge</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">use</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">useCached</span><span class="p">(</span><span class="n">downloadTime</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span> <span class="n">maxAge</span> <span class="nb">int</span><span class="p">)</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="n">freshnessLifetime</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">downloadTime</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
	<span class="k">if</span> <span class="n">maxAge</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">freshnessLifetime</span> <span class="o">&lt;</span> <span class="n">maxAge</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">true</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">false</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-lucas-clemente-quic-go-flowcontrol-flow-controller-go-131">
<h3>github.com/lucas-clemente/quic-go/flowcontrol/flow_controller.go:131<a class="headerlink" href="#github-com-lucas-clemente-quic-go-flowcontrol-flow-controller-go-131" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">lastWindowUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
</pre></div>
</div>
<p>used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lastWindowUpdateTime</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="o">...</span>
<span class="n">timeSinceLastWindowUpdate</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lastWindowUpdateTime</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-serf-serf-snapshot-go-327">
<h3>github.com/hashicorp/serf/serf/snapshot.go:327<a class="headerlink" href="#github-com-hashicorp-serf-serf-snapshot-go-327" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lastFlush</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">flushInterval</span> <span class="p">{</span>
	<span class="n">s</span><span class="o">.</span><span class="n">lastFlush</span> <span class="o">=</span> <span class="n">now</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">buffered</span><span class="o">.</span><span class="n">Flush</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-junegunn-fzf-src-matcher-go-210">
<h3>github.com/junegunn/fzf/src/matcher.go:210<a class="headerlink" href="#github-com-junegunn-fzf-src-matcher-go-210" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startedAt</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="k">for</span> <span class="n">matchesInChunk</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">countChan</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">startedAt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">progressMinDuration</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">.</span><span class="n">eventBox</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">EvtSearchProgress</span><span class="p">,</span> <span class="n">float32</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">/</span><span class="n">float32</span><span class="p">(</span><span class="n">numChunks</span><span class="p">))</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-helloworld-helloworld-go-19">
<h3>github.com/mitchellh/packer/vendor/google.golang.org/appengine/demos/helloworld/helloworld.go:19<a class="headerlink" href="#github-com-mitchellh-packer-vendor-google-golang-org-appengine-demos-helloworld-helloworld-go-19" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">initTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

<span class="n">func</span> <span class="n">handle</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">tmpl</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">initTime</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-ncw-rclone-vendor-google-golang-org-appengine-internal-api-go-549">
<h3>github.com/ncw/rclone/vendor/google.golang.org/appengine/internal/api.go:549<a class="headerlink" href="#github-com-ncw-rclone-vendor-google-golang-org-appengine-internal-api-go-549" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span> <span class="n">logFlusher</span><span class="p">(</span><span class="n">stop</span> <span class="o">&lt;-</span><span class="n">chan</span> <span class="nb">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lastFlush</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">tick</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">NewTicker</span><span class="p">(</span><span class="n">flushInterval</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="n">select</span> <span class="p">{</span>
		<span class="n">case</span> <span class="o">&lt;-</span><span class="n">stop</span><span class="p">:</span>
			<span class="o">//</span> <span class="n">Request</span> <span class="n">finished</span><span class="o">.</span>
			<span class="n">tick</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="n">case</span> <span class="o">&lt;-</span><span class="n">tick</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
			<span class="n">force</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">lastFlush</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">forceFlushInterval</span>
			<span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">flushLog</span><span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lastFlush</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-159">
<h3>github.com/ethereum/go-ethereum/cmd/geth/chaincmd.go:159<a class="headerlink" href="#github-com-ethereum-go-ethereum-cmd-geth-chaincmd-go-159" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;Import done in %v.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-nats-io-nats-test-conn-test-go-652">
<h3>github.com/nats-io/nats/test/conn_test.go:652<a class="headerlink" href="#github-com-nats-io-nats-test-conn-test-go-652" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">firstDisconnect</span> <span class="p">{</span>
	<span class="n">firstDisconnect</span> <span class="o">=</span> <span class="n">false</span>
	<span class="n">dtime1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">dtime2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and later:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">dtime1</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="o">||</span> <span class="p">(</span><span class="n">dtime2</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="o">||</span> <span class="p">(</span><span class="n">rtime</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="o">||</span> <span class="p">(</span><span class="n">atime1</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="o">||</span> <span class="p">(</span><span class="n">atime2</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctime</span> <span class="o">==</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">{})</span> <span class="p">{</span>
	<span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s2">&quot;Some callbacks did not fire:</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v&quot;</span><span class="p">,</span> <span class="n">dtime1</span><span class="p">,</span> <span class="n">rtime</span><span class="p">,</span> <span class="n">atime1</span><span class="p">,</span> <span class="n">atime2</span><span class="p">,</span> <span class="n">dtime2</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">rtime</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">dtime1</span><span class="p">)</span> <span class="o">||</span> <span class="n">dtime2</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">rtime</span><span class="p">)</span> <span class="o">||</span> <span class="n">atime2</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">atime1</span><span class="p">)</span> <span class="o">||</span> <span class="n">ctime</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">atime2</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s2">&quot;Wrong callback order:</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v</span><span class="se">\n</span><span class="s2">%v&quot;</span><span class="p">,</span> <span class="n">dtime1</span><span class="p">,</span> <span class="n">rtime</span><span class="p">,</span> <span class="n">atime1</span><span class="p">,</span> <span class="n">atime2</span><span class="p">,</span> <span class="n">dtime2</span><span class="p">,</span> <span class="n">ctime</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-google-cadvisor-manager-container-go-456">
<h3>github.com/google/cadvisor/manager/container.go:456<a class="headerlink" href="#github-com-google-cadvisor-manager-container-go-456" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Schedule</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">housekeeping</span><span class="o">.</span> <span class="n">Sleep</span> <span class="n">until</span> <span class="n">that</span> <span class="n">time</span><span class="o">.</span>
<span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()))</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nb">next</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">lastHousekeeping</span> <span class="o">=</span> <span class="nb">next</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-google-cadvisor-vendor-golang-org-x-oauth2-token-go-98">
<h3>github.com/google/cadvisor/vendor/golang.org/x/oauth2/token.go:98<a class="headerlink" href="#github-com-google-cadvisor-vendor-golang-org-x-oauth2-token-go-98" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">Expiry</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="n">expiryDelta</span><span class="p">)</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed</strong> (see above).</p>
</div>
<div class="section" id="github-com-hashicorp-consul-consul-fsm-go-109">
<h3>github.com/hashicorp/consul/consul/fsm.go:109<a class="headerlink" href="#github-com-hashicorp-consul-consul-fsm-go-109" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">metrics</span><span class="o">.</span><span class="n">MeasureSince</span><span class="p">([]</span><span class="n">string</span><span class="p">{</span><span class="s2">&quot;consul&quot;</span><span class="p">,</span> <span class="s2">&quot;fsm&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">},</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-hashicorp-vault-vendor-github-com-hashicorp-yamux-session-go-295">
<h3>github.com/hashicorp/vault/vendor/github.com/hashicorp/yamux/session.go:295<a class="headerlink" href="#github-com-hashicorp-vault-vendor-github-com-hashicorp-yamux-session-go-295" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">a</span> <span class="n">response</span>
<span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>

<span class="o">//</span> <span class="n">Compute</span> <span class="n">the</span> <span class="n">RTT</span>
<span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">nil</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-go-kit-kit-examples-shipping-booking-instrumenting-go-31">
<h3>github.com/go-kit/kit/examples/shipping/booking/instrumenting.go:31<a class="headerlink" href="#github-com-go-kit-kit-examples-shipping-booking-instrumenting-go-31" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defer</span> <span class="n">func</span><span class="p">(</span><span class="n">begin</span> <span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">s</span><span class="o">.</span><span class="n">requestCount</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">s</span><span class="o">.</span><span class="n">requestLatency</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;book&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Observe</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())</span>
<span class="p">}(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">())</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-cyfdecyf-cow-timeoutset-go-22">
<h3>github.com/cyfdecyf/cow/timeoutset.go:22<a class="headerlink" href="#github-com-cyfdecyf-cow-timeoutset-go-22" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">ts</span> <span class="o">*</span><span class="n">TimeoutSet</span><span class="p">)</span> <span class="n">add</span><span class="p">(</span><span class="n">key</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
	<span class="n">ts</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>used by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>func (ts *TimeoutSet) has(key string) bool {
	ts.RLock()
	t, ok := ts.time[key]
	ts.RUnlock()
	if !ok {
		return false
	}
	if time.Now().Sub(t) &gt; ts.timeout {
		ts.del(key)
		return false
	}
	return true
}
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-prometheus-prometheus-vendor-k8s-io-client-go-1-5-rest-request-go-761">
<h3>github.com/prometheus/prometheus/vendor/k8s.io/client-go/1.5/rest/request.go:761<a class="headerlink" href="#github-com-prometheus-prometheus-vendor-k8s-io-client-go-1-5-rest-request-go-761" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Metrics</span> <span class="k">for</span> <span class="n">total</span> <span class="n">request</span> <span class="n">latency</span>
<span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">defer</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">metrics</span><span class="o">.</span><span class="n">RequestLatency</span><span class="o">.</span><span class="n">Observe</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">verb</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">finalURLTemplate</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
<span class="p">}()</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-ethereum-go-ethereum-p2p-discover-udp-go-383">
<h3>github.com/ethereum/go-ethereum/p2p/discover/udp.go:383<a class="headerlink" href="#github-com-ethereum-go-ethereum-p2p-discover-udp-go-383" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">select</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">case</span> <span class="n">p</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">t</span><span class="o">.</span><span class="n">addpending</span><span class="p">:</span>
		<span class="n">p</span><span class="o">.</span><span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">respTimeout</span><span class="p">)</span>
		<span class="o">...</span>

	<span class="n">case</span> <span class="n">now</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">timeout</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
		<span class="o">//</span> <span class="n">Notify</span> <span class="ow">and</span> <span class="n">remove</span> <span class="n">callbacks</span> <span class="n">whose</span> <span class="n">deadline</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">past</span><span class="o">.</span>
		<span class="k">for</span> <span class="n">el</span> <span class="o">:=</span> <span class="n">plist</span><span class="o">.</span><span class="n">Front</span><span class="p">();</span> <span class="n">el</span> <span class="o">!=</span> <span class="n">nil</span><span class="p">;</span> <span class="n">el</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">:=</span> <span class="n">el</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">pending</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">deadline</span><span class="p">)</span> <span class="o">||</span> <span class="n">now</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">deadline</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">...</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed</strong> assuming time channels receive monotonic times as well.</p>
</div>
<div class="section" id="k8s-io-heapster-metrics-sinks-manager-go-150">
<h3>k8s.io/heapster/metrics/sinks/manager.go:150<a class="headerlink" href="#k8s-io-heapster-metrics-sinks-manager-go-150" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startTime</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="n">defer</span> <span class="n">exporterDuration</span><span class="o">.</span>
	<span class="n">WithLabelValues</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span><span class="o">.</span>
	<span class="n">Observe</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">startTime</span><span class="p">))</span> <span class="o">/</span> <span class="n">float64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Microsecond</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-vmware-harbor-src-ui-auth-lock-go-43">
<h3>github.com/vmware/harbor/src/ui/auth/lock.go:43<a class="headerlink" href="#github-com-vmware-harbor-src-ui-auth-lock-go-43" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">ul</span> <span class="o">*</span><span class="n">UserLock</span><span class="p">)</span> <span class="n">Lock</span><span class="p">(</span><span class="n">username</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">ul</span><span class="o">.</span><span class="n">failures</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>used by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="p">(</span><span class="n">ul</span> <span class="o">*</span><span class="n">UserLock</span><span class="p">)</span> <span class="n">IsLocked</span><span class="p">(</span><span class="n">username</span> <span class="n">string</span><span class="p">)</span> <span class="nb">bool</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">ul</span><span class="o">.</span><span class="n">failures</span><span class="p">[</span><span class="n">username</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">ul</span><span class="o">.</span><span class="n">d</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubectl-resource-printer-test-go-1410">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/kubectl/resource_printer_test.go:1410<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-kubectl-resource-printer-test-go-1410" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;an hour ago&quot;</span><span class="p">,</span> <span class="n">translateTimestamp</span><span class="p">(</span><span class="n">unversioned</span><span class="o">.</span><span class="n">Time</span><span class="p">{</span><span class="n">Time</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mf">6e12</span><span class="p">)}),</span> <span class="s2">&quot;1h&quot;</span><span class="p">},</span>
</pre></div>
</div>
<p>where</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">translateTimestamp</span><span class="p">(</span><span class="n">timestamp</span> <span class="n">unversioned</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="n">string</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">shortHumanDuration</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">Time</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-pingcap-pd-server-kv-go-194">
<h3>github.com/pingcap/pd/server/kv.go:194<a class="headerlink" href="#github-com-pingcap-pd-server-kv-go-194" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientv3</span><span class="o">.</span><span class="n">NewKV</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cost</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">start</span><span class="p">);</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="n">kvSlowRequestTime</span> <span class="p">{</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Warnf</span><span class="p">(</span><span class="s2">&quot;kv gets too slow: key %v cost %v err %v&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-xtaci-kcp-go-sess-go-489">
<h3>github.com/xtaci/kcp-go/sess.go:489<a class="headerlink" href="#github-com-xtaci-kcp-go-sess-go-489" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">lastPing</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">interval</span><span class="p">))</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="n">lastPing</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-go-xorm-xorm-lru-cacher-go-202">
<h3>github.com/go-xorm/xorm/lru_cacher.go:202<a class="headerlink" href="#github-com-go-xorm-xorm-lru-cacher-go-202" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">el</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">sqlNode</span><span class="p">)</span><span class="o">.</span><span class="n">lastVisit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
</pre></div>
</div>
<p>used as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">removedNum</span> <span class="o">&lt;=</span> <span class="n">core</span><span class="o">.</span><span class="n">CacheGcMaxRemoved</span> <span class="o">&amp;&amp;</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">idNode</span><span class="p">)</span><span class="o">.</span><span class="n">lastVisit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">Expired</span> <span class="p">{</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-github-com-samuel-go-zookeeper-zk-conn-go-510">
<h3>github.com/openshift/origin/vendor/github.com/samuel/go-zookeeper/zk/conn.go:510<a class="headerlink" href="#github-com-openshift-origin-vendor-github-com-samuel-go-zookeeper-zk-conn-go-510" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">.</span><span class="n">SetWriteDeadline</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">recvTimeout</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-client-leaderelection-leaderelection-go-236">
<h3>github.com/openshift/origin/vendor/k8s.io/kubernetes/pkg/client/leaderelection/leaderelection.go:236<a class="headerlink" href="#github-com-openshift-origin-vendor-k8s-io-kubernetes-pkg-client-leaderelection-leaderelection-go-236" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">le</span><span class="o">.</span><span class="n">observedTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
</pre></div>
</div>
<p>used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">le</span><span class="o">.</span><span class="n">observedTime</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LeaseDuration</span><span class="p">)</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="k8s-io-heapster-events-sinks-manager-go-139">
<h3>k8s.io/heapster/events/sinks/manager.go:139<a class="headerlink" href="#k8s-io-heapster-events-sinks-manager-go-139" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startTime</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="n">defer</span> <span class="n">exporterDuration</span><span class="o">.</span>
	<span class="n">WithLabelValues</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span><span class="o">.</span>
	<span class="n">Observe</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">startTime</span><span class="p">))</span> <span class="o">/</span> <span class="n">float64</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Microsecond</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="golang-org-x-net-ipv4-unicast-test-go-64">
<h3>golang.org/x/net/ipv4/unicast_test.go:64<a class="headerlink" href="#golang-org-x-net-ipv4-unicast-test-go-64" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span> <span class="n">p</span><span class="o">.</span><span class="n">SetReadDeadline</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">))</span> <span class="o">...</span>
</pre></div>
</div>
<p><strong>Fixed.</strong></p>
</div>
<div class="section" id="github-com-kelseyhightower-confd-vendor-github-com-sirupsen-logrus-text-formatter-go-27">
<h3>github.com/kelseyhightower/confd/vendor/github.com/Sirupsen/logrus/text_formatter.go:27<a class="headerlink" href="#github-com-kelseyhightower-confd-vendor-github-com-sirupsen-logrus-text-formatter-go-27" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">baseTimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">isTerminal</span> <span class="o">=</span> <span class="n">IsTerminal</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">miniTS</span><span class="p">()</span> <span class="nb">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">baseTimestamp</span><span class="p">)</span> <span class="o">/</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Fixed</strong> (same as above, vendored in docker/libnetwork).</p>
</div>
<div class="section" id="github-com-openshift-origin-vendor-github-com-coreos-etcd-etcdserver-v3-server-go-693">
<h3>github.com/openshift/origin/vendor/github.com/coreos/etcd/etcdserver/v3_server.go:693<a class="headerlink" href="#github-com-openshift-origin-vendor-github-com-coreos-etcd-etcdserver-v3-server-go-693" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>
<span class="o">...</span>
<span class="k">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">parseProposeCtxErr</span><span class="p">(</span><span class="n">cctx</span><span class="o">.</span><span class="n">Err</span><span class="p">(),</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>where</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curLeadElected</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">leadElectedTime</span><span class="p">()</span>
<span class="n">prevLeadLost</span> <span class="o">:=</span> <span class="n">curLeadElected</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Cfg</span><span class="o">.</span><span class="n">ElectionTicks</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Cfg</span><span class="o">.</span><span class="n">TickMs</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
<span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">prevLeadLost</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">start</span><span class="o">.</span><span class="n">Before</span><span class="p">(</span><span class="n">curLeadElected</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">ErrTimeoutDueToLeaderFail</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All the times involved end up being monotonic, making the After/Before checks more accurate.</p>
<p><strong>Fixed.</strong></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="13073-code-of-conduct.html" class="btn btn-neutral float-right" title="Proposal: A Code of Conduct for the Go community" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="12800-sweep-free-alloc.html" class="btn btn-neutral float-left" title="Proposal: Dense mark bits and sweep-free allocation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>