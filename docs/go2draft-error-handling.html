

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Error Handling — Draft Design &mdash; Go Design Proposal  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Error Handling — Problem Overview" href="go2draft-error-handling-overview.html" />
    <link rel="prev" title="Contracts — Draft Design" href="go2draft-contracts.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Go Design Proposal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="11502-securitypolicy.html">Proposal: Security Policy for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="11970-decentralized-gc.html">Proposal: Decentralized GC coordination</a></li>
<li class="toctree-l1"><a class="reference internal" href="12166-subtests.html">Proposal: testing: programmatic sub-test and sub-benchmark support</a></li>
<li class="toctree-l1"><a class="reference internal" href="12302-release-proposal.html">Proposal: A minimal release process for Go repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="12416-cgo-pointers.html">Proposal: Rules for passing pointers between Go and C</a></li>
<li class="toctree-l1"><a class="reference internal" href="12750-localization.html">Proposal: Localization support in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12800-sweep-free-alloc.html">Proposal: Dense mark bits and sweep-free allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html">Proposal: Monotonic Elapsed Time Measurements in Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="12914-monotonic.html#appendix-time-now-usage">Appendix: time.Now usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="13073-code-of-conduct.html">Proposal: A Code of Conduct for the Go community</a></li>
<li class="toctree-l1"><a class="reference internal" href="13432-mobile-audio.html">Proposal: Audio for Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="13504-natural-xml.html">Proposal: Natural XML</a></li>
<li class="toctree-l1"><a class="reference internal" href="14313-benchmark-format.html">Proposal: Go Benchmark Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="14386-zip-package-archives.html">Proposal: Zip-based Go package archives</a></li>
<li class="toctree-l1"><a class="reference internal" href="14951-soft-heap-limit.html">Proposal: Separate soft and hard heap size goal</a></li>
<li class="toctree-l1"><a class="reference internal" href="15292-generics.html">Proposal: Go should have generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="16085-conversions-ignore-tags.html">Proposal: Ignore tags in struct type conversions</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html">Proposal: Alias declarations for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="16339-alias-decls.html#appendix">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="16410-heap-viewer.html">Proposal: Go Heap Dump Viewer</a></li>
<li class="toctree-l1"><a class="reference internal" href="16704-cidr-notation-no-proxy.html">Proposal: Add support for CIDR notation in no_proxy variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="17280-profile-labels.html">Proposal: Support for pprof profiler labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="17503-eliminate-rescan.html">Proposal: Eliminate STW stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="17505-concurrent-rescan.html">Proposal: Concurrent stack re-scanning</a></li>
<li class="toctree-l1"><a class="reference internal" href="18130-type-alias.html">Proposal: Type Aliases</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html">Proposal: percpu.Sharded, an API for reducing cache contention</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#discussion">Discussion</a></li>
<li class="toctree-l1"><a class="reference internal" href="18802-percpu-sharded.html#backwards-compatibility">Backwards compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19113-signed-shift-counts.html">Proposal: Permit Signed Integers as Shift Counts for Go 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="19308-number-literals.html">Proposal: Go 2 Number Literal Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html">Proposal: Mid-stack inlining in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#proposal">Proposal</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#rationale">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="19348-midstack-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="19480-xml-stream.html">Proposal: XML Stream</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html">Proposal: emit DWARF inlining info in the Go compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#abstract">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#background">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#example">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#how-the-generated-dwarf-should-look">How the generated DWARF should look</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#outline-of-proposed-changes">Outline of proposed changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#compatibility">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#implementation">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#prerequisite-changes">Prerequisite Changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#preliminary-results">Preliminary Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="22080-dwarf-inlining.html#open-issues">Open issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="24301-versioned-go.html">Proposal: Versioned Go Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="24543-non-cooperative-preemption.html">Proposal: Non-cooperative goroutine preemption</a></li>
<li class="toctree-l1"><a class="reference internal" href="25530-sumdb.html">Proposal: Secure the Public Go Module Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="25719-go15vendor.html">Go 1.5 Vendor Experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="26160-dns-based-vanity-imports.html">Proposal: DNS Based Vanity Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="26756-rawxml-token.html">Proposal: Raw XML Token</a></li>
<li class="toctree-l1"><a class="reference internal" href="26903-simplify-mark-termination.html">Proposal: Simplify mark termination and eliminate mark 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="27539-internal-abi.html">Proposal: Create an undefined internal calling convention</a></li>
<li class="toctree-l1"><a class="reference internal" href="2775-binary-only-packages.html">Proposal: Binary-Only Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="27935-unbounded-queue-package.html">Proposal: Built in support for high performance unbounded queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="28221-go2-transitions.html">Proposal: Go 2 transition</a></li>
<li class="toctree-l1"><a class="reference internal" href="2981-go-test-json.html">Proposal: <code class="docutils literal notranslate"><span class="pre">-json</span></code> flag in <code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="29934-error-values.html">Proposal: Go 2 Error Inspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="30333-smarter-scavenging.html">Proposal: Smarter Scavenging</a></li>
<li class="toctree-l1"><a class="reference internal" href="30411-env.html">Proposal: <code class="docutils literal notranslate"><span class="pre">go</span></code> command configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="32437-try-builtin.html">Proposal: A built-in Go error check function, <code class="docutils literal notranslate"><span class="pre">try</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="33974-add-public-lockedfile-pkg.html">Proposal: make the internal lockedfile package public</a></li>
<li class="toctree-l1"><a class="reference internal" href="34481-opencoded-defers.html">Proposal: Low-cost defers through inline code, and extra funcdata to manage the panic case</a></li>
<li class="toctree-l1"><a class="reference internal" href="35112-scaling-the-page-allocator.html">Proposal: Scaling the Go page allocator</a></li>
<li class="toctree-l1"><a class="reference internal" href="36460-lazy-module-loading.html">Proposal: Lazy Module Loading</a></li>
<li class="toctree-l1"><a class="reference internal" href="36606-64-bit-field-alignment.html">Proposal: Make 64-bit fields be 64-bit aligned on 32-bit systems, add //go:packed, //go:align directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="37112-unstable-runtime-metrics.html">Proposal: API for unstable runtime metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="37720-gopls-workspaces.html">Proposal: Multi-project gopls workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="4899-testing-helper.html">Proposal: testing: better support test helper functions with TB.Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="6282-table-data.html">Proposal: Multi-dimensional slices</a></li>
<li class="toctree-l1"><a class="reference internal" href="6977-overlapping-interfaces.html">Proposal: Permit embedding of interfaces with overlapping method sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="TEMPLATE.html">Proposal: [Title]</a></li>
<li class="toctree-l1"><a class="reference internal" href="cryptography-principles.html">Cryptography Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft.html">Go 2 Draft Designs</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-contracts.html">Contracts — Draft Design</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Error Handling — Draft Design</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design">Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#checks">Checks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#handlers">Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#default-handler">Default handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stack-frame-preservation">Stack frame preservation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variable-shadowing">Variable shadowing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#draft-spec">Draft spec</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discussion">Discussion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#other-considerations">Other considerations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#keyword-try-versus-check">Keyword: try versus check</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keyword-handle-versus-catch">Keyword: handle versus catch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#checking-error-returns-from-deferred-calls">Checking error returns from deferred calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-check-else-statement">A check-else statement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#considered-ideas">Considered Ideas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-a-operator-instead-of-check">Using a ? operator instead of check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#comparisons">Comparisons</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#midori">Midori</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-proposal">C++ proposal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rust">Rust</a></li>
<li class="toctree-l3"><a class="reference internal" href="#swift">Swift</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-handling-overview.html">Error Handling — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-inspection.html">Error Inspection — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-printing.html">Error Printing — Draft Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-error-values-overview.html">Error Values — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-generics-overview.html">Generics — Problem Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="go2draft-type-parameters.html">Type Parameters - Draft Design</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Go Design Proposal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Error Handling — Draft Design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/go2draft-error-handling.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="error-handling-draft-design">
<h1>Error Handling — Draft Design<a class="headerlink" href="#error-handling-draft-design" title="Permalink to this headline">¶</a></h1>
<p>Marcel van Lohuizen<br />August 27, 2018</p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>We present a draft design to extend the Go language with dedicated error handling constructs.
These constructs are in the spirit of “<a class="reference external" href="https://blog.golang.org/errors-are-values">errors are values</a>”
but aim to reduce the verbosity of handling errors.</p>
<p>For more context, see the <a class="reference internal" href="go2draft-error-handling-overview.html"><span class="doc">error handling problem overview</span></a>.</p>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>There have been many proposals over time to improve error handling in Go. For instance, see:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://golang.org/issue/21161">golang.org/issue/21161</a>: simplify error handling with <code class="docutils literal notranslate"><span class="pre">||</span> <span class="pre">err</span></code> suffix</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/18721">golang.org/issue/18721</a>: add “must” operator <code class="docutils literal notranslate"><span class="pre">#</span></code> to check and return error</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/16225">golang.org/issue/16225</a>: add functionality to remove repetitive <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">err</span> <span class="pre">!=</span> <span class="pre">nil</span></code> return</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/21182">golang.org/issue/21182</a>: reduce noise in return statements that contain mostly zero values</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/19727">golang.org/issue/19727</a>: add vet check for test of wrong <code class="docutils literal notranslate"><span class="pre">err</span></code> variable</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/19642">golang.org/issue/19642</a>: define <code class="docutils literal notranslate"><span class="pre">_</span></code> on right-hand side of assignment as zero value</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/19991">golang.org/issue/19991</a>: add built-in result type, like Rust, OCaml</p></li>
</ul>
<p>Related, but not addressed by this proposal:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://golang.org/issue/20803">golang.org/issue/20803</a>: require call results to be used or explicitly gnored</p></li>
<li><p><a class="reference external" href="https://golang.org/issue/19511">golang.org/issue/19511</a>: “Writing Web Applications” ignores error from <code class="docutils literal notranslate"><span class="pre">ListenAndServe</span></code></p></li>
<li><p><a class="reference external" href="https://golang.org/issue/20148">golang.org/issue/20148</a>: add vet check for missing test of returned error</p></li>
</ul>
<p>We have also consulted the <a class="reference external" href="https://golang.org/wiki/ExperienceReports#error-handling">experience reports about error handling</a>.</p>
<p>Many of the proposals focus on verbosity.
both the verbosity of having to check error values
and the verbosity of zeroing out non-error return values.
Other proposals address issues related to correctness,
like error variable shadowing or the relative ease with which one can forget to check an error value.</p>
<p>This draft design incorporates many of the suggestions made in these issues.</p>
</div>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>This draft design builds upon the convention in Go programs
that a function that can fail
returns an <code class="docutils literal notranslate"><span class="pre">error</span></code> value as its final result.</p>
<p>This draft design introduces the keywords <code class="docutils literal notranslate"><span class="pre">check</span></code> and <code class="docutils literal notranslate"><span class="pre">handle</span></code>,
which we will introduce first by example.</p>
<p>Today, errors are commonly handled in Go using the following pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">y</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">check</span></code>/<code class="docutils literal notranslate"><span class="pre">handle</span></code> construct, we can instead write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="k">return</span> <span class="n">err</span> <span class="p">}</span>
	<span class="n">x</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For each check, there is an implicit handler chain function,
explained in more detail below.
Here, the handler chain is the same for each check
and is defined by the single <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement to be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">handleChain</span><span class="p">(</span><span class="n">err</span> <span class="n">error</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The handler chain is only presented here as a function to define its semantics;
it is likely to be implemented differently inside the Go compiler.</p>
<div class="section" id="checks">
<h3>Checks<a class="headerlink" href="#checks" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">check</span></code> applies to an expression of type <code class="docutils literal notranslate"><span class="pre">error</span></code>
or a function call returning a list of values ending in
a value of type <code class="docutils literal notranslate"><span class="pre">error</span></code>.
If the error is non-nil.
A <code class="docutils literal notranslate"><span class="pre">check</span></code> returns from the enclosing function
by returning the result of invoking the handler chain
with the error value.
A <code class="docutils literal notranslate"><span class="pre">check</span></code> expression applied to a function call returning multiple results
evaluates to the result of that call with the final error result removed.
A <code class="docutils literal notranslate"><span class="pre">check</span></code> expression applied to a plain expression or to a function call returning only an error value
cannot itself be used as a value; it can only appear as an expression statement.</p>
<p>Given new variables <code class="docutils literal notranslate"><span class="pre">v1</span></code>, <code class="docutils literal notranslate"><span class="pre">v2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">vN</span></code>, <code class="docutils literal notranslate"><span class="pre">vErr</span></code>,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">vN</span> <span class="o">:=</span> <span class="n">check</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">vN</span><span class="p">,</span> <span class="n">vErr</span> <span class="o">:=</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
<span class="k">if</span> <span class="n">vErr</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="n">error</span> <span class="n">result</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">handlerChain</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">vErr</span></code> must have type <code class="docutils literal notranslate"><span class="pre">error</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;error</span> <span class="pre">result&gt;</span></code> denotes
the (possibly unnamed) error result from the enclosing function.
Similarly,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span><span class="p">(</span><span class="n">check</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">vN</span><span class="p">,</span> <span class="n">vErr</span> <span class="o">:=</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
<span class="k">if</span> <span class="n">vErr</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="n">error</span> <span class="n">result</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">handlerChain</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="n">foo</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">vN</span><span class="p">)</span>
</pre></div>
</div>
<p>If the enclosing function has no final error result,
a failing <code class="docutils literal notranslate"><span class="pre">check</span></code> calls <code class="docutils literal notranslate"><span class="pre">handlerChain</span></code> followed by a return.</p>
<p>Since a <code class="docutils literal notranslate"><span class="pre">check</span></code> is an expression, we could write the <code class="docutils literal notranslate"><span class="pre">printSum</span></code> example above as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="k">return</span> <span class="n">err</span> <span class="p">}</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For purposes of order of evaluation, <code class="docutils literal notranslate"><span class="pre">check</span></code> expressions are treated as equivalent to function calls.</p>
<p>In general, the syntax of <code class="docutils literal notranslate"><span class="pre">check</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UnaryExpr</span>  <span class="o">=</span> <span class="n">PrimaryExpr</span> <span class="o">|</span> <span class="n">unary_op</span> <span class="n">UnaryExpr</span> <span class="o">|</span> <span class="n">CheckExpr</span> <span class="o">.</span>
<span class="n">CheckExpr</span>  <span class="o">=</span> <span class="s2">&quot;check&quot;</span> <span class="n">UnaryExpr</span> <span class="o">.</span>
</pre></div>
</div>
<p>It is common for idiomatic Go code to wrap the error with context information.
Suppose our original example wrapped the error with the name of the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;printSum(%q + %q): %v&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">y</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;printSum(%q + %q): %v&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using a handler allows writing the wrapping just once:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;printSum(%q + %q): %v&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">x</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is not necessary to vary the wrapping code to determine where in <code class="docutils literal notranslate"><span class="pre">printSum</span></code> the error occurred:
The error returned by <code class="docutils literal notranslate"><span class="pre">strconv.Atoi</span></code> will include its argument.
This design encourages writing more idiomatic and cleaner error messages
and is in keeping with existing Go practice, at least in the standard library.</p>
</div>
<div class="section" id="handlers">
<h3>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement defines a block, called a <em>handler</em>, to handle an error detected by a <code class="docutils literal notranslate"><span class="pre">check</span></code>.
A <code class="docutils literal notranslate"><span class="pre">return</span></code> statement in a handler
causes the enclosing function to return immediately with the given return values.
A <code class="docutils literal notranslate"><span class="pre">return</span></code> without values is only allowed if the enclosing function
has no results or uses named results.
In the latter case,  the function returns with the current values
of those results.</p>
<p>The syntax for a <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Statement   = Declaration | … | DeferStmt | HandleStmt .
HandleStmt  = &quot;handle&quot; identifier Block .
</pre></div>
</div>
<p>A <em>handler chain function</em> takes an argument of type <code class="docutils literal notranslate"><span class="pre">error</span></code>
and has the same result signature as the function
for which it is defined.
It executes all handlers in lexical scope in reverse order of declaration
until one of them executes a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.
The identifier used in each <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement
maps to the argument of the handler chain function.</p>
<p>Each check may have a different handler chain function
depending on the scope in which it is defined. For example, consider this function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">process</span><span class="p">(</span><span class="n">user</span> <span class="n">string</span><span class="p">,</span> <span class="n">files</span> <span class="n">chan</span> <span class="n">string</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="nb">int</span><span class="p">,</span> <span class="n">err</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;process: %v&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>  <span class="p">}</span>      <span class="o">//</span> <span class="n">handler</span> <span class="n">A</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="n">err</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;attempt </span><span class="si">%d</span><span class="s2">: %v&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="p">}</span> <span class="o">//</span> <span class="n">handler</span> <span class="n">B</span>
        <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="n">err</span> <span class="o">=</span> <span class="n">moreWrapping</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>                    <span class="o">//</span> <span class="n">handler</span> <span class="n">C</span>

        <span class="n">check</span> <span class="n">do</span><span class="p">(</span><span class="n">something</span><span class="p">())</span>  <span class="o">//</span> <span class="n">check</span> <span class="mi">1</span><span class="p">:</span> <span class="n">handler</span> <span class="n">chain</span> <span class="n">C</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A</span>
    <span class="p">}</span>
    <span class="n">check</span> <span class="n">do</span><span class="p">(</span><span class="n">somethingElse</span><span class="p">())</span>  <span class="o">//</span> <span class="n">check</span> <span class="mi">2</span><span class="p">:</span> <span class="n">handler</span> <span class="n">chain</span> <span class="n">A</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Check 1, inside the loop, runs handlers C, B, and A, in that order.
Note that because <code class="docutils literal notranslate"><span class="pre">handle</span></code> is lexically scoped,
the handlers defined in the loop body do not accumulate
on each new iteration, in contrast to <code class="docutils literal notranslate"><span class="pre">defer</span></code>.</p>
<p>Check 2, at the end of the function, runs only handler A,
no matter how many times the loop executed.</p>
<p>It is a compile-time error for a handler chain function body to be empty:
there must be at least one handler, which may be a default handler.</p>
<p>As a consequence of what we have introduced so far:</p>
<ul class="simple">
<li><p>There is no way to resume control in the enclosing function after <code class="docutils literal notranslate"><span class="pre">check</span></code> detects an error.</p></li>
<li><p>Any handler always executes before any deferred functions are executed.</p></li>
<li><p>If the enclosing function has result parameters, it is a compile-time error if the handler chain for any check
is not guaranteed to execute a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.</p></li>
</ul>
<p>A panic in a handler executes as if it occurred in the enclosing function.</p>
</div>
<div class="section" id="default-handler">
<h3>Default handler<a class="headerlink" href="#default-handler" title="Permalink to this headline">¶</a></h3>
<p>All functions whose last result is of type <code class="docutils literal notranslate"><span class="pre">error</span></code> begin with an implicit <em>default handler</em>.
The default handler assigns the error argument to the last result and then returns,
using the other results unchanged.
In functions without named results, this means using zero values for the leading results.
In functions with named results, this means using the current values of those results.</p>
<p>Relying on the default handler, <code class="docutils literal notranslate"><span class="pre">printSum</span></code> can be rewritten as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">printSum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">x</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The default handler eliminates one of the motivations for
<a class="reference external" href="https://golang.org/issue/19642">golang.org/issue/19642</a>
(using <code class="docutils literal notranslate"><span class="pre">_</span></code> to mean a zero value, to make explicit error returns shorter).</p>
<p>In case of named return values,
the default handler does not guarantee the non-error return values will be zeroed:
the user may have assigned values to them earlier.
In this case it will still be necessary to specify the zero values explicitly,
but at least it will only have to be done once.</p>
</div>
<div class="section" id="stack-frame-preservation">
<h3>Stack frame preservation<a class="headerlink" href="#stack-frame-preservation" title="Permalink to this headline">¶</a></h3>
<p>Some error handling packages, like <a class="reference external" href="https://github.com/pkg/errors">github.com/pkg/errors</a>,
decorate errors with stack traces.
To preserve the ability to provide this information,
a handler chain appears to the runtime
as if it were called by the enclosing function,
in its own stack frame.
The <code class="docutils literal notranslate"><span class="pre">check</span></code> expression appears in the stack
as the caller of the handler chain.</p>
<p>There should be some helper-like mechanism to allow skipping
over handler stack frames. This will allow code like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">TestFoo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tc</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">testCases</span> <span class="p">{</span>
		<span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="n">y</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;Foo(%v) != Foo(%v)&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>to be rewritten as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">TestFoo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tc</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">testCases</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">Foo</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">Foo</span><span class="p">(</span><span class="n">tc</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;Foo(%v) != Foo(%v)&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">tc</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>while keeping the error line information useful. Perhaps it would be enough to allow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span> <span class="n">err</span> <span class="p">{</span>
	<span class="n">t</span><span class="o">.</span><span class="n">Helper</span><span class="p">()</span>
	<span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="variable-shadowing">
<h3>Variable shadowing<a class="headerlink" href="#variable-shadowing" title="Permalink to this headline">¶</a></h3>
<p>The use of <code class="docutils literal notranslate"><span class="pre">check</span></code> avoids repeated declaration of variables named <code class="docutils literal notranslate"><span class="pre">err</span></code>,
which was the main motivation for
allowing a mix of new and predeclared variables in <a class="reference external" href="https://golang.org/ref/spec#Short_variable_declarations">short variable declarations</a> (<code class="docutils literal notranslate"><span class="pre">:=</span></code> assignments).
Once <code class="docutils literal notranslate"><span class="pre">check</span></code> statements are available,
there would be so little valid redeclaration remaining
that we might be able to forbid shadowing
and close <a class="reference external" href="https://golang.org/issue/377">issue 377</a>.</p>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>A good error message includes relevant context,
such as the function or method name and its arguments.
Allowing handlers to chain allows adding new information as the function progresses.
For example, consider this function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">SortContents</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">,</span> <span class="n">files</span> <span class="p">[]</span><span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
    <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;process: %v&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>             <span class="o">//</span> <span class="n">handler</span> <span class="n">A</span>
    <span class="p">}</span>

    <span class="n">lines</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">strings</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">files</span> <span class="p">{</span>
        <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s2">&quot;read </span><span class="si">%s</span><span class="s2">: %v &quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>  <span class="o">//</span> <span class="n">handler</span> <span class="n">B</span>
        <span class="p">}</span>
        <span class="n">scan</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewScanner</span><span class="p">(</span><span class="n">check</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>     <span class="o">//</span> <span class="n">check</span> <span class="n">runs</span> <span class="n">B</span> <span class="n">on</span> <span class="n">error</span>
        <span class="k">for</span> <span class="n">scan</span><span class="o">.</span><span class="n">Scan</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">Text</span><span class="p">())</span>
        <span class="p">}</span>
        <span class="n">check</span> <span class="n">scan</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>                                  <span class="o">//</span> <span class="n">check</span> <span class="n">runs</span> <span class="n">B</span> <span class="n">on</span> <span class="n">error</span>
    <span class="p">}</span>
    <span class="n">sort</span><span class="o">.</span><span class="n">Strings</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">line</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">lines</span> <span class="p">{</span>
        <span class="n">check</span> <span class="n">io</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>                     <span class="o">//</span> <span class="n">check</span> <span class="n">runs</span> <span class="n">A</span> <span class="n">on</span> <span class="n">error</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The comments show which handlers are invoked for each of the
<code class="docutils literal notranslate"><span class="pre">check</span></code> expressions if these were to detect an error.
Here, only one handler is called in each case.
If handler B did not execute in a return statement,
it would transfer control to handler A.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">handle</span></code> body does not execute an explicit <code class="docutils literal notranslate"><span class="pre">return</span></code> statement,
the next earlier handler in lexical order runs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">Error</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">Func</span> <span class="n">string</span>
	<span class="n">User</span> <span class="n">string</span>
	<span class="n">Path</span> <span class="n">string</span>
	<span class="n">Err</span>  <span class="n">error</span>
<span class="p">}</span>

<span class="n">func</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span><span class="n">Error</span><span class="p">)</span> <span class="n">Error</span><span class="p">()</span> <span class="n">string</span>

<span class="n">func</span> <span class="n">ProcessFiles</span><span class="p">(</span><span class="n">user</span> <span class="n">string</span><span class="p">,</span> <span class="n">files</span> <span class="n">chan</span> <span class="n">string</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">e</span> <span class="o">:=</span> <span class="n">Error</span><span class="p">{</span> <span class="n">Func</span><span class="p">:</span> <span class="s2">&quot;ProcessFile&quot;</span><span class="p">,</span> <span class="n">User</span><span class="p">:</span> <span class="n">user</span><span class="p">}</span>
	<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="n">e</span><span class="o">.</span><span class="n">Err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">e</span> <span class="p">}</span> <span class="o">//</span> <span class="n">handler</span> <span class="n">A</span>
	<span class="n">u</span> <span class="o">:=</span> <span class="n">check</span> <span class="n">OpenUserInfo</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>         <span class="o">//</span> <span class="n">check</span> <span class="mi">1</span>
	<span class="n">defer</span> <span class="n">u</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">file</span> <span class="o">:=</span> <span class="nb">range</span> <span class="n">files</span> <span class="p">{</span>
		<span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="n">e</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">file</span> <span class="p">}</span>       <span class="o">//</span> <span class="n">handler</span> <span class="n">B</span>
		<span class="n">check</span> <span class="n">process</span><span class="p">(</span><span class="n">check</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="o">//</span> <span class="n">check</span> <span class="mi">2</span>
	<span class="p">}</span>
	<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, if check 2 catches an error,
it will execute handler B and,
since handler B does not execute a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement,
then handler A.
All handlers will be run before the <code class="docutils literal notranslate"><span class="pre">defer</span></code>.
Another key difference between <code class="docutils literal notranslate"><span class="pre">defer</span></code> and <code class="docutils literal notranslate"><span class="pre">handle</span></code>:
the second handler will be executed exactly once
only when the second <code class="docutils literal notranslate"><span class="pre">check</span></code> fails.
A <code class="docutils literal notranslate"><span class="pre">defer</span></code> in that same position would cause a new function call
to be deferred until function return for every iteration.</p>
</div>
<div class="section" id="draft-spec">
<h3>Draft spec<a class="headerlink" href="#draft-spec" title="Permalink to this headline">¶</a></h3>
<p>The syntax for a <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HandleStmt</span>  <span class="o">=</span> <span class="s2">&quot;handle&quot;</span> <span class="n">identifier</span> <span class="n">Block</span> <span class="o">.</span>
</pre></div>
</div>
<p>It declares a <em>handler</em>, which is a block of code with access to a new identifier
bound to a variable of type <code class="docutils literal notranslate"><span class="pre">error</span></code>.
A <code class="docutils literal notranslate"><span class="pre">return</span></code> statement in a handler returns from the enclosing function,
with the same semantics and restrictions as for <code class="docutils literal notranslate"><span class="pre">return</span></code> statements
in the enclosing function itself.</p>
<p>A <em>default handler</em> is defined at the top of functions
whose last return parameter is of type <code class="docutils literal notranslate"><span class="pre">error</span></code>.
It returns the current values of all leading results
(zero values for unnamed results), and the error value
as its final result.</p>
<p>A <em>handler chain call</em> for a statement and error value executes
all handlers in scope of that statement in reverse order in a new stack frame,
binding their identifier to the error value.
At least one handler must be in scope and, if the enclosing function
has result parameters, at least one of those (possibly the default handler)
must end with a terminating statement.</p>
<p>The syntax of the <code class="docutils literal notranslate"><span class="pre">check</span></code> expression is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CheckExpr</span>    <span class="o">=</span> <span class="s2">&quot;check&quot;</span> <span class="n">UnaryExpr</span> <span class="o">.</span>
</pre></div>
</div>
<p>It checks whether a plain expression or a function call’s last result,
which must be of type error, is non-nil.
If the error result is nil, the check evaluates to all but the last value.
If the error result is nil, the check calls its handler chain for that value
in a new stack frame and returns the result from the enclosing function.</p>
<p>The same rules that apply for the order of evaluation of calls in
expressions apply to the order of evaluation of multiple checks
appearing in a single expression.
The <code class="docutils literal notranslate"><span class="pre">check</span></code> expression cannot be used inside handlers.</p>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A <em>handler chain</em> is a function, defined within the context of an <em>enclosing function</em>, which:</p>
<ul>
<li><p>takes a single argument of type <code class="docutils literal notranslate"><span class="pre">error</span></code>,</p></li>
<li><p>has the same return parameters as the enclosing function, and</p></li>
<li><p>executes one or more blocks, called <em>handlers</em>.</p></li>
</ul>
</li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">handle</span></code> statement declares a handler for a handler chain and declares
an identifier that refers to the error argument of that handler chain.</p>
<ul>
<li><p>A <code class="docutils literal notranslate"><span class="pre">return</span></code> statement in a handler causes the handler chain to stop executing
and the enclosing function to return using the specified return values.</p></li>
<li><p>If the enclosing function has named result parameters,
a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement with an empty expression list causes the handler chain
to return with the current values of those arguments.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">check</span></code> expression tests whether a plain expression or a
function’s last result, which must be of type <code class="docutils literal notranslate"><span class="pre">error</span></code>, is non-nil.</p>
<ul>
<li><p>For multi-valued expressions, <code class="docutils literal notranslate"><span class="pre">check</span></code> yields all but the last value as its result.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">check</span></code> is applied to a single error value,
<code class="docutils literal notranslate"><span class="pre">check</span></code> consumes that value and doesn’t produce any result.
Consequently it cannot be used in an expression.</p></li>
<li><p>The <em>handler chain of a check</em> is defined to execute all the handlers
in scope within the enclosing function in reverse order until one of them returns.</p></li>
<li><p>For non-nil values, <code class="docutils literal notranslate"><span class="pre">check</span></code> calls the handler chain with this value,
sets the return values, if any, with the results, and returns from the enclosing function.</p></li>
<li><p>The same rules that apply for the order of evaluation of calls in expressions
apply to the order of evaluation of multiple checks appearing in a single expression.</p></li>
</ul>
</li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">check</span></code> expression cannot be used inside handlers.</p></li>
<li><p>A <em>default handler</em> is defined implicitly at the top of a function with a final result parameter
of type <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
<ul>
<li><p>For functions with unnamed results, the default handler returns zero values
for all leading results and the error value for the final result.</p></li>
<li><p>For functions with named results, the default handler returns the current
values of all leading results and the error value for the final result.</p></li>
<li><p>Because the default handler is declared at the top of a function,
it is always last in the handler chain.</p></li>
</ul>
</li>
</ul>
<p>As a corollary of these rules:</p>
<ul class="simple">
<li><p>Because the handler chain is called like a function, the location
where the <code class="docutils literal notranslate"><span class="pre">check</span></code> caught an error is preserved as the handler’s caller’s frame.</p></li>
<li><p>If the enclosing function has result parameters,
it is a compile-time error if at the point of any <code class="docutils literal notranslate"><span class="pre">check</span></code> expression
none of the handlers in scope is a
<a class="reference external" href="https://golang.org/ref/spec#Terminating_statements">terminating statement</a>.
Note that the default handler ends in a terminating statement.</p></li>
<li><p>After a <code class="docutils literal notranslate"><span class="pre">check</span></code> detects an error, one cannot resume control of an enclosing function.</p></li>
<li><p>If a handler executes, it is always before any <code class="docutils literal notranslate"><span class="pre">defer</span></code> defined within the same enclosing function.</p></li>
</ul>
</div>
<div class="section" id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<p>One drawback of the presented design is that it introduces a context-dependent control-flow jump,
like <code class="docutils literal notranslate"><span class="pre">break</span></code> and <code class="docutils literal notranslate"><span class="pre">continue</span></code>.
The semantics of <code class="docutils literal notranslate"><span class="pre">handle</span></code> are similar to but the same as <code class="docutils literal notranslate"><span class="pre">defer</span></code>, adding
another thing for developers to learn.
We believe that the reduction in verbosity, coupled with the increased ease to wrap error messages
as well as doing so idiomatically is worth this cost.</p>
<p>Another drawback is that this design might appear to add exceptions to Go.
The two biggest problems with exceptions are
that checks are not explicitly marked and that
the invoked handler is difficult to determine
and may depend on the call stack.
<code class="docutils literal notranslate"><span class="pre">Check</span></code>/<code class="docutils literal notranslate"><span class="pre">handle</span></code> has neither problem:
checks are marked and only execute lexically scoped
handlers in the enclosing function.</p>
</div>
<div class="section" id="other-considerations">
<h2>Other considerations<a class="headerlink" href="#other-considerations" title="Permalink to this headline">¶</a></h2>
<p>This section discusses aspects of the design that we have discussed in the past.</p>
<div class="section" id="keyword-try-versus-check">
<h3>Keyword: try versus check<a class="headerlink" href="#keyword-try-versus-check" title="Permalink to this headline">¶</a></h3>
<p>Swift and Rust define a <code class="docutils literal notranslate"><span class="pre">try</span></code> keyword which is similar to the <code class="docutils literal notranslate"><span class="pre">check</span></code> discussed
in this design.
Unlike <code class="docutils literal notranslate"><span class="pre">try</span></code> in Swift and Rust, check allows checking of any expression
that is assignable to error, not just calls,
making the use of <code class="docutils literal notranslate"><span class="pre">try</span></code> somewhat contrived.
We could consider <code class="docutils literal notranslate"><span class="pre">try</span></code> for the sake of consistency with other languages,
but Rust is moving away from try to the new <code class="docutils literal notranslate"><span class="pre">?</span></code> operator,
and Swift has not just <code class="docutils literal notranslate"><span class="pre">try</span></code> but also <code class="docutils literal notranslate"><span class="pre">try!</span></code>, <code class="docutils literal notranslate"><span class="pre">try?</span></code>, <code class="docutils literal notranslate"><span class="pre">catch</span></code>, and <code class="docutils literal notranslate"><span class="pre">throw</span></code>.</p>
</div>
<div class="section" id="keyword-handle-versus-catch">
<h3>Keyword: handle versus catch<a class="headerlink" href="#keyword-handle-versus-catch" title="Permalink to this headline">¶</a></h3>
<p>The keyword <code class="docutils literal notranslate"><span class="pre">handle</span></code> was chosen instead of <code class="docutils literal notranslate"><span class="pre">catch</span></code> to avoid confusion with the
exception semantics conventionally associated with <code class="docutils literal notranslate"><span class="pre">catch</span></code>.
Most notably, <code class="docutils literal notranslate"><span class="pre">catch</span></code> permits the surrounding function to continue,
while a handler cannot: the function will always exit after the handler chain completes.
All the handler chain can do is clean up and set the function results.</p>
</div>
<div class="section" id="checking-error-returns-from-deferred-calls">
<h3>Checking error returns from deferred calls<a class="headerlink" href="#checking-error-returns-from-deferred-calls" title="Permalink to this headline">¶</a></h3>
<p>The presented design does not provide a mechanism for checking errors
returned by deferred calls.
We were unable to find a way to unify them cleanly.</p>
<p>This code does not compile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">Greet</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">WriteCloser</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
	<span class="n">defer</span> <span class="n">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">check</span> <span class="n">w</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
	<span class="p">}()</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s2">&quot;hello, world</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What the code likely intends is for the <code class="docutils literal notranslate"><span class="pre">check</span></code> to cause <code class="docutils literal notranslate"><span class="pre">Greet</span></code> to return the error,
but the <code class="docutils literal notranslate"><span class="pre">check</span></code> is not in <code class="docutils literal notranslate"><span class="pre">Greet</span></code>.
Instead, the <code class="docutils literal notranslate"><span class="pre">check</span></code> appears in a function literal returning no results.
The function therefore has no default handler,
so there is no handler chain for the <code class="docutils literal notranslate"><span class="pre">check</span></code> to call,
which causes a compilation failure.</p>
<p>Even with new syntax to write a deferred checked function call,
such as <code class="docutils literal notranslate"><span class="pre">defer</span> <span class="pre">check</span> <span class="pre">w.Close()</span></code>,
there is an ordering problem: deferred calls run
after the function executes its <code class="docutils literal notranslate"><span class="pre">return</span></code> statement;
in the case of an error, the handlers have already run.
It would be surprising to run any of them a second time
as a result of a deferred <code class="docutils literal notranslate"><span class="pre">check</span></code>.</p>
</div>
<div class="section" id="a-check-else-statement">
<h3>A check-else statement<a class="headerlink" href="#a-check-else-statement" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">check</span> <span class="pre">&lt;expr&gt;</span> <span class="pre">else</span> <span class="pre">&lt;block&gt;</span></code> statement could allow a block attached to
a check to be executed if an error is detected.
This would allow, for instance, setting an HTTP error code that a handler can pick up to wrap an error.</p>
<p>Joe Duffy proposed a similar construct in his
<a class="reference external" href="http://joeduffyblog.com/2016/02/07/the-error-model/">Error Model</a> blog post.</p>
<p>However, this is generally not needed for error wrapping,
so it seems that this will not be needed much in practice.
Nesting <code class="docutils literal notranslate"><span class="pre">check</span></code> expressions with else blocks could make code unwieldy.</p>
<p>Analysis of a large code corpus shows that adding a <code class="docutils literal notranslate"><span class="pre">check</span></code>-<code class="docutils literal notranslate"><span class="pre">else</span></code>
construct usually does not help much.
Either way, the design does not preclude adding such a construct later if all else fails.</p>
<p>Note that a <code class="docutils literal notranslate"><span class="pre">check</span></code>-<code class="docutils literal notranslate"><span class="pre">else</span></code> can already be spelled out explicitly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="nb">any</span> <span class="n">custom</span> <span class="n">handling</span><span class="p">,</span> <span class="n">possibly</span> <span class="n">including</span> <span class="s2">&quot;check err&quot;</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can also write helpers like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="n">e</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span> <span class="nb">int</span><span class="p">,</span> <span class="n">msg</span> <span class="n">string</span><span class="p">)</span> <span class="o">*</span><span class="n">appError</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">nil</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">appError</span><span class="p">{</span><span class="n">err</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">code</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">check</span> <span class="n">e</span><span class="p">(</span><span class="n">doX</span><span class="p">(),</span> <span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;record not found&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>instead of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">doX</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">appError</span><span class="p">{</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;record not found&quot;</span><span class="p">,</span> <span class="mi">404</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Many wrapper functions, including <code class="docutils literal notranslate"><span class="pre">github.com/pkg/errors</span></code>’s <code class="docutils literal notranslate"><span class="pre">Wrap</span></code>,
start with a nil check.
We could rely on the compiler to optimize this particular case.</p>
</div>
</div>
<div class="section" id="considered-ideas">
<h2>Considered Ideas<a class="headerlink" href="#considered-ideas" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-a-operator-instead-of-check">
<h3>Using a ? operator instead of check<a class="headerlink" href="#using-a-operator-instead-of-check" title="Permalink to this headline">¶</a></h3>
<p>Rust is moving to a syntax of the form <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;?</span></code> instead of <code class="docutils literal notranslate"><span class="pre">try!</span> <span class="pre">&lt;expr&gt;</span></code>.
The rationale is that the <code class="docutils literal notranslate"><span class="pre">?</span></code> allows for better chaining, as in <code class="docutils literal notranslate"><span class="pre">f()?.g()?.h()</span></code>.
In Go, control flow transfers are as a general rule accompanied by keywords
(the exception being the boolean operators <code class="docutils literal notranslate"><span class="pre">||</span></code> and <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>).
We believe that deviating from this would be too inconsistent.</p>
<p>Also, although the <code class="docutils literal notranslate"><span class="pre">?</span></code> approach may read better for chaining,
it reads worse for passing the result of a <code class="docutils literal notranslate"><span class="pre">check</span></code> to a function.
Compare, for instance</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">check</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">check</span> <span class="n">newReader</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>io.Copy(w, newReader(foo)?)?
</pre></div>
</div>
<p>Finally, handlers and <code class="docutils literal notranslate"><span class="pre">check</span></code> expressions go hand-in-hand.
Handlers are more naturally defined with a keyword.
It would be somewhat inconsistent
to have the accompanying <code class="docutils literal notranslate"><span class="pre">check</span></code> construct not also use a keyword.</p>
</div>
</div>
<div class="section" id="comparisons">
<h2>Comparisons<a class="headerlink" href="#comparisons" title="Permalink to this headline">¶</a></h2>
<div class="section" id="midori">
<h3>Midori<a class="headerlink" href="#midori" title="Permalink to this headline">¶</a></h3>
<p>Joe Duffy offers many valuable insights in the use of exceptions versus error codes
in his <a class="reference external" href="http://joeduffyblog.com/2016/02/07/the-error-model/">Error Model</a> blog post.</p>
</div>
<div class="section" id="c-proposal">
<h3>C++ proposal<a class="headerlink" href="#c-proposal" title="Permalink to this headline">¶</a></h3>
<p>Herb Sutter’s <a class="reference external" href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0709r0.pdf">proposal for C++</a>
seems to come close to the what is presented here.
Although syntax varies in several places, the basic approach of propagating errors
as values with try and allowing handlers to deal with errors is similar.
The catch handlers, however, discard the error by default
unless they are rethrown in the catch block.
There is no way to continue after an error in our design.
The article offers interesting insights about the advantages of this approach.</p>
</div>
<div class="section" id="rust">
<h3>Rust<a class="headerlink" href="#rust" title="Permalink to this headline">¶</a></h3>
<p>Rust originally defined <code class="docutils literal notranslate"><span class="pre">try!</span></code> as shorthand for checking an error
and returning it from the enclosing function if found.
For more complex handling, instead of handlers, Rust uses pattern matching on unwrapped return types.</p>
</div>
<div class="section" id="swift">
<h3>Swift<a class="headerlink" href="#swift" title="Permalink to this headline">¶</a></h3>
<p>Swift defines a <code class="docutils literal notranslate"><span class="pre">try</span></code> keyword with somewhat similar semantics to the
<code class="docutils literal notranslate"><span class="pre">check</span></code> keyword introduced here.
A <code class="docutils literal notranslate"><span class="pre">try</span></code> in Swift may be accompanied by a <code class="docutils literal notranslate"><span class="pre">catch</span></code> block.
However, unlike with <code class="docutils literal notranslate"><span class="pre">check</span></code>-<code class="docutils literal notranslate"><span class="pre">handle</span></code>,
the <code class="docutils literal notranslate"><span class="pre">catch</span></code> block will prevent the function from returning
unless the block explicitly rethrows the error.
In the presented design, there is no way to stop exiting the function.</p>
<p>Swift also has a <code class="docutils literal notranslate"><span class="pre">try!</span></code>, which panics if an error is detected,
and a <code class="docutils literal notranslate"><span class="pre">try?</span></code>-<code class="docutils literal notranslate"><span class="pre">else</span></code>, which allows two blocks to be associated
that respectively will be run if the <code class="docutils literal notranslate"><span class="pre">try?</span></code> checks succeeds or fails.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="go2draft-error-handling-overview.html" class="btn btn-neutral float-right" title="Error Handling — Problem Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="go2draft-contracts.html" class="btn btn-neutral float-left" title="Contracts — Draft Design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>